<!DOCTYPE html>
<html lang="dv" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Royal Graduation (V33.0 - Platinum Edition - Navigation & Flex)</title>
    <style>
        /* 1. Google Font (Backup for Dhivehi) */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');

        /* 2. Faruuma Font (Local) */
        @font-face {
            font-family: 'Faruuma';
            src: local('Faruuma'), local('Faruumaa'), url('Fonts/faruuma.ttf') format('truetype');
        }

        /* --- GLOBAL VARIABLES --- */
        :root {
            --royal-accent: #c5a059;        
            --royal-blue-dark: #001b3d;     
            --royal-blue-mid: #0d47a1;      
            --royal-green: #003322;           
            --input-bg: #e3f2fd;               
            --input-border: #90caf9;
            --panel-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
        }

        /* DEFAULT BODY STYLE */
        body {
            -webkit-user-select: none; user-select: none;
            margin: 0; padding: 0;
            background: linear-gradient(135deg, #000c1a 0%, #00281c 100%);
            overflow: hidden; height: 100vh; width: 100vw;
            color: #333;
            font-family: 'Faruuma', 'MV Boli', 'Noto Sans Thaana', serif;
        }

        /* --- LANGUAGE SWITCHER TABS --- */
        .lang-tabs { 
            display: flex; gap: 5px; margin-bottom: 10px; justify-content: center; 
            direction: ltr !important; flex-shrink: 0; 
        }
        .lang-btn {
            flex: 1; padding: 8px; text-align: center; text-decoration: none;
            background: #37474f; color: #fff; border-radius: 4px; 
            font-size: 13px; font-weight: bold; border: 1px solid #555; transition: 0.3s;
            font-family: sans-serif !important;
        }
        .lang-btn:hover { background: var(--royal-accent); color: #000; }
        .lang-btn.active { background: var(--royal-blue-mid); border: 1px solid #fff; pointer-events: none; }


        /* --- SECURITY OVERLAY --- */
        #securityOverlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.98); z-index: 99999;
            display: flex; justify-content: center; align-items: center;
            direction: ltr !important; font-family: 'Segoe UI', sans-serif !important; text-align: center;
        }
        #securityOverlay * { font-family: 'Segoe UI', sans-serif !important; direction: ltr !important; }

        .sec-box { 
            background: linear-gradient(135deg, var(--royal-blue-dark), var(--royal-green)); 
            padding: 60px; border-radius: 20px; border: 2px solid var(--royal-accent); 
            box-shadow: 0 0 50px rgba(13, 71, 161, 0.5); max-width: 600px; width: 90%;
        }
        .sec-input { 
            padding: 15px; font-size: 24px; text-align: center; width: 100%; margin-top: 20px; 
            background: #fff; color: #000; border-radius:5px; border:none; 
        }
        .sec-btn { 
            margin-top: 25px; padding: 15px 50px; font-size: 20px; background: var(--royal-blue-mid); 
            color: #fff; border: 1px solid #fff; cursor: pointer; font-weight: bold; 
            border-radius:8px; text-transform: uppercase;
        }
        .sec-btn:hover { background: #fff; color: var(--royal-blue-mid); }

        /* --- REST OF APP --- */
        .sidebar, .editor, button:not(.sec-btn, .lang-btn), input:not(.sec-input), select, textarea, h1, h2, h3, label, span, div:not(.lang-tabs) {
             font-family: 'Faruuma', 'MV Boli', 'Noto Sans Thaana', serif;
        }

        /* --- TOP BANNER --- */
        .royal-banner {
            background: linear-gradient(to right, var(--royal-blue-dark), var(--royal-green));
            color: #fff; text-align: center; padding: 15px;
            border-bottom: 3px solid var(--royal-accent);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); margin-bottom: 10px; border-radius: 8px; flex-shrink: 0;
        }
        .banner-main { font-family: 'Times New Roman', serif !important; font-weight: bold; font-size: 14px; letter-spacing: 2px; color: #a0c4ff; display: block; }
        .banner-sub { font-size: 24px; color: var(--royal-accent); text-shadow: 0 2px 4px #000; display: block; margin-top: 5px; }

        /* --- UI LAYOUT --- */
        .main-layout { 
            display: none; gap: 20px; height: 100vh; width: 100vw; 
            padding: 15px; box-sizing: border-box; 
        }

        .sidebar {
            flex: 0 0 380px; background: #f8fbff; padding: 15px; border-radius: 12px;
            display: flex; flex-direction: column; height: 100%; overflow-y: auto; 
            box-shadow: var(--panel-shadow); border: 3px solid var(--royal-blue-dark);
        }
        .sidebar h2 { color: var(--royal-blue-dark); text-align:center; margin-bottom: 10px; border-bottom: 2px solid var(--royal-blue-mid); padding-bottom: 5px; font-size: 22px; }
        
        .dev-credits {
            margin-top: 20px; text-align: center; font-size: 13px; color: #555;
            background: #e3f2fd; padding: 10px; border-radius: 6px; border: 1px solid #bbdefb;
            font-weight: bold; line-height: 1.4; flex-shrink: 0;
        }
        .dev-name { color: var(--royal-blue-dark); font-size: 14px; display: block; margin-bottom: 2px; }
        .company-name { color: var(--royal-green); font-size: 12px; display: block; letter-spacing: 0.5px; }

        .editor {
            flex: 1; background: #fff; padding: 25px; border-radius: 12px;
            display: flex; flex-direction: column; height: 100%; overflow-y: auto; 
            position: relative; box-shadow: var(--panel-shadow); border: 3px solid var(--royal-green);
        }

        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #eee; }
        ::-webkit-scrollbar-thumb { background: var(--royal-blue-mid); border-radius: 6px; }

        /* --- CONTROLS --- */
        h2, h3 { margin: 5px 0; }
        label { display: block; font-weight: bold; font-size: 16px; margin-bottom: 5px; color: var(--royal-blue-dark); }
        
        .d-label { 
            font-size: 18px; font-weight: 900; color: var(--royal-blue-mid);
            display: block; margin-top: 15px; margin-bottom: 8px; 
            border-bottom: 2px solid #b3e5fc; padding-bottom: 4px; 
        }

        input[type="text"], textarea, select { 
            width: 100%; padding: 10px; border: 1px solid var(--input-border); 
            border-radius: 6px; background: var(--input-bg); color: #000;
            margin-bottom: 8px; font-size: 16px; box-sizing: border-box; transition: all 0.3s;
        }
        input[type="text"]:focus, select:focus, textarea:focus { 
            border-color: var(--royal-blue-mid); background: #fff; outline: none; 
            box-shadow: 0 0 8px rgba(13, 71, 161, 0.3); 
        }

        #jLine1 {
            font-size: 28px !important; font-weight: 900 !important; text-align: center !important;
            color: var(--royal-blue-dark); border: 2px solid var(--royal-accent);
            background: #fff8e1; height: 60px;
        }
        .sub-title-input {
            font-size: 18px !important; font-weight: bold !important; text-align: center !important;
            color: var(--royal-blue-mid); height: 40px;
        }

        .font-dv { font-size: 20px !important; direction: rtl; text-align: right; }
        .eng { font-size: 18px !important; direction: ltr; text-align: left; font-family: 'Times New Roman', serif !important; font-weight: bold; }

        input[type=range] { width: 100%; cursor: pointer; height: 15px; accent-color: var(--royal-blue-mid); margin: 5px 0; }
        input[type=color] { width: 45px; height: 35px; border: 2px solid #fff; border-radius: 6px; cursor: pointer; vertical-align: middle; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .group-box {
            border: 1px solid #bbdefb; border-radius: 10px; padding: 30px 20px 20px 20px;
            margin-bottom: 35px; background: #f1f8e9; position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .group-title {
            position: absolute; top: -20px; right: 20px; background: var(--royal-blue-dark);
            color: #fff; padding: 8px 25px; font-size: 18px; font-weight: bold;
            border-radius: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 10;
        }

        .design-col { flex: 1; }

        /* --- BUTTONS --- */
        button { cursor: pointer; font-weight: bold; transition: all 0.2s; }
        
        .launch-btn { 
            background: linear-gradient(to bottom, #d32f2f, #b71c1c);
            color: white; padding: 12px; width: 100%; border: 1px solid #ffcdd2; 
            border-radius: 6px; margin-bottom: 10px; font-size: 18px; box-shadow: 0 3px 5px rgba(0,0,0,0.2); 
        }
        .launch-btn:hover { filter: brightness(1.1); }

        .conf-btn { flex: 1; padding: 8px; font-size: 14px; border-radius: 4px; border: 1px solid #1565c0; color: #fff; background: var(--royal-blue-mid); }
        .conf-btn:hover { background: var(--royal-blue-dark); }
        .config-btn-row { display: flex; gap: 5px; margin-bottom: 10px; }

        .btn-live { 
            background: linear-gradient(to bottom, #2e7d32, #1b5e20);
            flex: 2; border: 2px solid #a5d6a7; color: #fff; font-size: 20px; padding: 12px; border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .btn-live:hover { filter: brightness(1.1); }
        
        .btn-nav { background: #546e7a; color: white; padding: 12px; font-size: 20px; border: none; border-radius: 8px; width: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        #lockBtn {
            background: #fbc02d; color: #000; padding: 12px; width: 100%; border: 2px solid #fff;
            border-radius: 8px; margin-bottom: 15px; font-size: 18px; box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        #lockBtn.active { background: #c62828; color: white; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(198, 40, 40, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(198, 40, 40, 0); } 100% { box-shadow: 0 0 0 0 rgba(198, 40, 40, 0); } }

        .locked-zone { opacity: 0.5; pointer-events: none; filter: grayscale(80%); user-select: none; transition: all 0.3s ease; }

        /* --- PREVIEW --- */
        .preview-container { 
            display: flex; gap: 15px; align-items: center; justify-content: center; 
            background: #fff; padding: 15px; border: 2px solid #b2dfdb; 
            border-radius: 10px; margin-top: 15px; 
        }
        #previewImg { height: 90px; width: 90px; object-fit: cover; border-radius: 50%; border: 3px solid var(--royal-blue-mid); background: #eee; }
        
        .video-panel { background: #e1f5fe; padding: 15px; border-radius: 10px; border: 1px solid #81d4fa; margin-bottom: 20px; }
        .btn-vid { font-size: 14px; padding: 8px; margin-top: 5px; border:none; border-radius:4px; color:white; width: 100%; cursor: pointer; font-weight:bold; }

        /* --- SYSTEM FILES --- */
        #sidebarFiles {
            background: #fff; border: 1px solid #90caf9; border-radius: 8px; padding: 10px;
            direction: rtl !important; text-align: right !important;
        }
        #sidebarFiles label { font-size: 14px; color: #444; margin-bottom: 3px; }
        #sidebarFiles input[type="file"] { font-size: 12px; padding: 5px; direction: ltr; }
        
        .list-switch-btn {
            background: #eee; border: 1px solid #ccc; padding: 5px; cursor: pointer; flex: 1; font-size: 12px; font-weight: bold;
        }
        .list-switch-btn.active {
            background: var(--royal-blue-mid); color: white; border-color: var(--royal-blue-dark);
        }

        /* --- FULL SCREEN BUTTON --- */
        #cpFsBtn {
            position: fixed; bottom: 20px; left: 20px; width: 45px; height: 45px;
            background: var(--royal-blue-dark); color: #fff; border-radius: 50%;
            border: 2px solid #fff; box-shadow: 0 0 15px rgba(0,0,0,0.5);
            z-index: 1000; font-size: 20px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.3s;
        }
        #cpFsBtn:hover { transform: scale(1.1); background: var(--royal-green); }

    </style>
</head>
<body oncontextmenu="return false;">

    <button id="cpFsBtn" onclick="toggleControlFS()" title="ﬁäﬁ™ﬁçﬁ∞ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞">‚õ∂</button>

    <div id="securityOverlay">
        <div class="sec-box">
            <h1 style="color:#fff; font-size:45px; margin-bottom:10px; text-shadow:0 2px 5px #000;">Royal Graduation V33.0</h1>
            <p style="color:#a0c4ff; font-size:18px; margin-bottom:30px;">üîí PLATINUM EDITION - NAVIGATION & FLEX</p>
            <input type="password" id="licenseKey" class="sec-input" placeholder="Enter Key...">
            <button class="sec-btn" onclick="verifyLicense()">AUTHENTICATE</button>
            <p id="secMsg" style="color:#ff5252; font-size:16px; margin-top:20px; font-weight:bold;"></p>
        </div>
    </div>
<div style="margin-top:10px;">
                            <button class="btn-vid" style="background:#2e7d32;" onclick="forceShowTitles()">üîÑ Force Refresh Titles</button>
                        </div>
    <div class="main-layout" id="mainApp">
        <div class="sidebar">
            <div class="lang-tabs">
                <a href="#" class="lang-btn active">ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®</a>
                <a href="#" class="lang-btn">English</a>
                <a href="#" class="lang-btn">ÿπÿ±ÿ®Ÿä</a>
            </div>

            <div class="royal-banner">
                <span class="banner-main">EVENT AND GRADUATION CEREMONY SOFTWARE</span>
                <span class="banner-sub">ﬁÉﬁØﬁîﬁ¶ﬁçﬁ∞ ﬁéﬁ™ﬁÉﬁ¨ﬁñﬁ™ﬁáﬁ≠ﬁùﬁ¶ﬁÇﬁ∞ ﬁêﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞</span>
            </div>

            <div id="licenseStatus" style="font-size:13px; color:#0d47a1; text-align:center; margin-bottom:10px; font-weight:bold;"></div>

            <button class="launch-btn" onclick="openTV()">üñ•Ô∏è 1. ﬁìﬁ©ﬁàﬁ© ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁÄﬁ™ﬁÖﬁ™ﬁáﬁ∞ﬁàﬁß</button>
            <div id="connStatus" style="font-size:14px; color:red; text-align:center; background:#ffebee; padding:4px; border-radius:4px; margin-bottom:10px; border:1px solid #ffcdd2;">ﬁÜﬁ¶ﬁÇﬁ¨ﬁÜﬁ∞ﬁìﬁ∞ ﬁÇﬁ™ﬁàﬁ≠</div>

            <div id="configPanel" class="config-btn-row">
                <button class="conf-btn" onclick="downloadConfig()">‚¨á ﬁêﬁ≠ﬁàﬁ∞ ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁ∞ﬁêﬁ∞</button>
                <button class="conf-btn" onclick="document.getElementById('confInput').click()">‚¨Ü ﬁçﬁØﬁëﬁ∞ ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁ∞ﬁêﬁ∞</button>
                <input type="file" id="confInput" accept=".json" style="display:none" onchange="loadConfig(this)">
            </div>

            <div id="sidebarFiles">
                <label style="color:#0d47a1; border-bottom:1px solid #e3f2fd; padding-bottom:5px; margin-bottom:8px; font-size:16px; font-weight:bold;">üìÇ ﬁêﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ ﬁäﬁ¶ﬁáﬁ®ﬁçﬁ∞ﬁåﬁ¶ﬁáﬁ∞</label>
                <label>1. ﬁÜﬁ™ﬁãﬁ®ﬁÇﬁ∞ﬁéﬁ¨ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™ (CSV):</label><input type="file" id="csvFile" accept=".csv">
                <label>2. ﬁäﬁÆﬁìﬁØ ﬁäﬁØﬁçﬁ∞ﬁëﬁ¶ﬁÉ:</label><input type="file" id="photoFolder" webkitdirectory directory multiple>
                <label style="color:#2e7d32;">3. ﬁâﬁ¨ﬁáﬁ®ﬁÇﬁ∞ ﬁçﬁØﬁéﬁØﬁåﬁ¶ﬁáﬁ∞ (Max 5):</label><input type="file" id="mainLogosInput" accept="image/*" multiple onchange="loadMainLogos(this)">
                <label>4. ﬁÜﬁ¶ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ ﬁäﬁÆﬁÇﬁ∞ﬁìﬁ∞ (TTF):</label><input type="file" id="fontFile" accept=".ttf, .otf">
                <label>5. ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁßﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (CSV):</label><input type="file" id="jalsaCsvFile" accept=".csv">
                <label style="color:#d84315;">6. ﬁÜﬁ¶ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ ﬁäﬁ∞ﬁÉﬁ≠ﬁâﬁ∞:</label><input type="file" id="customBorderFile" accept="image/*">
                
                <hr>
                <label style="color:#2e7d32;">7. ﬁïﬁßﬁìﬁ∞ﬁÇﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁçﬁØﬁéﬁØﬁåﬁ¶ﬁáﬁ∞:</label>
                <input type="file" id="partnerLogos" accept="image/*" multiple onchange="loadPartnerLogos(this)">
                
                <label style="color:#c62828;">8. ﬁáﬁ®ﬁùﬁ∞ﬁåﬁ®ﬁÄﬁßﬁÉﬁ™ / ﬁÑﬁ¨ﬁÇﬁß (Photo/Video):</label>
                <input type="file" id="adFolder" accept="image/*, video/*" multiple onchange="loadAds(this)">
                
                <label style="color:#6a1b9a;">9. ﬁÜﬁ¶ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ ﬁÜﬁßﬁëﬁ™ ﬁÑﬁ¨ﬁÜﬁ∞ﬁéﬁ∞ﬁÉﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁëﬁ∞:</label>
                <input type="file" id="customCardBgFile" accept="image/*" onchange="loadCustomCardBg(this)">
                
                <label style="color:#d32f2f;">10. ﬁïﬁ©ﬁëﬁ©ﬁáﬁ¨ﬁäﬁ∞ (PDF) ﬁïﬁ∞ﬁÉﬁ¨ﬁíﬁ¨ﬁÇﬁ∞ﬁìﬁ≠ﬁùﬁ¶ﬁÇﬁ∞:</label>
                <input type="file" id="pdfFile" accept="application/pdf" onchange="loadPDF(this)">
                
                <hr style="border: 2px dashed #ffb300;">
                <label style="color:#ff6f00; font-weight:900;">11. TOP 5 LIST (CSV):</label>
                <input type="file" id="top5CsvFile" accept=".csv" onchange="loadTop5Csv(this)">
                
                <label style="color:#ff6f00; font-weight:900;">12. TOP 5 PHOTOS:</label>
                <input type="file" id="top5PhotoFolder" webkitdirectory directory multiple onchange="loadTop5Photos(this)">
                
                <label style="color:#ff6f00; font-weight:900;">13. TOP 5 VIDEOS:</label>
                <input type="file" id="top5VideoFiles" accept="video/*" multiple onchange="loadTop5Videos(this)">
                
                <hr style="border: 2px dashed #ffb300;">
                <label style="color:#ffd700; font-weight:900;">14. ROYAL STAR ICON (PNG):</label>
                <input type="file" id="royalStarFile" accept="image/*" onchange="loadRoyalStar(this)">
                
                <label style="color:#ffd700; font-weight:900;">15. TROPHY ICON (PNG):</label>
                <input type="file" id="trophyFile" accept="image/*" onchange="loadTrophy(this)">
            </div>

            <label style="margin-top:15px; color:#00281c;">üîç ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ ﬁÄﬁØﬁáﬁ∞ﬁãﬁ¶ﬁàﬁß:</label>
            <div style="display:flex; gap:0; margin-bottom:5px;">
                <button class="list-switch-btn active" id="btnGenList" onclick="switchListMode('general')">üë• ﬁ¢ﬁßﬁÇﬁ∞ﬁâﬁ™ ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™</button>
                <button class="list-switch-btn" id="btnTop5List" onclick="switchListMode('top5')">üèÜ Top 5 ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™</button>
            </div>
            <input type="text" id="search" placeholder="ﬁÇﬁ¶ﬁÇﬁ∞ ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁ¶ﬁàﬁß..." onkeyup="filterList()">
            
            <select id="stuList" size="10" style="flex-grow:1; border:1px solid #ccc; min-height: 200px;" onchange="loadStudent()"></select>
            
            <div class="dev-credits">
                <span style="display:block; margin-bottom:3px;">ﬁïﬁ∞ﬁÉﬁÆﬁéﬁ∞ﬁÉﬁßﬁâﬁ∞ ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁáﬁ™ﬁäﬁ¨ﬁáﬁ∞ﬁãﬁ©:</span>
                <span class="dev-name">ﬁëﬁ®ﬁàﬁ¨ﬁçﬁÆﬁïﬁ¶ﬁÉ ﬁ¢ﬁ¶ﬁçﬁ© ﬁáﬁ®ﬁÑﬁ∞ﬁÉﬁßﬁÄﬁ©ﬁâﬁ∞ ﬁãﬁ©ﬁãﬁ© (7791550)</span>
                <span class="company-name">ZAAD RESEARCH AND PUBLISHING CONSULTANCY FIRM</span>
            </div>
        </div>

        <div class="editor" id="editorPanel">
            <div id="infoPanel" style="background:#fff; padding:20px; border-radius:10px; border:2px solid #90caf9; margin:15px 0; box-shadow:0 3px 10px rgba(0,0,0,0.05);">
                <label style="color:#d32f2f;">üöÄ SCENE SWITCHER (ﬁéﬁ¶ﬁëﬁ® ﬁÇﬁ™ﬁñﬁ¨ﬁÄﬁ® ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß):</label>
                <div id="listPanel" style="display:flex; gap:0; margin-bottom:5px;">
                    <button class="btn-live" style="background:#455a64; border-color:#37474f;" onclick="showJalsaScreen()">üè† TITLE SCREEN</button>
                    <button class="btn-live" style="background:#0d47a1; border-color:#002171;" onclick="forceStudentCard()">üéì STUDENT</button>
                    <button class="btn-live" style="background:#ff6f00; border-color:#c43e00;" onclick="forceTop5()">üèÜ TOP 5</button>
                </div>
            </div>
<div style="background:#ede7f6; padding:10px; border-radius:8px; border:1px solid #b39ddb; margin-bottom:15px;">
               <div style="background:#ede7f6; padding:10px; border-radius:8px; border:1px solid #b39ddb; margin-bottom:15px;">
   <div style="background:#ede7f6; padding:10px; border-radius:8px; border:1px solid #b39ddb; margin-bottom:15px;">
    <label style="color:#512da8; font-size:14px; margin-bottom:5px;">üñ•Ô∏è 3-Screen Controls & Calibration:</label>

    <div style="display:flex; gap:5px; margin-bottom:5px;">
        <div style="flex:1;">
            <span style="font-size:10px; font-weight:bold;">Left Image:</span>
            <input type="file" accept="image/*" onchange="loadScreenBG('left', this)" style="font-size:11px;">
        </div>
        <div style="flex:1;">
            <span style="font-size:10px; font-weight:bold;">Right Image:</span>
            <input type="file" accept="image/*" onchange="loadScreenBG('right', this)" style="font-size:11px;">
        </div>
    </div>

    <button class="btn-vid" style="background:#673ab7; font-weight:bold; margin-bottom:10px;" onclick="toggleTripleMode()">
        Toggle 3-Screen Mode (On/Off)
    </button>

    <div style="border-top: 1px dashed #9575cd; padding-top: 5px;">
        <label style="font-size:11px; color:#512da8; font-weight:bold;">üî≠ Monitor Zoom (View Only):</label>
        <input type="range" min="0.2" max="1" step="0.05" value="1" oninput="setTVZoom(this.value)" style="height:10px;">
    </div>

    <div style="background:#fff; padding:5px; border-radius:5px; margin-top:5px; border:1px solid #d1c4e9;">
        <label style="font-size:11px; font-weight:bold; color:#311b92;">üõ†Ô∏è Screen Calibration (Position):</label>
        
        <div style="display:flex; gap:5px; align-items:center; margin-top:3px;">
            <span style="font-size:10px; width:30px;">Left:</span>
            <input type="range" min="10" max="30" step="0.1" value="16.6" title="Width" oninput="adjustZone('left', 'width', this.value)">
            <input type="range" min="-100" max="100" step="1" value="0" title="Move X" oninput="adjustZone('left', 'left', this.value)">
        </div>

        <div style="display:flex; gap:5px; align-items:center; margin-top:3px;">
            <span style="font-size:10px; width:30px;">Right:</span>
            <input type="range" min="10" max="30" step="0.1" value="16.6" title="Width" oninput="adjustZone('right', 'width', this.value)">
            <input type="range" min="-100" max="100" step="1" value="0" title="Move X" oninput="adjustZone('right', 'right', this.value)">
        </div>
    </div>
</div>

    <button class="btn-vid" style="background:#673ab7; font-weight:bold; margin-bottom:10px;" onclick="toggleTripleMode()">
        Toggle 3-Screen Mode (On/Off)
    </button>

    <div style="border-top: 1px dashed #9575cd; padding-top: 5px; margin-top: 5px;">
        <label style="font-size:12px; color:#512da8; font-weight:bold;">üî≠ Monitor View Zoom (Fit to TV):</label>
        <div style="display:flex; align-items:center; gap:5px;">
            <span style="font-size:10px;">Out</span>
            <input type="range" min="0.2" max="1" step="0.05" value="1" oninput="setTVZoom(this.value)">
            <span style="font-size:10px;">In</span>
        </div>
        <div style="font-size:10px; color:#666; text-align:center;">(ﬁâﬁ®ﬁáﬁ®ﬁÇﬁ∞ ﬁáﬁ¶ﬁêﬁ∞ﬁçﬁ™ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ¶ﬁÅﬁ∞ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ¨ﬁáﬁ∞ ﬁÇﬁßﬁÇﬁ∞ﬁÇﬁßﬁÇﬁ¨)</div>
    </div>
</div>
            <button id="lockBtn" onclick="toggleLock()">üîì ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁ®ﬁäﬁ¶ﬁáﬁ® (ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ≠ ﬁâﬁØﬁëﬁ™)</button>

            <div class="controls">
                <button class="action btn-nav" onclick="move(-1)">‚óÄ</button>
                <button class="action btn-live" onclick="updateTV()">üì∫ ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞ ﬁÜﬁ™ﬁÉﬁ≠</button>
                <button class="action btn-nav" onclick="move(1)">‚ñ∂</button>
                <button class="action btn-nav" style="background:#c62828; font-size:16px;" onclick="clearTV()">X</button>
                <button class="action btn-nav" style="background:#f9a825; font-size:16px;" onclick="toggleAdsMode()" title="ﬁáﬁ®ﬁùﬁ∞ﬁåﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁâﬁØﬁëﬁ™">üì¢</button>
            </div>

            <div class="video-panel">
                <div style="font-weight:bold; color:#0277bd; margin-bottom:5px;">üéûÔ∏è ﬁàﬁ©ﬁëﬁ®ﬁáﬁØ ﬁïﬁ∞ﬁçﬁ≠ﬁîﬁ¶ﬁÉ & ﬁïﬁ∞ﬁÉﬁ¨ﬁíﬁ¨ﬁÇﬁ∞ﬁìﬁ≠ﬁùﬁ¶ﬁÇﬁ∞</div>
                
                <div style="display:flex; gap:8px;">
                    <label style="width:70%; font-size:12px; color:#555;">General Video Playlist:</label>
                    <input type="file" id="videoPlaylist" accept="video/*" multiple style="width:70%">
                    <button class="btn-vid" style="background:#e65100; width:15%; margin-right:2px;" onclick="playPrevVideo()">‚óÄ Back</button>
<button class="btn-vid" style="background:#ef6c00; width:15%;" onclick="playNextVideo()">Next ‚ñ∂</button>
                </div>
                
                <div style="display:flex; gap:10px; margin-top:5px; flex-wrap:wrap; background:#fff; padding:5px; border-radius:5px;">
    
    <label style="font-size:12px; display:inline-flex; align-items:center;">
        <input type="checkbox" id="vidOverlayCheck" onchange="toggleOverlayMode(this.checked)"> ﬁàﬁ©ﬁëﬁ®ﬁáﬁØ ﬁâﬁ¶ﬁåﬁ© ﬁÜﬁßﬁëﬁ™ (Overlay)
    </label>

    <label style="font-size:12px; display:inline-flex; align-items:center; color:#c62828;">
        <input type="checkbox" id="top5ModeCheck"> <b>Top 5 Banner Mode (Royal)</b>
    </label>

    <label style="font-size:12px; display:inline-flex; align-items:center; color:#e65100;">
        <input type="checkbox" id="hideTrophyCheck" onchange="toggleTrophyVisibility(this.checked)"> <b>üö´ ﬁìﬁ∞ﬁÉﬁÆﬁäﬁ© ﬁäﬁÆﬁÉﬁ™ﬁàﬁß</b>
    </label>

    <button class="btn-vid" style="background:#37474f; width:auto;" onclick="stopVideo()">‚èπ Stop</button>
</div>

                <hr style="border:1px dashed #ccc;">
                
                <div style="font-weight:bold; font-size:14px; margin-bottom:5px;">WEB & PRESENTATION:</div>
                <div style="display:flex; gap:8px; margin-top:5px;">
                    <input type="text" id="presLink" placeholder="Canva/Gamma Link (Auto-Fix)..." style="width:60%; text-align:left;" class="font-en">
                      <select id="presType" style="width:20%; font-size:12px;">
                          <option value="auto">Auto-Detect</option>
                          <option value="gamma">Gamma.app</option>
                          <option value="canva">Canva</option>
                          <option value="google">Google Slides</option>
                      </select>
                    <button class="btn-vid" style="background:#6a1b9a; width:20%;" onclick="showPresentation()">Open</button>
                </div>
                <div style="margin-top:5px;">
                      <button class="btn-vid" style="background:#d32f2f;" onclick="showPDFScreen()">üìÑ Show PDF</button>
                </div>
                
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <input type="text" id="ytLink" placeholder="ﬁîﬁ´ﬁìﬁ®ﬁáﬁ™ﬁÑﬁ∞ ﬁçﬁ®ﬁÇﬁ∞ﬁÜﬁ∞ (Any Format)..." style="width:50%; text-align:left;" class="font-en">
                    <button class="btn-vid" style="background:#c62828; width:30%;" onclick="playYoutube()">‚ñ∂ ﬁîﬁ´ﬁìﬁ®ﬁáﬁ™ﬁÑﬁ∞</button>
                    <button class="btn-vid" style="background:#0277bd; width:20%;" onclick="openYTPopup()">‚ö†Ô∏è ﬁïﬁÆﬁïﬁ∞ﬁáﬁ¶ﬁïﬁ∞</button>
                </div>
            </div>

            <div id="statusMsg" style="font-weight:bold; color:#00695c; text-align:center; font-size:18px; margin:5px 0;">ﬁêﬁ®ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ ﬁÉﬁ¨ﬁëﬁ©</div>

            <div style="background:#fff; padding:20px; border-radius:10px; border:2px solid #90caf9; margin:15px 0; box-shadow:0 3px 10px rgba(0,0,0,0.05);">
                <h3 style="margin-top:0; font-size:22px; color:#0d47a1; border-bottom:1px solid #e3f2fd; padding-bottom:5px;">üéì ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™</h3>
                
                <div style="margin-bottom: 10px;">
                    <label style="font-size:14px; color:#555;">ﬁÇﬁ¶ﬁÇﬁ∞ (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®):</label>
                    <input id="nD" class="font-dv" placeholder="ﬁÇﬁ¶ﬁÇﬁ∞ (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®)" style="width:100%;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="font-size:14px; color:#555; text-align:right; display:block;">ﬁÇﬁ¶ﬁÇﬁ∞ (ﬁáﬁ®ﬁÇﬁéﬁ®ﬁÉﬁ≠ﬁêﬁ®):</label>
                    <input id="nE" class="eng" placeholder="Name (English)" style="width:100%; text-align:left;">
                </div>
                
                <div class="row" style="display:flex; gap:10px; width:100%;">
                    <div class="col" style="flex:1;">
                        <input id="fD" class="font-dv" placeholder="ﬁåﬁ¶ﬁäﬁ∞ﬁêﬁ©ﬁçﬁ™ 1 (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®)" style="width:100%; text-align:right;">
                    </div>
                    <div class="col" style="flex:1;">
                        <input id="fE" class="eng" placeholder="Detail 1 (English)" style="width:100%; direction:ltr; text-align:left;">
                    </div>
                </div>

                <div class="row" style="display:flex; gap:10px; width:100%; margin-top:5px;">
                    <div class="col" style="flex:1;">
                        <input id="cD" class="font-dv" placeholder="ﬁåﬁ¶ﬁäﬁ∞ﬁêﬁ©ﬁçﬁ™ 2 (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®)" style="width:100%; text-align:right;">
                    </div>
                    <div class="col" style="flex:1;">
                        <input id="cE" class="eng" placeholder="Detail 2 (English)" style="width:100%; direction:ltr; text-align:left;">
                    </div>
                </div>
                
                <div class="row" style="margin-top:5px;">
                    <label style="font-size:14px; color:#d84315;">üèÜ Rank/Position (Optional):</label>
                    <input id="rankInput" placeholder="1, 2, 3..." style="width:100%;">
                </div>
                
                <textarea id="cm" rows="2" class="font-dv" placeholder="ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ ﬁâﬁ¶ﬁ¢ﬁ™ﬁçﬁ´ﬁâﬁßﬁåﬁ™..."></textarea>

                <div class="preview-container">
                    <div><img id="logoPreview" alt="Logo" style="height:50px; opacity:0.5;"></div>
                    <div style="text-align:center;">
                        <span id="pStat" style="font-size:14px; font-weight:bold; color:#777;">ﬁäﬁÆﬁìﬁØﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞</span><br>
                        <img id="previewImg" src="https://via.placeholder.com/150">
                        <br><button style="font-size:12px; padding:3px 8px; margin-top:5px; background:#607d8b; color:#fff; border:none; border-radius:4px;" onclick="document.getElementById('singlePhoto').click()">ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ≠</button>
                        <input type="file" id="singlePhoto" accept="image/*" style="display:none" onchange="manualPhoto(this)">
                    </div>
                </div>
            </div>

            <div style="text-align:center; font-size:15px; color:#777; margin:20px 0; font-weight:bold; letter-spacing:1px; background:#eceff1; padding:5px; border-radius:20px;">‚¨á ﬁêﬁ¨ﬁìﬁ®ﬁÇﬁ∞ﬁéﬁ∞ﬁêﬁ∞ ﬁáﬁ¶ﬁãﬁ® ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞ ‚¨á</div>

            <div id="designPanel"> 
                <div class="group-box" style="border-color:#ffca28; background:#fffde7;">
                    <span class="group-title" style="background:#ff6f00;">üèÜ Top 5 Mode & Video</span>
                    <div class="design-col">
                        <p style="font-size:12px; color:#555; margin-bottom:10px;">Select Layout to move Card (Left/Right/Bottom). Use Video Sliders to move video box anywhere!</p>
                        
                        <div style="margin-bottom:15px;">
                             <span style="font-weight:bold; font-size:14px;">1. Banner Layout Position:</span>
                             <select id="t5LayoutSel" onchange="liveUpdate('t5Layout', this.value)" style="width:100%; font-weight:bold; color:#d84315;">
                                 <option value="bottom">Bottom Banner (Default)</option>
                                 <option value="left">Left Sidebar (ﬁàﬁßﬁåﬁ∞)</option>
                                 <option value="right">Right Sidebar (ﬁÜﬁ¶ﬁÇﬁßﬁåﬁ∞)</option>
                             </select>
                        </div>
                        
                        <div style="background:#fff; padding:10px; border-radius:5px; border:1px solid #ffcc80; margin-bottom:15px;">
                             <span style="font-weight:bold; font-size:14px; display:block; margin-bottom:5px;">2. Video Box Control (Move Anywhere):</span>
                             <div style="display:flex; gap:5px;">
                                 <span style="font-size:12px;">X:</span><input type="range" min="0" max="100" value="10" oninput="liveUpdate('tvX', this.value)">
                                 <span style="font-size:12px;">Y:</span><input type="range" min="0" max="100" value="5" oninput="liveUpdate('tvY', this.value)">
                             </div>
                             <div style="display:flex; gap:5px; margin-top:5px;">
                                 <span style="font-size:12px;">Width:</span><input type="range" min="10" max="100" value="80" oninput="liveUpdate('tvW', this.value)">
                                 <span style="font-size:12px;">Height:</span><input type="range" min="10" max="100" value="65" oninput="liveUpdate('tvH', this.value)">
                             </div>
                        </div>

                        <span style="font-weight:bold; font-size:14px;">3. Card Sizing:</span>
                        <div style="display:flex; gap:10px; align-items:center; margin-bottom:5px;">
                            <span style="font-size:14px; width:100px;">Banner Width:</span>
                            <input type="range" min="20" max="100" value="95" oninput="liveUpdate('t5CardW', this.value)">
                        </div>
                        <div style="display:flex; gap:10px; align-items:center; margin-bottom:5px;">
                            <span style="font-size:14px; width:100px;">Banner Height:</span>
                            <input type="range" min="10" max="100" value="22" oninput="liveUpdate('t5CardH', this.value)">
                        </div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <span style="font-size:14px; width:100px;">Photo Size:</span>
                            <input type="range" min="80" max="300" value="160" oninput="liveUpdate('t5PhotoSize', this.value)">
                        </div>
                        
                        <hr style="border:1px dashed #ffd54f; margin:10px 0;">
                        <span style="display:block; font-weight:bold; margin-bottom:5px; color:#ff6f00;">4. Top 5 Text Settings (Flexible):</span>
                        
                        <div style="display:flex; gap:5px; margin-bottom:5px; align-items:center;">
                            <span style="font-size:12px; width:80px; font-weight:bold; color:blue;">‚Üï Text Y-Pos:</span>
                            <input type="range" min="-300" max="300" value="0" oninput="liveUpdate('t5TextY', this.value)">
                        </div>

                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <span style="font-size:12px; width:80px;">Name (DV):</span>
                            <input type="range" min="0.5" max="5" step="0.1" value="3.0" oninput="liveUpdate('t5NameSize', this.value)">
                            <input type="color" value="#ffffff" oninput="liveUpdate('tnDColor', this.value)">
                        </div>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <span style="font-size:12px; width:80px;">Name (EN):</span>
                            <input type="range" min="0.5" max="5" step="0.1" value="2.0" oninput="liveUpdate('t5EngSize', this.value)">
                            <input type="color" value="#ffffff" oninput="liveUpdate('tnEColor', this.value)">
                        </div>
                        <div style="display:flex; gap:5px;">
                            <span style="font-size:12px; width:80px;">Details:</span>
                            <input type="range" min="0.5" max="3" step="0.1" value="1.5" oninput="liveUpdate('t5DetSize', this.value)">
                            <input type="color" value="#fff9c4" oninput="liveUpdate('tfDColor', this.value)">
                        </div>
                    </div>
                </div>
                
                <div class="group-box" style="border-color:#d4af37; background:#fff8e1;">
                    <span class="group-title" style="background:#ff8f00;">üèÖ Badges & Animation Control</span>
                    <div class="design-col">
                        <p style="font-size:12px; color:#555; margin-bottom:10px;">Move badges anywhere and select animations.</p>
                        
                        <div style="margin-bottom:10px; border-bottom:1px dashed #ccc; padding-bottom:10px;">
                           <span style="font-weight:bold; color:#ff6f00;">1. Star Badge:</span>

<div style="display:flex; gap:5px; margin-top:5px;">
    <span style="font-size:12px;">X:</span>
    <input type="range" min="-950" max="950" value="-20" oninput="liveUpdate('badgeX', this.value)">
    <span style="font-size:12px;">Y:</span>
    <input type="range" min="-950" max="950" value="-20" oninput="liveUpdate('badgeY', this.value)">
</div>

<div style="display:flex; gap:5px; margin-top:5px; align-items:center;">
    <span style="font-size:12px; width:40px;">Size:</span>
    <input type="range" min="50" max="600" value="200" oninput="liveUpdate('starSize', this.value)">
</div>

<div style="display:flex; gap:5px; margin-top:5px; align-items: center;">
    <span style="font-size:12px;">Anim:</span>
    <select onchange="liveUpdate('badgeAnim', this.value)" style="width:100%; font-size:12px;">
        <option value="none">None</option>
        <option value="spin">Spin (Rotate)</option>
        <option value="pulse">Pulse (Scale)</option>
        <option value="float">Float (Up/Down)</option>
    </select>
</div>
                                <span style="font-size:12px;">Anim:</span>
                                <select onchange="liveUpdate('badgeAnim', this.value)" style="width:100%; font-size:12px;">
                                    <option value="none">None</option>
                                    <option value="spin">Spin (Rotate)</option>
                                    <option value="pulse">Pulse (Scale)</option>
                                    <option value="float">Float (Up/Down)</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <span style="font-weight:bold; color:#ff6f00;">2. Trophy Badge:</span>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <span style="font-size:12px;">X:</span><input type="range" min="-950" max="950" value="-10" oninput="liveUpdate('trophyX', this.value)">
                                <span style="font-size:12px;">Y:</span><input type="range" min="-950" max="950" value="-10" oninput="liveUpdate('trophyY', this.value)">
                            </div>
                            <div style="display:flex; gap:5px; margin-top:5px; align-items: center;">
                                <span style="font-size:12px;">Anim:</span>
                                <select onchange="liveUpdate('trophyAnim', this.value)" style="width:100%; font-size:12px;">
                                    <option value="none">None</option>
                                    <option value="shine">Shine (Glow)</option>
                                    <option value="pulse">Pulse (Scale)</option>
                                    <option value="zoom">Zoom In</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="group-box">
                    <span class="group-title">üåç ﬁåﬁ©ﬁâﬁ∞ ﬁáﬁ¶ﬁãﬁ® ﬁÑﬁ¨ﬁÜﬁ∞ﬁéﬁ∞ﬁÉﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁëﬁ∞</span>
                    <div class="design-col">
                        <span class="d-label">1. ﬁàﬁØﬁçﬁ∞ﬁïﬁ≠ﬁïﬁ¶ﬁÉ ﬁÑﬁ¨ﬁÜﬁ∞ﬁéﬁ∞ﬁÉﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁëﬁ∞:</span>
                        <div style="display:flex; gap:10px;">
                            <select id="bgPresetSel" onchange="liveUpdate('bgPreset', this.value)" style="width:70%;">
    
    <optgroup label="üëë ﬁùﬁßﬁÄﬁ© ﬁäﬁ¨ﬁÄﬁ® (Royal Green)">
        <script> for(let i=1; i<=20; i++) document.write(`<option value="bg${i}">Royal Green ${i}</option>`); </script>
    </optgroup>

    <optgroup label="üëë ﬁùﬁßﬁÄﬁ© ﬁÇﬁ´ (Royal Blue)">
        <script> for(let i=21; i<=40; i++) document.write(`<option value="bg${i}">Royal Blue ${i}</option>`); </script>
    </optgroup>

    <optgroup label="üëë ﬁùﬁßﬁÄﬁ© ﬁÉﬁ¶ﬁåﬁ∞ (Royal Red)">
        <script> for(let i=41; i<=60; i++) document.write(`<option value="bg${i}">Royal Red ${i}</option>`); </script>
    </optgroup>

    <optgroup label="‚ö´ ﬁçﬁ¶ﬁéﬁ∞ﬁíﬁ¶ﬁÉﬁ© ﬁÜﬁ¶ﬁÖﬁ™ (Luxury Black)">
        <script> for(let i=61; i<=80; i++) document.write(`<option value="bg${i}">Luxury Dark ${i}</option>`); </script>
    </optgroup>

    <optgroup label="üåê ﬁáﬁ¨ﬁÄﬁ¨ﬁÇﬁ®ﬁÄﬁ¨ﬁÇﬁ∞ (Modern/Mixed)">
        <script> for(let i=81; i<=200; i++) document.write(`<option value="bg${i}">Theme ${i}</option>`); </script>
    </optgroup>

</select>
                            <input type="file" id="jalsaBgFile" accept="video/*, image/*" style="width:30%" title="Upload Custom BG">
                        </div>
                        <div style="margin-top:8px;">
                            <select id="bgLoopSel" onchange="liveUpdate('bgLoop', this.value)" style="background:#fff;">
                                <option value="on">ﬁàﬁ©ﬁëﬁ®ﬁáﬁØ ﬁåﬁ¶ﬁÜﬁ™ﬁÉﬁßﬁÉﬁ™: ﬁáﬁßﬁÇ</option>
                                <option value="off">ﬁàﬁ©ﬁëﬁ®ﬁáﬁØ ﬁåﬁ¶ﬁÜﬁ™ﬁÉﬁßﬁÉﬁ™: ﬁÇﬁ´ﬁÇﬁ∞</option>
                            </select>
                        </div>
                        
                        <span class="d-label">2. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÜﬁßﬁëﬁ™ ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞ (Normal Mode):</span>
<div style="display:flex; gap:10px;">

    <select id="cBorderSel" onchange="liveUpdate('cBorder', this.value)" style="width:75%;">
        <option value="custom_bg">üñºÔ∏è ﬁÜﬁ¶ﬁêﬁ∞ﬁìﬁ¶ﬁâﬁ∞ ﬁÑﬁ¨ﬁÜﬁ∞ﬁéﬁ∞ﬁÉﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁëﬁ∞ (Image)</option>
        <option value="custom">üñºÔ∏è ﬁáﬁ¶ﬁâﬁ®ﬁáﬁ∞ﬁçﬁ¶ ﬁäﬁ∞ﬁÉﬁ≠ﬁâﬁ∞ (Frame)</option>
        <optgroup label="ﬁùﬁßﬁÄﬁ© ﬁäﬁ¨ﬁÄﬁ® ﬁÜﬁ™ﬁçﬁ¶ (Royal Green)">
            <script> for(let i=1; i<=15; i++) document.write(`<option value="b${i}">Style ${i} - Royal Green</option>`); </script>
        </optgroup>
        <optgroup label="ﬁùﬁßﬁÄﬁ© ﬁÇﬁ´ ﬁÜﬁ™ﬁçﬁ¶ (Royal Blue)">
            <script> for(let i=16; i<=30; i++) document.write(`<option value="b${i}">Style ${i} - Royal Blue</option>`); </script>
        </optgroup>
        <optgroup label="ﬁáﬁ¨ﬁÄﬁ¨ﬁÇﬁ®ﬁÄﬁ¨ﬁÇﬁ∞ ﬁïﬁ∞ﬁÉﬁ©ﬁâﬁ®ﬁáﬁ¶ﬁâﬁ∞ ﬁêﬁ∞ﬁìﬁ¶ﬁáﬁ®ﬁçﬁ∞ﬁåﬁ¶ﬁáﬁ∞">
            <script> for(let i=31; i<=100; i++) document.write(`<option value="b${i}">Style ${i} - Premium</option>`); </script>
        </optgroup>
        <option value="b0">üö´ ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞ (ﬁìﬁ∞ﬁÉﬁßﬁÇﬁ∞ﬁêﬁ∞ﬁïﬁ≠ﬁÉﬁ¨ﬁÇﬁ∞ﬁìﬁ∞)</option>
    </select>

    <input type="color" id="bdColorPick" value="#d4af37" oninput="liveUpdate('bdColor', this.value)" title="Theme Color">
</div>
                        <span class="d-label">3. ﬁÜﬁßﬁëﬁ™ﬁéﬁ¨ ﬁâﬁ¶ﬁ§ﬁßﬁâﬁ∞ (ﬁïﬁÆﬁíﬁ®ﬁùﬁ¶ﬁÇﬁ∞):</span>
                        <div style="display:flex; gap:10px; align-items:center; background:#fff; padding:10px; border-radius:8px; border:1px solid #ccc;">
                            <span style="font-size:14px; font-weight:bold;">ﬁÜﬁ¶ﬁÇﬁßﬁåﬁ∞/ﬁàﬁßﬁåﬁ∞:</span>
                            <input type="range" id="cardXRange" min="-600" max="600" value="0" oninput="liveUpdate('cardX', this.value)">
                            <span style="font-size:14px; font-weight:bold;">ﬁâﬁ¶ﬁåﬁ®/ﬁåﬁ®ﬁÉﬁ®:</span>
                            <input type="range" id="cardYRange" min="-450" max="450" value="0" oninput="liveUpdate('cardY', this.value)">
                        </div>

                        <span class="d-label">4. ﬁÜﬁßﬁëﬁ™ﬁéﬁ¨ ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞:</span>
                        <div style="display:flex; gap:15px; align-items:center;">
                            <span style="font-size:14px; font-weight:bold;">ﬁäﬁ™ﬁÖﬁßﬁâﬁ®ﬁÇﬁ∞:</span>
                            <input type="range" id="cardWRange" min="50" max="100" value="90" oninput="liveUpdate('cardW', this.value)">
                            <span style="font-size:14px; font-weight:bold;">ﬁáﬁ™ﬁêﬁ∞ﬁâﬁ®ﬁÇﬁ∞:</span>
                            <input type="range" id="cardHRange" min="50" max="100" value="80" oninput="liveUpdate('cardH', this.value)">
                        </div>
                        <div style="display:flex; gap:10px; margin-top:8px;">
                            <select id="layoutDirSel" onchange="liveUpdate('layoutDir', this.value)" style="width:50%;">
                                <option value="rtl">ﬁäﬁÆﬁìﬁØ ﬁÜﬁ¶ﬁÇﬁßﬁåﬁ∞ ﬁäﬁ¶ﬁÉﬁßﬁåﬁ™ﬁéﬁ¶ﬁáﬁ® (RTL)</option>
                                <option value="ltr">ﬁäﬁÆﬁìﬁØ ﬁàﬁßﬁåﬁ∞ ﬁäﬁ¶ﬁÉﬁßﬁåﬁ™ﬁéﬁ¶ﬁáﬁ® (LTR)</option>
                            </select>
                            <select id="textAlignSel" onchange="liveUpdate('textAlign', this.value)" style="width:50%;">
                                <option value="right">ﬁçﬁ®ﬁîﬁ™ﬁÇﬁ∞: ﬁÜﬁ¶ﬁÇﬁßﬁåﬁ¶ﬁÅﬁ∞</option>
                                <option value="center">ﬁçﬁ®ﬁîﬁ™ﬁÇﬁ∞: ﬁâﬁ¨ﬁãﬁ¶ﬁÅﬁ∞</option>
                                <option value="left">ﬁçﬁ®ﬁîﬁ™ﬁÇﬁ∞: ﬁàﬁßﬁåﬁ¶ﬁÅﬁ∞</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="group-box">
                    <span class="group-title">üì∏ ﬁäﬁÆﬁìﬁØ ﬁêﬁ∞ﬁìﬁ´ﬁëﬁ®ﬁáﬁØ</span>
                    
                    <span class="d-label">1. ﬁäﬁ∞ﬁÉﬁ≠ﬁâﬁ∞ ﬁêﬁ∞ﬁìﬁ¶ﬁáﬁ®ﬁçﬁ∞:</span>
                    <select id="photoPresetSel" onchange="applyPhotoPreset(this.value)" style="width:100%; font-weight:bold; font-size:15px; padding:10px;">
                        <option value="0">--- ﬁäﬁ∞ﬁÉﬁ≠ﬁâﬁ∞ ﬁêﬁ∞ﬁìﬁ¶ﬁáﬁ®ﬁçﬁ∞ ﬁÇﬁ¶ﬁéﬁß ---</option>
                        <optgroup label="ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁàﬁ¶ﬁåﬁ¶ ﬁùﬁ¨ﬁëﬁØﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞">
                            <option value="1">1. ﬁáﬁßﬁãﬁ¶ﬁáﬁ®ﬁéﬁ¨ (ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ¨ﬁáﬁ∞ ﬁÇﬁ¨ﬁåﬁ∞)</option>
                            <option value="2">2. ﬁâﬁ¶ﬁëﬁ™ ﬁÄﬁ®ﬁîﬁ¶ﬁÇﬁ® (Soft Shadow)</option>
                            <option value="3">3. ﬁéﬁ¶ﬁãﬁ¶ ﬁÄﬁ®ﬁîﬁ¶ﬁÇﬁ® (Hard Shadow)</option>
                            <option value="4">4. ﬁãﬁ®ﬁáﬁ∞ﬁçﬁ≠ ﬁéﬁÆﬁåﬁ¶ﬁÅﬁ∞ (Glow)</option>
                        </optgroup>
                        <optgroup label="ﬁáﬁßﬁãﬁ¶ﬁáﬁ®ﬁéﬁ¨ ﬁÑﬁØﬁëﬁ¶ﬁÉﬁ™">
                            <option value="5">5. ﬁÄﬁ®ﬁâﬁ¶ ﬁÜﬁ¶ﬁÖﬁ™ ﬁÉﬁÆﬁÇﬁéﬁ™</option>
                            <option value="6">6. ﬁÑﬁØ ﬁÇﬁ´ ﬁäﬁ∞ﬁÉﬁ≠ﬁâﬁ∞</option>
                            <option value="7">7. ﬁåﬁ®ﬁÜﬁ® ﬁñﬁ¨ﬁÄﬁ® ﬁÉﬁÆﬁÇﬁéﬁ™</option>
                            <option value="8">8. ﬁÜﬁ¨ﬁÇﬁëﬁ®ﬁäﬁ¶ﬁáﬁ®ﬁàﬁß ﬁÉﬁÆﬁÇﬁéﬁ™</option>
                            <option value="9">9. ﬁëﬁ¶ﬁÑﬁ¶ﬁçﬁ∞ ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞</option>
                            <option value="10">10. ﬁàﬁ¶ﬁÅﬁ∞ ﬁÜﬁ¶ﬁÇﬁ¨ﬁáﬁ∞ (Rounded)</option>
                            <option value="11">11. ﬁàﬁ¶ﬁÅﬁ∞ ﬁÑﬁ™ﬁÉﬁ™ (Circle)</option>
                        </optgroup>
                        <optgroup label="ﬁÜﬁ∞ﬁÉﬁ®ﬁáﬁ≠ﬁìﬁ®ﬁàﬁ∞">
                            <option value="12">12. ﬁáﬁ¨ﬁåﬁ¨ﬁÉﬁ¨ﬁáﬁ¶ﬁÅﬁ∞ ﬁàﬁ¶ﬁãﬁ¨ﬁäﬁ¶ﬁáﬁ® (Inset 3D)</option>
                            <option value="13">13. ﬁÑﬁ≠ﬁÉﬁ¶ﬁÅﬁ∞ ﬁÇﬁ™ﬁÜﬁ™ﬁâﬁ¨ﬁäﬁ¶ﬁáﬁ® (Outset 3D)</option>
                            <option value="14">14. ﬁïﬁÆﬁçﬁ¶ﬁÉﬁÆﬁáﬁ®ﬁëﬁ∞ ﬁêﬁ∞ﬁìﬁ¶ﬁáﬁ®ﬁçﬁ∞</option>
                            <option value="15">15. ﬁÉﬁ¶ﬁÇﬁ∞ ﬁÜﬁ™ﬁçﬁ¶ﬁáﬁ®ﬁéﬁ¨ ﬁéﬁ∞ﬁÉﬁ´ﬁàﬁ∞</option>
                            <option value="16">16. ﬁÜﬁßﬁëﬁ™ ﬁêﬁ∞ﬁìﬁ¶ﬁáﬁ®ﬁçﬁ∞</option>
                        </optgroup>
                    </select>

                    <span class="d-label">2. ﬁäﬁ∞ﬁÉﬁ≠ﬁâﬁ∞ ﬁáﬁ¨ﬁñﬁ¶ﬁêﬁ∞ﬁìﬁ∞ﬁâﬁ¶ﬁÇﬁ∞ﬁìﬁ∞:</span>
                    <div style="display:flex; gap:10px; align-items:center; background:#fff; padding:10px; border-radius:8px; border:1px solid #b2dfdb;">
                        <span style="font-size:14px;">ﬁÜﬁ™ﬁçﬁ¶:</span><input type="color" id="pfColorPick" value="#000000" oninput="liveUpdate('pfColor', this.value)">
                        <span style="font-size:14px;">ﬁäﬁ™ﬁÖﬁßﬁâﬁ®ﬁÇﬁ∞:</span><input type="range" id="pfWidthRange" min="0" max="30" value="0" oninput="liveUpdate('pfWidth', this.value)">
                        <span style="font-size:14px;">ﬁàﬁ¶ﬁÅﬁ∞:</span><input type="range" id="pfRadiusRange" min="0" max="50" value="0" oninput="liveUpdate('pfRadius', this.value)">
                    </div>
                    
                    <span class="d-label">3. ﬁäﬁÆﬁìﬁØﬁéﬁ¨ ﬁâﬁ¶ﬁ§ﬁßﬁâﬁ∞ ﬁáﬁ¶ﬁãﬁ® ﬁíﬁ´ﬁâﬁ∞:</span>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:14px; width:50px;">ﬁíﬁ´ﬁâﬁ∞:</span>
                        <input type="range" id="pSizeRange" min="150" max="800" value="260" oninput="liveUpdate('pSize', this.value)">
                        <select id="pVisSel" onchange="liveUpdate('pVis', this.value)" style="width:100px;"><option value="show">ﬁãﬁ¶ﬁáﬁ∞ﬁÜﬁß</option><option value="hide">ﬁäﬁÆﬁÉﬁ™ﬁàﬁß</option></select>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:8px; align-items:center;">
                        <span style="font-size:14px; width:50px;">ﬁâﬁ´ﬁàﬁ∞:</span>
                        <input type="range" id="pXRange" min="-600" max="600" value="0" title="X" oninput="liveUpdate('pX', this.value)">
                        <input type="range" id="pYRange" min="-400" max="400" value="0" title="Y" oninput="liveUpdate('pY', this.value)">
                    </div>
                    <div style="margin-top:10px;">
                        <select id="pFitSel" onchange="liveUpdate('pFit', this.value)">
                            <option value="cover">Fit: Fill Box (Cover)</option>
                            <option value="contain">Fit: Full Photo (Contain)</option>
                        </select>
                    </div>
                </div>

                <div class="group-box">
                    <span class="group-title">üî§ ﬁçﬁ®ﬁîﬁ™ﬁÇﬁ∞ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞ (Normal Mode)</span>
                    
                    <span class="d-label">1. ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ (ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞/ﬁÜﬁ™ﬁçﬁ¶):</span>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                        <span style="font-size:14px; width:60px;">ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®:</span>
                        <input type="range" min="2" max="10" step="0.1" value="6.5" oninput="liveUpdate('tnDSize', this.value)">
                        <input type="color" value="#ffffff" oninput="liveUpdate('tnDColor', this.value)">
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                        <span style="font-size:14px; width:60px;">ﬁáﬁ®ﬁÇﬁéﬁ®ﬁÉﬁ≠ﬁêﬁ®:</span>
                        <input type="range" min="1" max="8" step="0.1" value="4.5" oninput="liveUpdate('tnESize', this.value)">
                        <input type="color" value="#ffffff" oninput="liveUpdate('tnEColor', this.value)">
                    </div>
                    <div style="margin-top:5px;">
                        <select onchange="liveUpdate('nLine', this.value)" style="background:#fff;">
                            <option value="off">ﬁÇﬁ¶ﬁâﬁ™ﬁéﬁ¨ ﬁåﬁ®ﬁÉﬁ© ﬁÉﬁÆﬁÇﬁéﬁ™: ﬁÇﬁ™ﬁçﬁß</option>
                            <option value="on">ﬁÇﬁ¶ﬁâﬁ™ﬁéﬁ¨ ﬁåﬁ®ﬁÉﬁ© ﬁÉﬁÆﬁÇﬁéﬁ™: ﬁçﬁß</option>
                        </select>
                    </div>
                    
                    <hr style="border:1px dashed #aaa; margin:12px 0;">

                    <span class="d-label">2. ﬁåﬁ¶ﬁäﬁ∞ﬁêﬁ©ﬁçﬁ™ ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞:</span>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                        <span style="font-size:14px; width:60px;">ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ 1:</span>
                        <input type="range" min="1" max="6" step="0.1" value="2.5" oninput="liveUpdate('tfDSize', this.value)">
                        <input type="color" value="#fff9c4" oninput="liveUpdate('tfDColor', this.value)">
                    </div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:14px; width:60px;">ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ 2:</span>
                        <input type="range" min="1" max="6" step="0.1" value="3.0" oninput="liveUpdate('tcDSize', this.value)">
                        <input type="color" value="#fff9c4" oninput="liveUpdate('tcDColor', this.value)">
                    </div>
                </div>

                <div class="group-box">
                    <span class="group-title">üëë ﬁñﬁ¶ﬁçﬁ∞ﬁêﬁßﬁéﬁ¨ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ﬁåﬁ¶ﬁáﬁ∞</span>
                    
                    <span class="d-label">1. ﬁâﬁ¶ﬁáﬁ® ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞:</span>
                    <input type="text" id="jLine1" placeholder="ﬁâﬁ¶ﬁáﬁ® ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞..." class="font-dv" oninput="updateJalsaText()">
                    
                    <div style="margin-top:5px;">
                        <select onchange="liveUpdate('tLine', this.value)" style="width:100%; background:#fff;">
                            <option value="on">Underline Main Title: YES</option>
                            <option value="off">Underline Main Title: NO</option>
                        </select>
                    </div>

                    <div style="display:flex; align-items:center; gap:15px; margin-top:8px; background:#fff; padding:10px; border-radius:8px; border:1px solid #bbdefb;">
                        <div style="flex:1;">
                            <span style="font-size:13px; color:#555; display:block;">ﬁâﬁ¶ﬁåﬁ®/ﬁåﬁ®ﬁÉﬁ® (Y):</span>
                            <input type="range" id="mtYRange" min="-600" max="600" value="210" oninput="liveUpdate('mtY', this.value)">
                            <span style="font-size:13px; color:#555; display:block;">ﬁÜﬁ¶ﬁÇﬁßﬁåﬁ∞/ﬁàﬁßﬁåﬁ∞ (X):</span>
                            <input type="range" id="mtXRange" min="-800" max="800" value="0" oninput="liveUpdate('mtX', this.value)">
                        </div>
                    </div>

                    <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
                        <span style="font-size:14px;">ﬁêﬁ¶ﬁáﬁ®ﬁíﬁ∞:</span>
                        <input type="range" id="mtSizeRange" min="2" max="10" step="0.1" value="5.6" oninput="liveUpdate('mtSize', this.value)">
                        <input type="color" id="mtColorPick" value="#d4af37" oninput="liveUpdate('mtColor', this.value)">
                        <select id="mtAlignSel" onchange="liveUpdate('mtAlign', this.value)" style="width:100px;"><option value="center">ﬁâﬁ¨ﬁãﬁ¶ﬁÅﬁ∞</option><option value="right">ﬁÜﬁ¶ﬁÇﬁßﬁåﬁ¶ﬁÅﬁ∞</option><option value="left">ﬁàﬁßﬁåﬁ¶ﬁÅﬁ∞</option></select>
                    </div>
                    <div style="margin-top:5px;">
                        <label style="font-size:13px;"><input type="checkbox" id="keepTitleCheck" onchange="liveUpdate('keepTitle', this.checked)"> Keep Title with Student Card</label>
                    </div>

                    <hr style="border:1px dashed #999; margin:15px 0;">

                    <span class="d-label">2. ﬁêﬁ¶ﬁÑﬁ∞ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ﬁåﬁ¶ﬁáﬁ∞ (7 ﬁäﬁÆﬁÖﬁ™ﬁàﬁ¶ﬁåﬁ∞):</span>
                    
                    <div style="background:#e8eaf6; padding:10px; border-radius:8px; border:1px solid #c5cae9; margin-bottom:10px;">
                        <label style="font-size:12px;">Edit Style for Line:</label>
                        <select id="stStyleSelector" style="font-size:12px; padding:5px; margin-bottom:5px;">
                            <option value="1">Line 1</option>
                            <option value="2">Line 2</option>
                            <option value="3">Line 3</option>
                            <option value="4">Line 4</option>
                            <option value="5">Line 5</option>
                            <option value="6">Line 6</option>
                            <option value="7">Line 7</option>
                        </select>
                        <div style="display:flex; gap:5px;">
                            <input type="range" oninput="setSubtitleStyle('size', this.value)" min="1" max="6" step="0.1" value="2.6" title="Size">
                            <input type="color" oninput="setSubtitleStyle('color', this.value)" value="#ffffff" title="Color">
                        </div>
                    </div>

                    <input type="text" id="jLine2" placeholder="ﬁêﬁ¶ﬁÑﬁ∞ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ 1" class="sub-title-input">
                    <input type="text" id="jLine3" placeholder="ﬁêﬁ¶ﬁÑﬁ∞ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ 2" class="sub-title-input">
                    <input type="text" id="jLine4" placeholder="ﬁêﬁ¶ﬁÑﬁ∞ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ 3" class="sub-title-input">
                    <input type="text" id="jLine5" placeholder="ﬁêﬁ¶ﬁÑﬁ∞ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ 4" class="sub-title-input">
                    <input type="text" id="jLine6" placeholder="ﬁêﬁ¶ﬁÑﬁ∞ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ 5" class="sub-title-input">
                    <input type="text" id="jLine7" placeholder="ﬁêﬁ¶ﬁÑﬁ∞ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ 6" class="sub-title-input">
                    <input type="text" id="jLine8" placeholder="ﬁêﬁ¶ﬁÑﬁ∞ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ 7" class="sub-title-input">
                    
                    <div style="display:flex; gap:10px; margin-top:8px; align-items:center;">
                        <span style="font-size:14px;">ﬁáﬁ¨ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞:</span>
                        <select id="stAlignSel" onchange="liveUpdate('stAlign', this.value)" style="width:100%; background:#fff;">
                            <option value="center">ﬁâﬁ¨ﬁãﬁ¶ﬁÅﬁ∞</option>
                            <option value="right">ﬁÜﬁ¶ﬁÇﬁßﬁåﬁ¶ﬁÅﬁ∞</option>
                            <option value="left">ﬁàﬁßﬁåﬁ¶ﬁÅﬁ∞</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:8px; align-items:center;">
                          <span style="font-size:14px;">Y-Pos:</span>
                          <input type="range" id="stYRange" min="0" max="400" value="0" title="Space" oninput="liveUpdate('stY', this.value)">
                    </div>
                      <div style="display:flex; gap:10px; margin-top:8px; align-items:center;">
                          <span style="font-size:14px;">Gap:</span>
                          <input type="range" id="stGapRange" min="0" max="100" value="5" title="Gap" oninput="liveUpdate('stGap', this.value)">
                    </div>
                    <div style="margin-top:5px;">
                        <select onchange="liveUpdate('stLine', this.value)" style="background:#fff;">
                            <option value="off">ﬁêﬁ¶ﬁÑﬁ∞ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ ﬁÉﬁÆﬁÇﬁéﬁ™: ﬁÇﬁ™ﬁçﬁß</option>
                            <option value="on">ﬁêﬁ¶ﬁÑﬁ∞ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ ﬁÉﬁÆﬁÇﬁéﬁ™: ﬁçﬁß</option>
                        </select>
                    </div>
                    
                    <button class="btn-vid" style="background:#2e7d32; width:100%; margin-top:15px; font-weight:bold; font-size:18px; padding:12px;" onclick="updateJalsaText()">ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁáﬁ¶ﬁïﬁ∞ﬁëﬁ≠ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ≠</button>
                </div>

                <div class="group-box">
                    <span class="group-title">üñºÔ∏è 5 ﬁâﬁ¨ﬁáﬁ®ﬁÇﬁ∞ ﬁçﬁØﬁéﬁØ ﬁâﬁ¨ﬁÇﬁ≠ﬁñﬁ¶ﬁÉ</span>
                    <div style="background:#fff; padding:10px; border-radius:5px; margin-bottom:10px;">
                        <label style="font-size:12px;">Select Logo to Move:</label>
                        <select id="activeLogoIdx" onchange="refreshLogoInputs()" style="width:100%;">
                            <option value="0">Logo 1</option>
                            <option value="1">Logo 2</option>
                            <option value="2">Logo 3</option>
                            <option value="3">Logo 4</option>
                            <option value="4">Logo 5</option>
                        </select>
                    </div>
                    
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:12px;">Size:</span>
                        <input type="range" id="mlSize" min="20" max="500" value="100" oninput="updateLogoStyle('size', this.value)">
                    </div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:12px;">X-Pos:</span>
                        <input type="range" id="mlX" min="-950" max="950" value="0" oninput="updateLogoStyle('x', this.value)">
                    </div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:12px;">Y-Pos:</span>
                        <input type="range" id="mlY" min="-500" max="500" value="0" oninput="updateLogoStyle('y', this.value)">
                    </div>
                    
                      <div style="margin-top:8px;">
                        <label style="font-size:12px; display:inline-flex; align-items:center;">
                            <input type="checkbox" id="logoAutoHideCheck" checked onchange="liveUpdate('logoAutoHide', this.checked)"> ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁÜﬁßﬁëﬁ™ ﬁáﬁ¶ﬁÉﬁßﬁáﬁ®ﬁÉﬁ™ ﬁâﬁ¨ﬁáﬁ®ﬁÇﬁ∞ ﬁçﬁØﬁéﬁØﬁåﬁ¶ﬁáﬁ∞ ﬁäﬁÆﬁÉﬁ™ﬁàﬁß
                        </label>
                        <button class="btn-vid" style="background:#37474f; margin-top:5px;" onclick="toggleMainLogos()">üëÅÔ∏è Toggle Main Logos</button>
                    </div>
                    
                    <hr>
                    <span class="d-label" style="font-size:14px;">Partner Logos Settings:</span>
                      <div style="margin-bottom:8px;">
                          <label style="font-size:12px; display:inline-flex; align-items:center;">
                              <input type="checkbox" id="plAutoHideCheck" checked onchange="liveUpdate('plAutoHide', this.checked)"> ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ ﬁÜﬁßﬁëﬁ™ ﬁáﬁ¶ﬁÉﬁßﬁáﬁ®ﬁÉﬁ™ ﬁïﬁßﬁìﬁ∞ﬁÇﬁ¶ﬁÉ ﬁçﬁØﬁéﬁØﬁåﬁ¶ﬁáﬁ∞ ﬁäﬁÆﬁÉﬁ™ﬁàﬁß
                          </label>
                      </div>
                      <div style="margin-bottom:8px;">
                          <button class="btn-vid" style="background:#455a64;" onclick="togglePartnerLogos()">üëÅÔ∏è Toggle Partner Logos</button>
                      </div>
                    <div style="display:flex; gap:5px;">
                          <span>Gap:</span><input type="range" oninput="liveUpdate('plGap', this.value)" min="0" max="100" value="20">
                          <span>Size:</span><input type="range" oninput="liveUpdate('plSize', this.value)" min="50" max="300" value="100">
                    </div>
                      <div style="display:flex; gap:5px; margin-top:5px;">
                          <span>Y-Pos:</span><input type="range" oninput="liveUpdate('plY', this.value)" min="-600" max="600" value="0">
                      </div>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                          <span>X-Pos:</span><input type="range" oninput="liveUpdate('plX', this.value)" min="-800" max="800" value="0">
                    </div>
                </div>

            </div>
        </div>
    </div>

<script>
    document.addEventListener('contextmenu', event => event.preventDefault());
    
    // --- FULL SCREEN ---
    function toggleControlFS() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                alert(`Error: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    // --- LICENSE LOGIC ---
    function verifyLicense() {
        document.getElementById('securityOverlay').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        document.getElementById('licenseStatus').innerText = "‚úÖ PLATINUM EDITION | V33.0 ACTIVE";
    }
    document.getElementById('licenseKey').addEventListener("keyup", e => { if (e.key === "Enter") verifyLicense(); });

    let tvWindow = null;
    let students = [];
    let photoFiles = {};
    
    // Top 5 Separation Arrays
    let top5Students = [];
    let top5PhotoFiles = {};
    let activeListMode = 'general'; 
    let top5VideoPlaylist = []; 
    
    let partnerLogosData = [];
    let mainLogosData = [];
    let adFiles = [];
    let adInterval = null;
    let adIndex = 0;
    let currentPhotoData = null;
    let currentFontData = null;
    let currentJalsaBgData = null;
    let currentJalsaBgType = 'none';
    let customBorderData = null;
    let customCardBgData = null;
    let royalStarData = null;
    let trophyData = null;
    
    let isLocked = false;
    let lastActiveState = 'title'; 
    let playlist = [];
    let currentVidIdx = 0;
    let pdfUrl = null;

    // Subtitle Styles Logic
    let stStyles = {};
    for(let i=1; i<=8; i++) stStyles[i] = { size: 2.6, color: '#ffffff' };

    function setSubtitleStyle(prop, val) {
        let line = document.getElementById('stStyleSelector').value;
        if(prop === 'size') stStyles[line].size = val;
        if(prop === 'color') stStyles[line].color = val;
        updateJalsaText();
    }

    // --- STATE MANAGER ---
   // --- STATE MANAGER (UPDATED FOR ROYAL GREEN DEFAULT) ---
    let designState = {
        // 1. Title Colors (Gold Default)
        mtY: 210, mtX: 0, mtSize: 5.6, 
        mtColor: '#FFD700', // ﬁùﬁßﬁÄﬁ© ﬁÉﬁ¶ﬁÇﬁ∞ﬁÜﬁ™ﬁçﬁ¶ (Royal Gold)
        mtAlign: 'center', tLine: 'on', keepTitle: false,
        
        stY: 0, stX: 0, stGap: 5, stLine: 'off', stAlign: 'center',
        
        logos: [
            {x:0, y:-300, s:150}, {x:-400, y:-300, s:100}, {x:400, y:-300, s:100}, {x:0, y:300, s:100}, {x:0, y:0, s:100}
        ],
        logoVisible: true, logoAutoHide: true,
        plGap: 20, plSize: 100, plAutoHide: true, plVisible: true, plY: 20, plX: 0,
        pSize: 260, pX: 0, pY: 0, pVis: 'show', pFit: 'cover',
        pfWidth: 0, pfColor: '#000000', pfStyle: 'solid', pfRadius: 0, pfShadow: 'none',
        
        // 2. Card & Background Defaults
        cBorder: 'b1',      // Style 1 (Royal Green Border)
        bdColor: '#FFD700', // Theme Color (Gold)
        bgPreset: 'bg1',    // Background 1 (Royal Green Wallpaper)
        
        layoutDir: 'rtl', textAlign: 'right', bgLoop: 'on',
        
        // 3. Student Name Colors (Gold & White)
        tnDSize: 6.5, 
        tnDColor: '#FFD700', // ﬁÇﬁ¶ﬁÇﬁ∞ (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®) - ﬁÉﬁ¶ﬁÇﬁ∞ﬁÜﬁ™ﬁçﬁ¶
        tnESize: 4.5, 
        tnEColor: '#ffffff', // Name (English) - White
        nLine: 'off',
        
        tfDSize: 2.5, tfDColor: '#fff9c4', tcDSize: 3.0, tcDColor: '#fff9c4',
        cardW: 90, cardH: 80, cardX: 0, cardY: 0,
        
        // TOP 5 SPECIFIC VARIABLES
        t5CardW: 95, t5CardH: 22, t5Bottom: 2, t5PhotoSize: 160,
        t5NameSize: 3.0, t5EngSize: 2.0, t5DetSize: 1.5,
        t5TextY: 0, 
        t5Layout: 'bottom', 
        tvX: 10, tvY: 5, tvW: 80, tvH: 65, 
        
        // BADGES & ANIMATIONS
        badgeX: -20, badgeY: -20, badgeAnim: 'none',
        trophyX: -10, trophyY: -10, trophyAnim: 'none'
    };

    // --- MAIN LOGO MANAGER ---
    function loadMainLogos(input) {
        mainLogosData = [];
        for(let f of input.files) mainLogosData.push(URL.createObjectURL(f));
        renderMainLogos();
        alert(mainLogosData.length + " Main Logos Loaded.");
    }

    function renderMainLogos() {
        if(!tvWindow || tvWindow.closed) return;
        const container = tvWindow.document.getElementById('mainLogosContainer');
        container.innerHTML = '';
        mainLogosData.forEach((src, idx) => {
            if(idx >= 5) return;
            const img = tvWindow.document.createElement('img');
            img.src = src;
            img.id = 'ml-'+idx;
            img.className = 'main-logo-img';
            const st = designState.logos[idx];
            img.style.width = st.s + 'px';
            img.style.transform = `translate(${st.x}px, ${st.y}px)`;
            container.appendChild(img);
        });
    }

    function refreshLogoInputs() {
        const idx = document.getElementById('activeLogoIdx').value;
        const st = designState.logos[idx];
        document.getElementById('mlSize').value = st.s;
        document.getElementById('mlX').value = st.x;
        document.getElementById('mlY').value = st.y;
    }

    function updateLogoStyle(prop, val) {
        const idx = document.getElementById('activeLogoIdx').value;
        designState.logos[idx][prop.replace('size', 's')] = parseInt(val); 
        
        if(!tvWindow || tvWindow.closed) return;
        const img = tvWindow.document.getElementById('ml-'+idx);
        if(img) {
            const st = designState.logos[idx];
            img.style.width = st.s + 'px';
            img.style.transform = `translate(${st.x}px, ${st.y}px)`;
        }
    }

    function toggleMainLogos() {
        designState.logoVisible = !designState.logoVisible;
        if(!tvWindow || tvWindow.closed) return;
        tvWindow.document.getElementById('mainLogosContainer').style.opacity = designState.logoVisible ? '1' : '0';
    }

    // --- LOCK FUNCTION (ULTIMATE FIX - DISABLES ALL INPUTS) ---
    function toggleLock() {
        isLocked = !isLocked;
        const btn = document.getElementById('lockBtn');
        
        // 1. ﬁçﬁÆﬁÜﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁàﬁß ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞ﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁÇﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞
        const panelIds = ['designPanel', 'sidebarFiles', 'infoPanel', 'configPanel', 'listPanel'];

        // 2. ﬁçﬁÆﬁÜﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁàﬁß ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁáﬁ®ﬁÇﬁ∞ﬁïﬁ™ﬁìﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁÄﬁÆﬁàﬁßﬁçﬁ™ﬁÇﬁ∞
        // (Design, Files, Info, Settings, Lists)
        const inputsToLock = document.querySelectorAll(
            '#designPanel input, #designPanel select, #designPanel button, ' +
            '#sidebarFiles input, #sidebarFiles select, #sidebarFiles button, ' +
            '#infoPanel input, #infoPanel textarea, #infoPanel button, ' +
            '#configPanel button, ' +
            '#listPanel button, #search'
        );

        if (isLocked) {
            // --- LOCK MODE ON ---
            btn.innerHTML = "üîí SYSTEM LOCKED (LIVE MODE)";
            btn.classList.add('active');
            
            // ﬁÜﬁ™ﬁçﬁ¶ ﬁäﬁ¶ﬁÇﬁëﬁ™ﬁÜﬁÆﬁÅﬁ∞ﬁçﬁ™ﬁÇﬁ∞ (Visual Lock)
            panelIds.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('locked-zone');
            });

            // ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁáﬁ¨ﬁáﬁ∞ﬁóﬁ¨ﬁáﬁ∞ ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁ™ﬁàﬁßﬁçﬁ™ﬁÇﬁ∞ (Functional Lock - Disable)
            inputsToLock.forEach(el => el.disabled = true);
            
        } else {
            // --- UNLOCK MODE ---
            btn.innerHTML = "üîì UNLOCKED (Edit Mode)";
            btn.classList.remove('active');
            
            // ﬁÜﬁ™ﬁçﬁ¶ ﬁáﬁ¶ﬁÇﬁÑﬁ™ﬁÉﬁß ﬁéﬁ¨ﬁÇﬁ¶ﬁáﬁ™ﬁÇﬁ∞
            panelIds.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.remove('locked-zone');
            });

            // ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁáﬁ¨ﬁáﬁ∞ﬁóﬁ¨ﬁáﬁ∞ ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁßﬁçﬁ™ﬁÇﬁ∞ (Enable)
            inputsToLock.forEach(el => el.disabled = false);
        }
    }
    function downloadConfig() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(designState));
        const a = document.createElement('a'); a.href = dataStr; a.download = "royal_config_v33.json"; document.body.appendChild(a); a.click(); a.remove();
    }

   // --- NEW UPDATED SAVE/LOAD FUNCTIONS (SAVES TITLES & STYLES) ---

    function downloadConfig() {
        // 1. Save Subtitle Specific Styles (stStyles is global, so we add it to designState temporarily)
        designState.savedStStyles = stStyles;

        // 2. Save Written Titles (Saves what you typed in the boxes)
        designState.savedTitles = {
            t1: document.getElementById('jLine1').value,
            t2: document.getElementById('jLine2').value,
            t3: document.getElementById('jLine3').value,
            t4: document.getElementById('jLine4').value,
            t5: document.getElementById('jLine5').value,
            t6: document.getElementById('jLine6').value,
            t7: document.getElementById('jLine7').value,
            t8: document.getElementById('jLine8').value
        };

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(designState));
        const a = document.createElement('a'); a.href = dataStr; a.download = "royal_config_v33_full.json"; document.body.appendChild(a); a.click(); a.remove();
    }

    function loadConfig(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const loaded = JSON.parse(e.target.result);
                Object.assign(designState, loaded);
                
                // --- RESTORE SUBTITLE STYLES ---
                if(loaded.savedStStyles) {
                    stStyles = loaded.savedStStyles;
                }

                // --- RESTORE WRITTEN TITLES ---
                if(loaded.savedTitles) {
                    document.getElementById('jLine1').value = loaded.savedTitles.t1 || "";
                    document.getElementById('jLine2').value = loaded.savedTitles.t2 || "";
                    document.getElementById('jLine3').value = loaded.savedTitles.t3 || "";
                    document.getElementById('jLine4').value = loaded.savedTitles.t4 || "";
                    document.getElementById('jLine5').value = loaded.savedTitles.t5 || "";
                    document.getElementById('jLine6').value = loaded.savedTitles.t6 || "";
                    document.getElementById('jLine7').value = loaded.savedTitles.t7 || "";
                    document.getElementById('jLine8').value = loaded.savedTitles.t8 || "";
                }

                if(tvWindow && !tvWindow.closed) { 
                    for (const key in designState) { liveUpdate(key, designState[key]); }
                    renderMainLogos(); 
                    
                    // Force update titles visually on TV
                    updateJalsaText();
                }
                
                // Update checkbox states based on loaded settings
                if(designState.plAutoHide !== undefined) document.getElementById('plAutoHideCheck').checked = designState.plAutoHide;
                if(designState.logoAutoHide !== undefined) document.getElementById('logoAutoHideCheck').checked = designState.logoAutoHide;
                if(designState.keepTitle !== undefined) document.getElementById('keepTitleCheck').checked = designState.keepTitle;
                if(designState.t5Layout !== undefined) document.getElementById('t5LayoutSel').value = designState.t5Layout;
                
                refreshLogoInputs();
                alert("Settings & Titles Loaded Successfully!");

            } catch(err) { 
                console.error(err);
                alert("Invalid Config File"); 
            }
        };
        reader.readAsText(file);
    }
    function setVal(id, val) { const el = document.getElementById(id); if(el) el.value = val; }

    function applyPhotoPreset(val) {
        let w = 0, c = '#000000', s = 'solid', r = 0, sh = 'none';
        switch(val) {
            case "1": break;
            case "2": sh = '0 4px 8px rgba(0,0,0,0.3)'; break;
            case "3": sh = '5px 5px 0px rgba(0,0,0,1)'; break;
            case "4": sh = '0 0 15px rgba(0, 150, 255, 0.6)'; break;
            case "5": w=1; break;
            case "6": w=6; c='#0056b3'; break;
            case "7": w=4; c='#d9534f'; s='dotted'; break;
            case "8": w=4; c='#5cb85c'; s='dashed'; break;
            case "9": w=6; c='#f0ad4e'; s='double'; break;
            case "10": w=3; c='#333333'; r=10; break;
            case "11": w=3; c='#5bc0de'; r=50; break;
            case "12": w=10; c='#999999'; s='inset'; break;
            case "13": w=10; c='#999999'; s='outset'; break;
            case "14": w=15; c='#ffffff'; sh='0 2px 5px rgba(0,0,0,0.3)'; break;
            case "15": w=8; c='#FFD700'; s='groove'; break;
            case "16": w=5; c='#ffffff'; r=5; sh='0 4px 6px rgba(0,0,0,0.1)'; break;
        }
        setVal('pfWidthRange', w); setVal('pfColorPick', c); setVal('pfRadiusRange', r);
        liveUpdate('pfWidth', w); liveUpdate('pfColor', c); liveUpdate('pfStyle', s); 
        liveUpdate('pfRadius', r); liveUpdate('pfShadow', sh);
    }

   function liveUpdate(key, value) {
        if(isLocked) return; 
        designState[key] = value;
        if(!tvWindow || tvWindow.closed) return;
        const doc = tvWindow.document;
        const root = doc.documentElement;

        // --- ﬁâﬁ®ﬁáﬁ© ﬁáﬁ¶ﬁçﬁ¶ﬁÅﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁÑﬁ¶ﬁáﬁ® (STAR SIZE) ---
        if(key === 'starSize') {
             root.style.setProperty('--star-s', value + 'px');
        }
        // -------------------------------------------
// ﬁìﬁÆﬁïﬁ∞ 5 ﬁìﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ﬁìﬁ∞ ﬁáﬁ¨ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ﬁâﬁ¶ﬁÇﬁ∞ﬁìﬁ∞
        if(key === 't5Align') {
             root.style.setProperty('--t5-align', value);
             
             if(value === 'left') root.style.setProperty('--t5-flex-align', 'flex-start');
             else if(value === 'right') root.style.setProperty('--t5-flex-align', 'flex-end');
             else root.style.setProperty('--t5-flex-align', 'center');
        }
        // BADGE & TROPHY UPDATES
        if(key === 'badgeX') root.style.setProperty('--star-x', value + 'px');
        if(key === 'badgeY') root.style.setProperty('--star-y', value + 'px');
        // BADGE & TROPHY UPDATES
        if(key === 'badgeX') root.style.setProperty('--star-x', value + 'px');
        if(key === 'badgeY') root.style.setProperty('--star-y', value + 'px');
        if(key === 'trophyX') root.style.setProperty('--troph-x', value + 'px');
        if(key === 'trophyY') root.style.setProperty('--troph-y', value + 'px');
        
        if(key === 'badgeAnim') {
            const el = doc.getElementById('royalStar');
            el.className = 'royal-star-badge'; // reset
            if(value !== 'none') el.classList.add('royal-anim-' + value);
        }
        if(key === 'trophyAnim') {
            const el = doc.getElementById('trophyWrap');
            el.className = 'trophy-badge'; // reset
            if(value !== 'none') el.classList.add('royal-anim-' + value);
        }

        // TOP 5 VARIABLES & VIDEO POS
        if(key === 't5CardW') root.style.setProperty('--t5-w', value + (designState.t5Layout==='bottom'?'%':'vw'));
        if(key === 't5CardH') root.style.setProperty('--t5-h', value + (designState.t5Layout==='bottom'?'%':'vh'));
        if(key === 't5Bottom') root.style.setProperty('--t5-b', value + '%');
        if(key === 't5PhotoSize') root.style.setProperty('--t5-p', value + 'px');
        if(key === 't5TextY') root.style.setProperty('--t5-text-y', value + 'px');
        
        if(key === 'tvX') root.style.setProperty('--tv-x', value + '%');
        if(key === 'tvY') root.style.setProperty('--tv-y', value + '%');
        if(key === 'tvW') root.style.setProperty('--tv-w', value + '%');
        if(key === 'tvH') root.style.setProperty('--tv-h', value + '%');
        
        if(key === 't5Layout') {
            const card = doc.getElementById('card');
            card.classList.remove('t5-bottom', 't5-left', 't5-right');
            card.classList.add('t5-' + value);
            liveUpdate('t5CardW', designState.t5CardW);
            liveUpdate('t5CardH', designState.t5CardH);
        }
        
        if(key === 't5NameSize') root.style.setProperty('--t5-n-s', value + 'em');
        if(key === 't5EngSize') root.style.setProperty('--t5-e-s', value + 'em');
        if(key === 't5DetSize') root.style.setProperty('--t5-d-s', value + 'em');

        if(key === 'pfWidth' || key === 'pfColor' || key === 'pfStyle' || key === 'pfRadius' || key === 'pfShadow') {
            const img = doc.getElementById('stuImg');
            if(img) {
                if(key === 'pfShadow') img.style.boxShadow = value;
                else {
                    img.style.borderWidth = designState.pfWidth + 'px';
                    img.style.borderColor = designState.pfColor;
                    img.style.borderStyle = designState.pfStyle;
                    img.style.borderRadius = designState.pfRadius + '%';
                }
            }
        }

        if(key === 'cardW') { const c = doc.getElementById('card'); if(c) { c.style.width = value + 'vw'; if(value>90) c.style.maxWidth='none'; else c.style.maxWidth='1500px'; } }
        if(key === 'cardH') { const c = doc.getElementById('card'); if(c) c.style.height = value + 'vh'; }
        if(key === 'cardX' || key === 'cardY') { 
            const c = doc.getElementById('card'); 
            if(c) c.style.transform = `translate(calc(-50% + ${designState.cardX}px), calc(-50% + ${designState.cardY}px))`; 
        }

        if(key === 'pVis') { const el = doc.querySelector('.photo-col'); if(el) el.style.visibility = (value === 'show') ? 'visible' : 'hidden'; }
        
        if(key === 'lSize') { const logoImg = doc.getElementById('logoImg'); if(logoImg) logoImg.style.height = value + 'px'; }
        if(key === 'bgLoop') { const vid = doc.getElementById('bgVid'); if(vid) vid.style.display = (value === 'on') ? 'block' : 'none'; }
        if(key === 'layoutDir') { const card = doc.getElementById('card'); if(card) card.style.flexDirection = (value === 'rtl') ? 'row-reverse' : 'row'; }
        if(key === 'textAlign') { const txt = doc.querySelector('.text-col'); if(txt) txt.style.textAlign = value; }
        if(key === 'bgPreset') { const bg = doc.getElementById('bgLayer'); if(bg) { bg.className = ''; bg.classList.add(value); } }
        if(key === 'bdColor') { doc.documentElement.style.setProperty('--theme-color', value); }
        
        if(key === 'mtY' || key === 'mtX') doc.getElementById('titleContainer').style.transform = `translate(${designState.mtX}px, ${designState.mtY}px)`;
        if(key === 'mtSize') doc.getElementById('jt1').style.fontSize = value + 'em';
        if(key === 'mtColor') { 
            const el = doc.getElementById('jt1'); el.style.color = value; 
            if(designState.tLine === 'on') el.style.borderBottomColor = value; 
        }
        if(key === 'tLine') {
            const el = doc.getElementById('jt1');
            if(value === 'on') { el.style.borderBottom = '3px solid ' + designState.mtColor; el.style.paddingBottom = '10px'; }
            else { el.style.borderBottom = 'none'; el.style.paddingBottom = '0'; }
        }
        if(key === 'mtAlign') { doc.getElementById('mainTitleWrap').style.textAlign = value; doc.getElementById('jt1').style.textAlign = value; }

        if(key === 'stY') doc.getElementById('subTitleWrap').style.marginTop = value + 'px';
        if(key === 'stGap') doc.getElementById('subTitleWrap').style.gap = value + 'px';
        if(key === 'stAlign') doc.getElementById('subTitleWrap').style.textAlign = value;
        if(key === 'stLine') { updateJalsaText(); }
        
        if(key === 'plSize') doc.querySelectorAll('.pl-img').forEach(el => el.style.height = value + 'px');
        if(key === 'plGap') doc.getElementById('plContainer').style.gap = value + 'px';
        if(key === 'plY') doc.getElementById('plContainer').style.bottom = value + 'px';
        if(key === 'plX') doc.getElementById('plContainer').style.transform = `translateX(${value}px)`;

        if(key === 'tnDColor') doc.getElementById('tnD').style.color = value;
        if(key === 'tnDSize') doc.getElementById('tnD').style.fontSize = value + 'em';
        if(key === 'tnESize') doc.getElementById('tnE').style.fontSize = value + 'em';
        if(key === 'tnEColor') doc.getElementById('tnE').style.color = value;
        
        if(key === 'nLine') {
            const h2 = doc.getElementById('tnE'); 
            if(value === 'on') { h2.style.borderBottom = '2px solid var(--theme-color)'; h2.style.display='inline-block'; }
            else { h2.style.borderBottom = 'none'; }
        }

        if(key === 'tfDSize') { doc.getElementById('tfD').style.fontSize = value + 'em'; doc.getElementById('tfE').style.fontSize = (value*0.8) + 'em'; }
        if(key === 'tfDColor') { doc.getElementById('tfD').style.color = value; doc.getElementById('tfE').style.color = value; }
        if(key === 'tcDSize') { doc.getElementById('tcD').style.fontSize = value + 'em'; doc.getElementById('tcE').style.fontSize = (value*0.8) + 'em'; }
        if(key === 'tcDColor') { doc.getElementById('tcD').style.color = value; doc.getElementById('tcE').style.color = value; }
        
        if(key === 'pSize') { const img = doc.getElementById('stuImg'); if(img) { img.style.width = value+'px'; img.style.height = value+'px'; } }
        if(key === 'pX' || key === 'pY') { const el = doc.querySelector('.photo-col'); if(el) el.style.transform = `translate(${designState.pX}px, ${designState.pY}px)`; }
        if(key === 'pFit') { const img = doc.getElementById('stuImg'); if(img) img.style.objectFit = value; }

        if(key === 'cBorder') {
            const card = doc.getElementById('card');
            if(card) {
                card.className = ''; card.classList.add(value);
                if(document.getElementById('top5ModeCheck').checked) card.classList.add('t5-'+designState.t5Layout);
                
                if(value === 'custom' && customBorderData) {
                    card.style.backgroundImage = `url(${customBorderData})`; card.style.backgroundSize = "100% 100%"; card.style.border = "none"; card.style.boxShadow = "none";
                } else if (value === 'custom_bg' && customCardBgData) {
                    card.style.backgroundImage = `url(${customCardBgData})`; card.style.backgroundSize = "100% 100%"; card.style.border = "none"; card.style.boxShadow = "none";
                } else { card.style.backgroundImage = "none"; }
                
                if(value !== 'b1' && value !== 'b0') card.classList.add('active');
            }
        }
    }

    // --- TV WINDOW ---
    function openTV() {
        tvWindow = window.open('', 'GradTV', 'width=1280,height=720,menubar=no,toolbar=no');
        if(!tvWindow) { alert("Please Allow Popups!"); return; }

        let fontCSS = `url('Fonts/faruuma.ttf') format('truetype')`;
        if (currentFontData) fontCSS = `url('${currentFontData}') format('truetype')`;

       // ============================================================
        // 200 ROYAL THEMES GENERATOR (SORTED BY COLOR)
        // ============================================================
        let cssGen = "";
        
        // Helper to create gradients
        const makeGrad = (c1, c2, type="linear") => {
            return type === "radial" 
                ? `radial-gradient(circle, ${c1}, ${c2})` 
                : `linear-gradient(to bottom right, ${c1}, ${c2})`;
        };

        const themes = [];

        // 1-20: ROYAL GREEN (ﬁùﬁßﬁÄﬁ© ﬁäﬁ¨ﬁÄﬁ®) - Top Priority
        const greens = ['#00281c', '#004d40', '#1b5e20', '#003300', '#2e7d32'];
        for(let i=0; i<20; i++) {
            let c1 = greens[i % greens.length];
            let c2 = i % 2 === 0 ? '#000000' : '#001a12';
            themes.push(makeGrad(c1, c2, i%3===0 ? 'radial' : 'linear'));
        }

        // 21-40: ROYAL BLUE (ﬁùﬁßﬁÄﬁ© ﬁÇﬁ´)
        const blues = ['#001b3d', '#0d47a1', '#002171', '#01579b', '#1a237e'];
        for(let i=0; i<20; i++) {
            let c1 = blues[i % blues.length];
            let c2 = i % 2 === 0 ? '#000000' : '#000022';
            themes.push(makeGrad(c1, c2, i%3===0 ? 'radial' : 'linear'));
        }

        // 41-60: ROYAL RED/MAROON (ﬁùﬁßﬁÄﬁ© ﬁÉﬁ¶ﬁåﬁ∞)
        const reds = ['#b71c1c', '#880e4f', '#4a0000', '#3e2723', '#800000'];
        for(let i=0; i<20; i++) {
            let c1 = reds[i % reds.length];
            let c2 = '#000000';
            themes.push(makeGrad(c1, c2));
        }

        // 61-80: BLACK & GOLD (ﬁçﬁ¶ﬁéﬁ∞ﬁíﬁ¶ﬁÉﬁ© ﬁÜﬁ¶ﬁÖﬁßﬁáﬁ® ﬁÉﬁ¶ﬁÇﬁ∞)
        for(let i=0; i<20; i++) {
            if(i%2===0) themes.push("radial-gradient(circle, #333, #000)");
            else themes.push("linear-gradient(135deg, #000 0%, #434343 100%)");
        }

        // 81-120: PURPLE & MODERN (ﬁíﬁ¶ﬁâﬁßﬁÇﬁ©)
        const purples = ['#4a148c', '#311b92', '#1a0033'];
        for(let i=0; i<40; i++) {
            let c1 = purples[i % purples.length];
            themes.push(makeGrad(c1, '#000'));
        }

        // 121-200: MIXED & ANIMATED STYLES (ﬁáﬁ¨ﬁÄﬁ¨ﬁÇﬁ®ﬁÄﬁ¨ﬁÇﬁ∞)
        const mixed = [
            "linear-gradient(to right, #0f2027, #203a43, #2c5364)",
            "conic-gradient(from 180deg at 50% 50%, #004d40 0deg, #00281c 360deg)",
            "repeating-linear-gradient(45deg, #111, #111 10px, #222 10px, #222 20px)",
            "linear-gradient(to top, #30cfd0 0%, #330867 100%)",
            "radial-gradient(circle at center, #665c00, #000)"
        ];
        for(let i=0; i<80; i++) {
            themes.push(mixed[i % mixed.length]);
        }

        // Generate CSS Classes
        for(let i=0; i<200; i++) {
            cssGen += `.bg${i+1} { background: ${themes[i]}; background-size: cover; }\n`;
        }
// ============================================================
        // 100 ROYAL CARD STYLES (SORTED: GREEN -> BLUE -> GOLD -> MIXED)
        // ============================================================
        const borderStyles = [
            // --- GROUP 1: ROYAL GREEN & GOLD (1-15) ---
            "border: 4px solid #FFD700; background: linear-gradient(to bottom, #00281c, #004d40); box-shadow: 0 0 20px #FFD700; border-radius: 15px;", // 1
            "border-left: 10px solid #FFD700; border-right: 10px solid #FFD700; background: #003322; box-shadow: inset 0 0 30px #000;", // 2
            "border: 6px double #FFD700; background: radial-gradient(circle, #004d40, #00281c); border-radius: 10px;", // 3
            "border: 2px solid #C5A059; outline: 4px solid #004d40; outline-offset: 4px; background: rgba(0, 51, 34, 0.9);", // 4
            "border-top: 5px solid #FFD700; border-bottom: 5px solid #FFD700; background: linear-gradient(to right, #00281c, #004d40, #00281c);", // 5
            "box-shadow: 0 0 0 5px #003322, 0 0 0 8px #FFD700; border-radius: 20px; background: #001a12;", // 6
            "border: 3px solid #FFD700; border-radius: 0 40px 0 40px; background: #00281c; box-shadow: 5px 5px 0 #004d40;", // 7
            "border-image: linear-gradient(to bottom, #FFD700, #004d40, #FFD700) 1; border-width: 5px; border-style: solid; background: rgba(0, 40, 28, 0.8);", // 8
            "border: 1px solid #FFD700; box-shadow: 0 0 15px #004d40, inset 0 0 20px #FFD700; background: #00281c;", // 9
            "border-left: 20px solid #004d40; border-right: 5px solid #FFD700; background: linear-gradient(to right, #001a12, #00281c);", // 10
            "border: 8px groove #C5A059; background: #003322; border-radius: 5px;", // 11
            "border: 2px solid #fff; outline: 2px solid #FFD700; outline-offset: 5px; background: #00281c;", // 12
            "border-top: 10px solid #004d40; border-bottom: 10px solid #FFD700; background: rgba(0,0,0,0.8);", // 13
            "border: 5px solid transparent; background: linear-gradient(#00281c, #00281c) padding-box, linear-gradient(to right, #FFD700, #004d40) border-box;", // 14
            "border: none; background: #00281c; box-shadow: 0 -5px 0 #FFD700, 0 5px 0 #FFD700;", // 15

            // --- GROUP 2: ROYAL BLUE & GOLD (16-30) ---
            "border: 4px solid #FFD700; background: linear-gradient(to bottom, #001b3d, #0d47a1); box-shadow: 0 0 20px #0d47a1; border-radius: 15px;", // 16
            "border-left: 10px solid #C5A059; border-right: 10px solid #C5A059; background: #002171;", // 17
            "border: 5px double #FFD700; background: radial-gradient(circle, #0d47a1, #000022); border-radius: 10px;", // 18
            "border: 2px solid #fff; box-shadow: 0 0 10px #0d47a1, 0 0 20px #FFD700; background: rgba(13, 71, 161, 0.9);", // 19
            "border-top: 6px solid #FFD700; border-bottom: 6px solid #0d47a1; background: #001b3d;", // 20
            "border: 3px solid #FFD700; outline: 2px dashed #0d47a1; outline-offset: 5px; background: #000022;", // 21
            "border-image: linear-gradient(45deg, #FFD700, #0d47a1) 1; border-width: 6px; border-style: solid; background: #001b3d;", // 22
            "border-left: 20px solid #0d47a1; border-right: 2px solid #FFD700; background: linear-gradient(to right, #000, #001b3d);", // 23
            "border: 1px solid rgba(255,255,255,0.3); background: rgba(13, 71, 161, 0.6); backdrop-filter: blur(10px); border-radius: 20px;", // 24
            "box-shadow: 0 0 0 5px #001b3d, 0 0 0 8px #FFD700; border-radius: 0 30px 0 30px; background: #000;", // 25
            "border: 4px solid #FFD700; border-radius: 50px; background: #0d47a1; box-shadow: inset 0 0 20px #000;", // 26
            "border: 10px inset #002171; background: #001b3d;", // 27
            "border-top: 2px solid #FFD700; border-bottom: 2px solid #FFD700; background: linear-gradient(to right, transparent, #0d47a1, transparent);", // 28
            "border: 2px solid #FFD700; box-shadow: 5px 5px 0 #0d47a1; background: #001b3d;", // 29
            "border: none; background: #001b3d; border-bottom: 10px solid #FFD700;", // 30

            // --- GROUP 3: PREMIUM GOLD, RED & MODERN (31-100) ---
            "border: 2px solid #FFD700; box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); background: rgba(0,0,0,0.8); border-radius: 10px;", // 31
            "border: 5px solid #b71c1c; border-radius: 20px; box-shadow: 0 0 15px #b71c1c; background: #220000;", // 32 (Red)
            "border-image: linear-gradient(to right, #bf953f, #fcf6ba, #bf953f) 1; border-width: 4px; border-style: solid; background: #000;", // 33 (Gold Gradient)
            "border: 1px solid #C0C0C0; box-shadow: 0 0 20px #C0C0C0; background: rgba(50,50,50,0.8);", // 34 (Silver)
            "border-left: 15px solid #FFD700; background: linear-gradient(to right, rgba(255,215,0,0.2), rgba(0,0,0,0.8));", // 35
            "border: 4px double #fff; outline: 2px solid #FFD700; outline-offset: 3px; background: #111;", // 36
            "border: 2px dashed #FFD700; border-radius: 15px; box-shadow: 0 0 10px #FFD700; background: rgba(0,0,0,0.7);", // 37
            "border-top: 10px solid #b71c1c; border-bottom: 10px solid #b71c1c; background: #000;", // 38
            "border: 8px solid transparent; border-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png') 30 stretch; background: #221; box-shadow: 0 0 10px #000;", // 39
            "border: 3px solid var(--theme-color); border-radius: 50px 0 50px 0; background: rgba(0,0,0,0.8);", // 40
            "border-right: 20px solid var(--theme-color); border-radius: 20px; background: rgba(0,0,0,0.8);", // 41
            "border: 1px solid #fff; box-shadow: 0 0 15px var(--theme-color), inset 0 0 15px var(--theme-color); border-radius: 10px; background: #000;", // 42
            "border: 6px solid #B8860B; border-style: ridge; border-radius: 5px; background: #1a1a00;", // 43
            "border: none; background: linear-gradient(45deg, #111 25%, #222 25%, #222 50%, #111 50%, #111 75%, #222 75%); background-size: 20px 20px; border: 2px solid #555;", // 44
            "border: 2px solid #FFD700; box-shadow: 0 10px 30px rgba(0,0,0,0.8); transform: perspective(500px) rotateX(2deg); background: rgba(0,0,0,0.9);", // 45
            "border: 10px solid rgba(255,255,255,0.1); border-radius: 30px; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); backdrop-filter: blur(5px);", // 46
            "border-left: 5px solid #FFD700; border-right: 5px solid #FFD700; transform: skew(-10deg); background: #000;", // 47
            "border: 1px solid #FFD700; outline: 1px solid #FFD700; outline-offset: 5px; background: #111;", // 48
            "border: 5px solid #fff; border-radius: 0 30px 0 30px; box-shadow: 5px 5px 0 var(--theme-color); background: #000;", // 49
            "background: radial-gradient(circle, #333, #000); border: 4px solid #555;", // 50
            // --- 51-100: MIXED & RESTORED CLASSICS ---
            "border:none; box-shadow:0 0 50px #000; background: rgba(0,0,0,0.6);", // 51
            "border: 4px dashed var(--theme-color); box-shadow: 0 0 20px var(--theme-color); border-radius: 20px; background: #000;", // 52
            "border: 15px solid var(--theme-color); border-radius: 10px; background: #000;", // 53
            "outline: 4px solid var(--theme-color); outline-offset: 10px; border: 2px solid var(--theme-color); margin: 15px; background: #000;", // 54
            "border-top: 5px double var(--theme-color); border-bottom: 5px double var(--theme-color); background: rgba(0,0,0,0.8);", // 55
            "border: 1px solid var(--theme-color); padding: 5px; outline: 1px solid var(--theme-color); background: #000;", // 56
            "border-bottom: 3px solid var(--theme-color); border-top: 3px solid var(--theme-color); background: rgba(0,0,0,0.9);", // 57
            "background: radial-gradient(circle at top left, transparent 30px, #111 31px); border: 2px solid var(--theme-color);", // 58
            "border: 10px groove var(--theme-color); background: #222;", // 59
            "border: 30px solid rgba(255,255,255,0.05); background: #000;", // 60
            "border-image: linear-gradient(to right, var(--theme-color), transparent) 1; border-bottom: 5px solid; background: #000;", // 61
            "border-left: 15px solid var(--theme-color); background: rgba(0,0,0,0.3);", // 62
            "border: 1px solid var(--theme-color); box-shadow: 10px 10px 0 var(--theme-color); background: #111;", // 63
            "border: 2px solid var(--theme-color); outline: 2px dashed #fff; outline-offset: -10px; background: #000;", // 64
            "border-top: 2px solid var(--theme-color); border-bottom: 2px solid var(--theme-color); background: linear-gradient(to right, transparent, rgba(255,255,255,0.1), transparent);", // 65
            "border: 8px solid var(--theme-color); border-radius: 0 40px 0 40px; background: #000;", // 66
            "border-right: 10px solid var(--theme-color); border-bottom: 10px solid var(--theme-color); border-radius: 0 0 20px 0; background: #111;", // 67
            "border: 1px solid var(--theme-color); background: repeating-linear-gradient(45deg, #000, #000 10px, #111 10px, #111 20px);", // 68
            "border: 10px inset var(--theme-color); background: #222;", // 69
            "border: 10px outset var(--theme-color); background: #222;", // 70
            "border-top: 20px solid var(--theme-color); border-radius: 20px 20px 0 0; background: #000;", // 71
            "border-bottom: 20px solid var(--theme-color); border-radius: 0 0 20px 20px; background: #000;", // 72
            "border: 2px solid var(--theme-color); box-shadow: 5px 5px 0 #fff, 10px 10px 0 var(--theme-color); background: #000;", // 73
            "background: linear-gradient(to bottom right, rgba(255,255,255,0.2), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.3); border-radius: 15px;", // 74
            "border-left: 5px solid var(--theme-color); border-right: 5px solid var(--theme-color); transform: skew(-10deg); background: #000;", // 75
            "border: 20px solid transparent; border-image: linear-gradient(to bottom, var(--theme-color), #000) 1; background: #111;", // 76
            "box-shadow: 0 -10px 20px rgba(0,0,0,0.5); border-top: 2px solid var(--theme-color); background: rgba(0,0,0,0.8);", // 77
            "border: 1px solid var(--theme-color); outline: 1px solid var(--theme-color); outline-offset: 5px; background: #000;", // 78
            "border: 6px solid var(--theme-color); border-radius: 20px; box-shadow: 0 0 0 5px #000, 0 0 0 10px var(--theme-color); background: #000;", // 79
            "border: none; background: linear-gradient(to right, transparent, rgba(212,175,55,0.2), transparent);", // 80
            "border: 2px solid #FFD700; box-shadow: 0 0 20px #FFD700; background: linear-gradient(to bottom, #111, #222);", // 81
            "border: 5px solid #C0C0C0; border-radius: 10px; box-shadow: inset 0 0 30px #C0C0C0; background: #000;", // 82
            "border-image: linear-gradient(to right, #bf953f, #fcf6ba, #bf953f) 1; border-width: 4px; border-style: solid; background: #000;", // 83
            "border: 1px solid rgba(255,215,0,0.5); box-shadow: 0 0 15px rgba(255,215,0,0.3); background: rgba(0,0,0,0.9);", // 84
            "border-left: 10px solid #FFD700; border-right: 10px solid #FFD700; border-radius: 20px; background: #111;", // 85
            "border: 3px double #FFD700; outline: 1px solid #FFD700; outline-offset: 5px; background: #000;", // 86
            "border: 2px solid #00d2ff; box-shadow: 0 0 20px #00d2ff; background: #000;", // 87
            "border-top: 1px solid #FFD700; border-bottom: 1px solid #FFD700; background: linear-gradient(to right, transparent, #000, transparent);", // 88
            "border: 6px solid #B8860B; border-style: double; border-radius: 15px; background: #000;", // 89
            "box-shadow: 0 0 0 5px #000, 0 0 0 8px #FFD700; border-radius: 10px; background: #111;", // 90
            "border: 2px solid #E5E4E2; box-shadow: 0 0 25px rgba(229, 228, 226, 0.4); background: #000;", // 91
            "border-image: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000) 1; border-width: 5px; border-style: solid; background: #000;", // 92
            "border-bottom: 10px solid #FFD700; border-radius: 0 0 15px 15px; background: #111;", // 93
            "border: 5px solid #FFD700; outline: 5px solid #000; outline-offset: -10px; background: #000;", // 94
            "border: 2px dashed #fff; background: rgba(0,0,0,0.6); box-shadow: 0 0 0 10px rgba(255,255,255,0.1);", // 95
            "border-left: 20px solid #800000; background: linear-gradient(to right, #300000, #000);", // 96
            "border: 2px solid var(--theme-color); border-radius: 50px; box-shadow: inset 0 0 30px #000; background: #000;", // 97
            "border-top: 5px solid #FFD700; border-bottom: 5px solid #FFD700; transform: skewX(-15deg); background: #111;", // 98
            "border: 1px solid #C0C0C0; box-shadow: 0 0 10px #C0C0C0, inset 0 0 10px #C0C0C0; background: #000;", // 99
            "background: linear-gradient(to right, #8a2387, #e94057, #f27121); padding: 5px; border-radius: 15px;" // 100
        ];

        // 2. Loop through 100 items (FIXED)
        for(let i=0; i<100; i++) { 
            let style = borderStyles[i] ? borderStyles[i] : borderStyles[0];
            cssGen += `.b${i+1} { ${style} }\n`; 
        }

        const html = `
        <!DOCTYPE html>
        <html lang="dv" dir="rtl">
        <head>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
                @font-face { font-family: 'Faruuma'; src: ${fontCSS}; }
                :root { 
                    --theme-color: ${designState.bdColor}; --royal-accent: #c5a059; 
                    /* TOP 5 VARIABLES */
                    --t5-w: ${designState.t5CardW}${designState.t5Layout==='bottom'?'%':'vw'}; 
                    --t5-h: ${designState.t5CardH}${designState.t5Layout==='bottom'?'%':'vh'}; 
                    --t5-b: ${designState.t5Bottom}%; --t5-p: ${designState.t5PhotoSize}px;
                    --t5-n-s: ${designState.t5NameSize}em; --t5-e-s: ${designState.t5EngSize}em; --t5-d-s: ${designState.t5DetSize}em;
                    /* TEXT POSITION FIX */
                    --t5-text-y: ${designState.t5TextY}px;
                    /* VIDEO BOX VARIABLES */
                    --tv-x: ${designState.tvX}%; --tv-y: ${designState.tvY}%;
                    --tv-w: ${designState.tvW}%; --tv-h: ${designState.tvH}%;
                    /* BADGE VARIABLES */
                    --star-x: ${designState.badgeX}px; --star-y: ${designState.badgeY}px;
                    --troph-x: ${designState.trophyX}px; --troph-y: ${designState.trophyY}px;
                }
                body, h1, h2, div, span { font-family: 'Faruuma', 'MV Boli', 'Noto Sans Thaana', serif !important; }
                body { margin:0; overflow:hidden; background:#000; user-select:none; }
                #fsBtn { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:9999; padding:20px; font-size:20px; cursor:pointer; background:var(--theme-color); border:2px solid #fff; }
                
                #bgLayer { position:fixed; top:0; left:0; width:100%; height:100%; z-index:0; transition: background 0.5s ease; }
                ${cssGen}

                #jalsaContent { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10; transition: opacity 0.8s ease; opacity:1; }
                #jalsaContent.hidden { opacity: 0; pointer-events:none; visibility: hidden; }
                
                #titleContainer { width: 90%; max-width: 1600px; text-align: center; } 
                #mainTitleWrap { width: 100%; text-align: ${designState.mtAlign}; } 
                #subTitleWrap { width: 100%; text-align: ${designState.stAlign}; display:flex; flex-direction:column; gap:${designState.stGap}px; } 

                .jalsa-text { direction: rtl; display:block; width:100%; }
                .main-title { font-size: ${designState.mtSize}em; color: ${designState.mtColor}; text-shadow: 2px 2px 10px black; margin-bottom: 20px; border-bottom: 3px solid ${designState.mtColor}; padding-bottom:10px; }
                .sub-title { font-size: ${designState.stSize}em; color: ${designState.stColor}; text-shadow: 1px 1px 5px black; margin: 0; line-height:1.2; }
                .sub-title:empty { display:none; }

                #mainLogosContainer { 
                    position:absolute; top:50%; left:50%; width:0; height:0; z-index:20; 
                    transition: opacity 0.5s ease;
                }
                .main-logo-img { position:absolute; transform:translate(-50%, -50%); object-fit:contain; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5)); transition: all 0.3s ease; }
                
                #plContainer { 
                    position:absolute; bottom:${designState.plY}px; width:100%; 
                    display:flex; justify-content:center; gap:${designState.plGap}px; z-index:25; padding:0 20px; flex-wrap:wrap; 
                    transition: opacity 0.1s linear; 
                    transform: translateX(${designState.plX}px);
                }
                .pl-img { height:${designState.plSize}px; object-fit:contain; filter:drop-shadow(0 2px 5px #000); transition:all 0.3s; }

                #card { 
                    position:absolute; top:54%; left:50%; transform:translate(-50%,-50%); 
                    width:${designState.cardW}vw; 
                    height:${designState.cardH}vh; 
                    max-width: ${designState.cardW > 90 ? 'none' : '1500px'};
                    display:flex; flex-direction:${designState.layoutDir === 'rtl' ? 'row-reverse' : 'row'}; 
                    align-items:center; background:rgba(0,20,15,0.92); padding:3vh; box-sizing:border-box; 
                    opacity:0; transition:all 0.5s ease; z-index:5001; 
                }
                #card.active { opacity:1; }

                .b0 { border: none; background: transparent !important; box-shadow: none; }
                .custom { border: none !important; box-shadow: none !important; }

                .font-dv { font-family: 'Faruuma', 'MV Boli', 'Noto Sans Thaana', serif; }
                .font-en { font-family: 'Times New Roman', serif; direction:ltr; }
                h1 { font-size: 5em; margin:0; color:#fff; line-height:1.1; }
                h2 { font-size: 3em; margin:10px 0; color:var(--theme-color); text-transform:uppercase; border-bottom:2px solid var(--theme-color); display:inline-block; width:100%; text-align:inherit; }
                .fac-dv { font-size: 2em; color:#fff9c4; margin-top:10px; }
                .fac-en { font-size: 1.6em; color:#fff9c4; font-weight:bold; margin-bottom:5px; text-align:inherit; }
                .crs-dv { font-size: 2.5em; color:#fff9c4; font-weight:bold; }
                .crs-en { font-size: 2em; color:#fff9c4; font-style:italic; margin-bottom:20px; text-align:inherit; }
                .comm { background:rgba(212,175,55,0.15); border:2px solid var(--theme-color); padding:20px; font-size:2.2em; color:white; border-radius:10px; text-align:center; width:100%; box-sizing:border-box; transition: all 0.3s ease; }
                .comm-tiny { padding: 0 !important; height: 3px !important; min-height: 0 !important; overflow: hidden; border:none !important; background: var(--theme-color); opacity: 0.6; margin-top:20px; }

                .photo-col { position:relative; flex:0 0 auto; min-width: 200px; display:flex; justify-content:center; align-items:center; transform:translate(${designState.pX}px, ${designState.pY}px); transition: transform 0.2s ease; height: 100%; }
                .shrink-photo img { width: 8px !important; height: 8px !important; min-width: 0 !important; min-height: 0 !important; border-radius: 50% !important; border: none !important; box-shadow: 0 0 5px var(--theme-color) !important; background: var(--theme-color); padding: 0 !important; }
                
                #stuImg { 
                    width:${designState.pSize}px; 
                    height:${designState.pSize}px; 
                    object-fit:${designState.pFit}; 
                    background:#000; 
                    transition: all 0.3s ease;
                    border-width: ${designState.pfWidth}px;
                    border-style: ${designState.pfStyle};
                    border-color: ${designState.pfColor};
                    border-radius: ${designState.pfRadius}%;
                    box-shadow: ${designState.pfShadow};
                }

                /* ANIMATIONS */
                @keyframes royalSpin { 100% { transform: translate(var(--star-x), var(--star-y)) rotate(360deg); } }
                @keyframes royalPulse { 0% { transform: translate(var(--star-x), var(--star-y)) scale(1); } 50% { transform: translate(var(--star-x), var(--star-y)) scale(1.1); } 100% { transform: translate(var(--star-x), var(--star-y)) scale(1); } }
                @keyframes royalFloat { 0%, 100% { transform: translate(var(--star-x), var(--star-y)); } 50% { transform: translate(var(--star-x), calc(var(--star-y) - 10px)); } }
                
                @keyframes trophyPulse { 0% { transform: translate(var(--troph-x), var(--troph-y)) scale(1); } 50% { transform: translate(var(--troph-x), var(--troph-y)) scale(1.05); } 100% { transform: translate(var(--troph-x), var(--troph-y)) scale(1); } }
                @keyframes trophyShine { 0% { filter: brightness(1); transform: translate(var(--troph-x), var(--troph-y)); } 50% { filter: brightness(1.3); transform: translate(var(--troph-x), var(--troph-y)); } 100% { filter: brightness(1); transform: translate(var(--troph-x), var(--troph-y)); } }
                @keyframes trophyZoom { 0% { transform: translate(var(--troph-x), var(--troph-y)) scale(0); opacity:0; } 80% { transform: translate(var(--troph-x), var(--troph-y)) scale(1.1); opacity:1; } 100% { transform: translate(var(--troph-x), var(--troph-y)) scale(1); opacity:1; } }

                /* BADGES */
                .royal-star-badge {
                    position: absolute; top: 0; left: 0; width: 80px; z-index: 10;
                    display: none; 
                    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
                    transform: translate(var(--star-x), var(--star-y)); 
                }
                .royal-anim-spin { animation: royalSpin 5s linear infinite; }
                .royal-anim-pulse { animation: royalPulse 2s ease-in-out infinite; }
                .royal-anim-float { animation: royalFloat 3s ease-in-out infinite; }

                .trophy-badge {
                    position: absolute; bottom: 0; right: 0; z-index: 10;
                    display: none; 
                    align-items: center; background: linear-gradient(45deg, #FFD700, #ffb300);
                    border: 3px solid #fff; border-radius: 50px; padding: 5px 15px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
                    transform: translate(var(--troph-x), var(--troph-y)); 
                }
                .royal-anim-shine { animation: trophyShine 2s infinite; }
                .royal-anim-pulse { animation: trophyPulse 2s infinite; }
                .royal-anim-zoom { animation: trophyZoom 0.8s ease-out forwards; }

                .trophy-badge img { height: 40px; margin-right: 5px; }
                .rank-num { font-size: 30px; font-weight: 900; color: #3e2723; font-family: 'Times New Roman', serif; }

                .text-col { flex:1; text-align:${designState.textAlign}; padding:0 30px; color:white; display:flex; flex-direction:column; justify-content:center; }
                
                /* VIDEO & ADS LAYERS */
                #videoLayer { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:5500; display:none; justify-content:center; align-items:center; transition: all 0.5s ease; }
                #videoLayer video, #videoLayer iframe { width:100%; height:100%; border:none; }
                
                #adLayer { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:6000; display:none; justify-content:center; align-items:center; }
                #adImg, #adVid { width:100%; height:100%; object-fit:contain; position:absolute; top:0; left:0; }

                /* OVERLAY MODE FOR VIDEO */
                .overlay-mode #card { 
                    width:auto !important; height:auto !important; 
                    bottom:30px !important; top:auto !important; transform:translate(-50%, 0) !important;
                    background:rgba(0,0,0,0.8) !important; border-radius:15px; padding:15px 30px !important; 
                    border:1px solid #fff !important; 
                }
                .overlay-mode .photo-col { min-width:0 !important; margin-left:20px; }
                .overlay-mode #stuImg { width:120px !important; height:120px !important; }
                .overlay-mode h1 { font-size:2.5em !important; }
                .overlay-mode h2 { font-size:1.8em !important; }
                .overlay-mode .fac-dv, .overlay-mode .crs-dv, .overlay-mode .comm { display:none; }

                /* --- TOP 5 BANNER MODE (Royal Edition) --- */
                .top5-mode #titleContainer { display: none !important; }
                
                .top5-mode #videoLayer {
                    top: var(--tv-y); 
                    left: var(--tv-x);
                    width: var(--tv-w);
                    height: var(--tv-h); 
                    border: 4px solid var(--royal-accent);
                    box-shadow: 0 0 50px rgba(197, 160, 89, 0.6);
                    background: #000;
                    border-radius: 15px;
                    z-index: 5500;
                    position: absolute; 
                    overflow: hidden; 
                }

                .top5-mode #card {
                    max-width: none !important;
                    background: rgba(0,20,15,0.95);
                    border: none; 
                    box-shadow: 0 0 30px rgba(0,0,0,0.5);
                    z-index: 6000 !important;
                    transition: all 0.5s ease;
                }

                /* T5 BOTTOM LAYOUT */
                /* --- T5 FINAL FIX: Layout & Photo Force --- */
/* --- T5 STAR MODE & ALIGNMENT FIX --- */
/* --- T5 FINAL SUPER FIX: STAR VISIBILITY --- */
.top5-mode #card.t5-bottom {
    width: 95vw !important;
    height: 22vh !important;
    bottom: 40px !important;
    top: auto !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    
    /* Layout */
    flex-direction: row !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 0 !important;

    /* Design */
    background: linear-gradient(90deg, rgba(0,10,5,0.95) 0%, rgba(0,30,50,0.95) 100%);
    border: 3px solid var(--royal-accent);
    border-radius: 15px;
    box-shadow: 0 10px 50px rgba(0,0,0,0.9);
    padding: 0 40px !important;
    z-index: 6000 !important;
    overflow: visible !important; /* Allow Star to go outside */
}

/* 1. HIDE PHOTO, BUT KEEP CONTAINER ALIVE FOR STAR */
.top5-mode .photo-col {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    width: 0 !important;       /* No Width */
    height: 0 !important;      /* No Height */
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    overflow: visible !important; /* CRITICAL: Let Star show outside */
    transform: none !important;
    position: absolute !important; /* Take out of flow */
    top: 50% !important;
    left: 50% !important;
}

/* 2. COMPLETELY HIDE STUDENT IMAGE */
.top5-mode #stuImg { display: none !important; }

/* 3. FORCE SHOW STAR (ON TOP OF EVERYTHING) */
/* 3. FORCE SHOW STAR (UPDATED SIZE FIX) */
/* 3. FORCE SHOW STAR (ANIMATION FIXED) */
.top5-mode #royalStar {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: absolute !important;
    top: 0 !important; 
    left: 0 !important;
    
    /* Default Size */
    width: var(--star-s, 200px) !important;
    height: auto !important;
    min-width: 50px !important;
    
    /* Position */
    transform: translate(var(--star-x), var(--star-y)) !important;
    
    z-index: 9999 !important;
    
    /* ﬁÇﬁØﬁìﬁ∞: ﬁâﬁ®ﬁåﬁ¶ﬁÇﬁ™ﬁÇﬁ∞ ﬁáﬁ¨ﬁÇﬁ®ﬁâﬁ≠ﬁùﬁ¶ﬁÇﬁ∞ ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ ﬁàﬁ¶ﬁÇﬁ© ﬁÇﬁ¶ﬁéﬁßﬁäﬁ¶ﬁáﬁ®. 
       ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞ ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞ﬁéﬁ¨ ﬁëﬁ∞ﬁÉﬁÆﬁïﬁ∞ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ ﬁâﬁ¶ﬁêﬁ¶ﬁáﬁ∞ﬁÜﬁ¶ﬁåﬁ∞ ﬁÜﬁ™ﬁÉﬁßﬁÇﬁ¨. */
}

/* 4. Text Styling & Alignment Control */
.top5-mode .text-col {
    width: 100% !important;
    text-align: var(--t5-align, center) !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: var(--t5-flex-align, center) !important;
    justify-content: center !important;
    padding: 0 !important;
    z-index: 6005 !important;
}

.top5-mode h1 { font-size: 3em !important; margin: 0 !important; line-height: 1.2 !important; }
.top5-mode h2 { font-size: 2em !important; color: #ffd54f !important; border: none !important; margin-top: 5px !important; }
.top5-mode .fac-dv, .top5-mode .crs-dv, .top5-mode .comm { display: none !important; }
                /* T5 LEFT SIDEBAR LAYOUT */
                .top5-mode #card.t5-left {
                    width: var(--t5-w) !important; height: 100vh !important;
                    top: 0 !important; left: 0 !important; bottom: auto !important;
                    transform: none !important;
                    flex-direction: column !important;
                    justify-content: center;
                    border-right: 4px solid var(--theme-color);
                }

                /* T5 RIGHT SIDEBAR LAYOUT */
                .top5-mode #card.t5-right {
                    width: var(--t5-w) !important; height: 100vh !important;
                    top: 0 !important; right: 0 !important; bottom: auto !important; left: auto !important;
                    transform: none !important;
                    flex-direction: column !important;
                    justify-content: center;
                    border-left: 4px solid var(--theme-color);
                }
                
                /* FIX: Text Y Position within Top 5 Card */
                .top5-mode .text-col {
                    text-align: center !important;
                    transform: translateY(var(--t5-text-y)) !important;
                }
                .top5-mode #card.t5-bottom .text-col { text-align: right !important; }

                .top5-mode .photo-col {
                    transform: none !important;
                    margin: 10px;
                }
                .top5-mode #stuImg {
                    width: var(--t5-p) !important; height: var(--t5-p) !important;
                    object-fit: cover !important; 
                }
                
                .top5-mode h1 { font-size: var(--t5-n-s) !important; }
                .top5-mode h2 { font-size: var(--t5-e-s) !important; margin: 5px 0 !important; }
                .top5-mode .fac-dv, .top5-mode .crs-dv { font-size: var(--t5-d-s) !important; }

                .copyright { position:absolute; bottom:10px; right:10px; font-size:10px; color:rgba(255,255,255,0.3); font-family:sans-serif; z-index:900; }
                #activateOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; font-family:sans-serif; text-align:center; cursor:pointer; }
                /* === 3-SCREEN SETUP (840px - 3360px - 840px) === */
.screen-zone {
    position: fixed; top: 0; height: 100%;
    /* 840px / 5040px = 16.666% */
    width: 16.666%; 
    background-size: cover; background-position: center;
    z-index: 6000; display: none;
    align-items: center; justify-content: center;
    background-color: #000;
}
#zoneLeft { left: 0; border-right: 2px solid rgba(255,255,255,0.2); }
#zoneRight { right: 0; border-left: 2px solid rgba(255,255,255,0.2); }

body.triple-active #zoneLeft, body.triple-active #zoneRight { display: flex; }

body.triple-active #card {
    left: 50% !important; transform: translate(-50%, -50%) !important;
    max-width: 60vw !important;
}
.zone-img { width: 100%; height: 100%; object-fit: fill; }
/* --- TOP 5 BANNER MODE (RESTORED) --- */

/* 1. Hide Main Titles in Top 5 */
.top5-mode #titleContainer { display: none !important; }

/* 2. Video Box Positioning */
.top5-mode #videoLayer {
    top: var(--tv-y); 
    left: var(--tv-x);
    width: var(--tv-w); 
    height: var(--tv-h); 
    border: 4px solid var(--royal-accent);
    box-shadow: 0 0 50px rgba(197, 160, 89, 0.6);
    background: #000;
    border-radius: 15px;
    z-index: 5500;
    position: absolute; 
    overflow: hidden; 
}

/* 3. Card Styling for Top 5 */
.top5-mode #card {
    max-width: none !important;
    background: rgba(0,20,15,0.95);
    border: none; 
    box-shadow: 0 0 30px rgba(0,0,0,0.5);
    z-index: 6000 !important;
    transition: all 0.5s ease;
}

/* 4. Layouts (Bottom/Left/Right) */
.top5-mode #card.t5-bottom {
    width: var(--t5-w) !important; height: var(--t5-h) !important;
    bottom: var(--t5-b) !important; top: auto !important;
    left: 50% !important; transform: translateX(-50%) !important;
    flex-direction: row-reverse !important;
    border-top: 4px solid var(--theme-color);
}

.top5-mode #card.t5-left {
    width: var(--t5-w) !important; height: 100vh !important;
    top: 0 !important; left: 0 !important; bottom: auto !important;
    transform: none !important;
    flex-direction: column !important;
    justify-content: center;
    border-right: 4px solid var(--theme-color);
}

.top5-mode #card.t5-right {
    width: var(--t5-w) !important; height: 100vh !important;
    top: 0 !important; right: 0 !important; bottom: auto !important; left: auto !important;
    transform: none !important;
    flex-direction: column !important;
    justify-content: center;
    border-left: 4px solid var(--theme-color);
}

/* 5. Text & Photo Fixing */
.top5-mode .text-col {
    text-align: center !important;
    transform: translateY(var(--t5-text-y)) !important;
}
.top5-mode #card.t5-bottom .text-col { text-align: right !important; }

.top5-mode .photo-col {
    transform: none !important;
    margin: 10px;
}
.top5-mode #stuImg {
    width: var(--t5-p) !important; height: var(--t5-p) !important;
    object-fit: cover !important; 
}

/* 6. Font Sizes */
.top5-mode h1 { font-size: var(--t5-n-s) !important; }
.top5-mode h2 { font-size: var(--t5-e-s) !important; margin: 5px 0 !important; }
.top5-mode .fac-dv, .top5-mode .crs-dv { font-size: var(--t5-d-s) !important; }
            </style>
            <script>function goFS(btn){document.documentElement.requestFullscreen(); btn.style.display='none';}<\/script>
        </head>
        <body>
        <body>
    <div id="zoneLeft" class="screen-zone"></div>
    <div id="zoneRight" class="screen-zone"></div>

    <div id="activateOverlay" onclick="this.style.display='none'">
        <h1 style="font-size:50px;">CLICK HERE TO ACTIVATE SCREEN</h1>
        <p>This is required for Audio/Video to play automatically.</p>
    </div>

    <button id="fsBtn" onclick="goFS(this)">‚õ∂ FULL SCREEN</button>
    
    <div id="adLayer">
        <img id="adImg" style="display:none;">
        <video id="adVid" style="display:none;" muted autoplay></video>
    </div>
    
    <div id="videoLayer"></div>
    
    <div id="bgLayer" class="${designState.bgPreset}"></div>
    <div id="mainLogosContainer"></div>
    <div id="plContainer"></div>

    <div id="jalsaContent">
        <div id="titleContainer" style="margin-top:${designState.mtY}px;"> 
            <div id="mainTitleWrap"><div id="jt1" class="main-title jalsa-text"></div></div>
            <div id="subTitleWrap">
                <div id="jt2" class="sub-title jalsa-text"></div>
                <div id="jt3" class="sub-title jalsa-text"></div>
                <div id="jt4" class="sub-title jalsa-text"></div>
                <div id="jt5" class="sub-title jalsa-text"></div>
                <div id="jt6" class="sub-title jalsa-text"></div>
                <div id="jt7" class="sub-title jalsa-text"></div>
                <div id="jt8" class="sub-title jalsa-text"></div>
            </div>
        </div>
    </div>

    <div id="card" class="${designState.cBorder}">
        <div class="photo-col">
            <img id="stuImg" src="">
            <img id="royalStar" class="royal-star-badge" src="">
            <div id="trophyWrap" class="trophy-badge">
                <img id="trophyImg" src="">
                <span id="rankNum" class="rank-num"></span>
            </div>
        </div>
        <div class="text-col">
            <h1 id="tnD" class="font-dv"></h1><h2 id="tnE" class="font-en"></h2>
            <div id="tfD" class="fac-dv font-dv"></div><div id="tfE" class="fac-en font-en"></div>
            <div id="tcD" class="crs-dv font-dv"></div><div id="tcE" class="crs-en font-en"></div>
            <div id="tcm" class="comm font-dv"></div>
        </div>
    </div>
    <div class="copyright">¬© Ali Ibrahim Didi (7791550)</div>
</body>
        </html>`;

        tvWindow.document.write(html);
        tvWindow.document.close();

        renderMainLogos(); 
        updateJalsaBackground();
        updatePartnerLogos();
        
        // FIX: Force update title and layout after a short delay
        setTimeout(() => {
            updateJalsaText();
            for (const key in designState) { liveUpdate(key, designState[key]); }
        }, 500);

        document.getElementById('connStatus').innerText = "‚úÖ ONLINE";
        document.getElementById('connStatus').style.color = "#00e676";
        document.getElementById('connStatus').style.background = "rgba(0,0,0,0.8)";
    }

    // --- LOGIC ---
    function updateJalsaBackground() {
        if(!tvWindow || tvWindow.closed || !currentJalsaBgData) return;
        const bgDiv = tvWindow.document.getElementById('bgLayer');
        if(currentJalsaBgType === 'video') {
            bgDiv.innerHTML = `<video id="bgVid" src="${currentJalsaBgData}" autoplay loop muted style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; z-index:-1;"></video>`;
            setTimeout(() => { const v = tvWindow.document.getElementById('bgVid'); if(v) v.play().catch(e=>{}); }, 500);
        } else if (currentJalsaBgType === 'image') {
            bgDiv.innerHTML = `<img src="${currentJalsaBgData}" style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; z-index:-1;">`;
        }
    }

    function forceShowTitles() {
        if(!tvWindow || tvWindow.closed) return;
        updateJalsaText();
        tvWindow.document.getElementById('jalsaContent').classList.remove('hidden');
        tvWindow.document.getElementById('card').classList.remove('active');
        tvWindow.document.body.classList.remove('overlay-mode', 'top5-mode');
    }

    // --- NEW NAVIGATION FUNCTIONS ---
    function forceStudentCard() {
        switchListMode('general');
        updateTV();
    }

    function forceTop5() {
        switchListMode('top5');
        updateTV();
    }

    function updateJalsaText() {
        if(!tvWindow || tvWindow.closed) return;
        const doc = tvWindow.document;
        doc.getElementById('jt1').innerText = document.getElementById('jLine1').value;
        
        for(let i=2; i<=8; i++) {
             let txt = document.getElementById('jLine'+i).value;
             let el = doc.getElementById('jt'+i);
             el.innerText = txt;
             if(stStyles[i-1]) {
                 el.style.fontSize = stStyles[i-1].size + 'em';
                 el.style.color = stStyles[i-1].color;
             }
             if(designState.stLine === 'on') {
                 el.style.borderBottom = `2px solid ${stStyles[i-1].color}`;
                 el.style.display = 'inline-block';
             } else {
                 el.style.borderBottom = 'none';
                 el.style.display = 'block';
             }
        }
        
        if(currentFontData) {
             const style = doc.createElement('style');
             style.innerHTML = `@font-face { font-family: 'Faruuma'; src: url('${currentFontData}') format('truetype'); } .jalsa-text, .font-dv { font-family: 'Faruuma', 'Amiri', serif !important; }`;
             doc.head.appendChild(style);
        }
    }

    function showJalsaScreen() {
        if(!tvWindow || tvWindow.closed) return;
        tvWindow.document.getElementById('card').classList.remove('active');
        const jContent = tvWindow.document.getElementById('jalsaContent');
        jContent.classList.remove('hidden');
        jContent.style.opacity = '1'; 
        jContent.style.display = 'flex'; 
        
        const mainLogoContainer = tvWindow.document.getElementById('mainLogosContainer');
        if(designState.logoVisible) mainLogoContainer.style.opacity = '1';
        
        if(designState.plVisible) {
             tvWindow.document.getElementById('plContainer').style.opacity = '1';
        }
        
        document.getElementById('statusMsg').innerText = "MODE: Jalsa Titles";
        lastActiveState = 'title'; 
    }

    function updateTV() {
        if(!tvWindow || tvWindow.closed) { alert("TV Closed!"); return; }
        stopAds();
        
        if(!designState.keepTitle) {
            tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
        } else {
            tvWindow.document.getElementById('jalsaContent').classList.remove('hidden');
        }
        
        const mainLogoContainer = tvWindow.document.getElementById('mainLogosContainer');
        if(designState.logoAutoHide) mainLogoContainer.style.opacity = '0';
        
        const plContainer = tvWindow.document.getElementById('plContainer');
        if(designState.plAutoHide) plContainer.style.opacity = '0';

        const doc = tvWindow.document;
        doc.getElementById('tnD').textContent = document.getElementById('nD').value;
        doc.getElementById('tnE').textContent = document.getElementById('nE').value;
        doc.getElementById('tfD').textContent = document.getElementById('fD').value;
        doc.getElementById('tfE').textContent = document.getElementById('fE').value;
        doc.getElementById('tcD').textContent = document.getElementById('cD').value;
        doc.getElementById('tcE').textContent = document.getElementById('cE').value;
        
        const cmText = document.getElementById('cm').value;
        const commBox = doc.getElementById('tcm');
        if(!cmText || cmText.trim() === "") {
            commBox.textContent = "";
            commBox.classList.add('comm-tiny');
        } else {
            commBox.textContent = cmText;
            commBox.classList.remove('comm-tiny');
        }

        const img = doc.getElementById('stuImg');
        const pCol = doc.querySelector('.photo-col');
        
        if(currentPhotoData) { 
            img.src = currentPhotoData; 
            img.style.display='block'; 
            pCol.classList.remove('shrink-photo');
        } else { 
            img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; 
            pCol.classList.add('shrink-photo');
        }

        // Auto Toggle Top 5 Mode
        if(activeListMode === 'top5') {
            doc.body.classList.add('top5-mode');
            document.getElementById('top5ModeCheck').checked = true;
            doc.getElementById('card').classList.add('t5-' + designState.t5Layout);
            // SHOW ROYAL STAR
            if(royalStarData) {
                const rs = doc.getElementById('royalStar');
                rs.src = royalStarData;
                rs.style.display = 'block';
            }
        } else {
             if(!document.getElementById('top5ModeCheck').checked) {
                 doc.body.classList.remove('top5-mode');
                 doc.getElementById('royalStar').style.display = 'none';
             }
        }
        
        // SHOW TROPHY IF RANK EXISTS
        const rankTxt = document.getElementById('rankInput').value;
        const trophyWrap = doc.getElementById('trophyWrap');
        if(rankTxt && rankTxt.trim() !== "") {
            doc.getElementById('rankNum').innerText = rankTxt;
            if(trophyData) doc.getElementById('trophyImg').src = trophyData;
            trophyWrap.style.display = 'flex';
        } else {
            trophyWrap.style.display = 'none';
        }

        setTimeout(() => doc.getElementById('card').classList.add('active'), 100);
        stopVideo(); 
        document.getElementById('statusMsg').innerText = "LIVE: " + document.getElementById('nE').value;
        lastActiveState = 'card'; 
    }

    function clearTV() {
        if(!tvWindow || tvWindow.closed) return;
        stopAds();
        showJalsaScreen();
        stopVideo();
        document.getElementById('statusMsg').innerText = "CLEARED";
    }

    // --- NEW BADGE LOADERS ---
    function loadRoyalStar(input) {
        if(input.files && input.files[0]) {
            royalStarData = URL.createObjectURL(input.files[0]);
            alert("Royal Star Loaded!");
        }
    }
    
    function loadTrophy(input) {
        if(input.files && input.files[0]) {
            trophyData = URL.createObjectURL(input.files[0]);
            alert("Trophy Icon Loaded!");
        }
    }

    // --- VIDEO & ADS & PRESENTATION V29 ---
    
    function loadPartnerLogos(input) {
        partnerLogosData = [];
        for(let f of input.files) partnerLogosData.push(URL.createObjectURL(f));
        updatePartnerLogos();
        alert(partnerLogosData.length + " Partner Logos Loaded.");
    }
    
    function updatePartnerLogos() {
        if(!tvWindow || tvWindow.closed) return;
        const c = tvWindow.document.getElementById('plContainer');
        c.innerHTML = '';
        partnerLogosData.forEach(src => {
            let img = tvWindow.document.createElement('img');
            img.src = src; img.className = 'pl-img';
            img.style.height = designState.plSize + 'px';
            c.appendChild(img);
        });
        c.style.gap = designState.plGap + 'px';
    }
    
    function togglePartnerLogos() {
        designState.plVisible = !designState.plVisible;
        if(tvWindow && !tvWindow.closed) {
             const c = tvWindow.document.getElementById('plContainer');
             c.style.opacity = designState.plVisible ? '1' : '0';
        }
    }

    function loadAds(input) {
        adFiles = [];
        for(let f of input.files) {
             let type = f.type.startsWith('video') ? 'video' : 'image';
             adFiles.push({ file: f, type: type, url: URL.createObjectURL(f) });
        }
        alert(adFiles.length + " Ads (Photos/Videos) Loaded.");
    }
    
    function toggleAdsMode() {
        if(adInterval) stopAds(); else startAds();
    }
    
    function startAds() {
        if(!tvWindow || tvWindow.closed || adFiles.length === 0) { alert("No Ads Loaded or TV Closed!"); return; }
        const adLayer = tvWindow.document.getElementById('adLayer');
        const adImg = tvWindow.document.getElementById('adImg');
        const adVid = tvWindow.document.getElementById('adVid');
        
        adLayer.style.display = 'flex';
        adIndex = 0;
        
        function playAd() {
            if(!adInterval) return; 
            let currentAd = adFiles[adIndex];
            
            if(currentAd.type === 'image') {
                adVid.pause(); adVid.style.display = 'none';
                adImg.src = currentAd.url;
                adImg.style.display = 'block';
                setTimeout(() => { if(adInterval) { nextAdIndex(); playAd(); } }, 10000);
            } else {
                adImg.style.display = 'none';
                adVid.src = currentAd.url;
                adVid.style.display = 'block';
                adVid.currentTime = 0;
                adVid.muted = false; 
                adVid.play().catch(() => { adVid.muted=true; adVid.play(); });
                adVid.onended = () => { if(adInterval) { nextAdIndex(); playAd(); } };
            }
        }
        
        function nextAdIndex() {
            adIndex = (adIndex + 1) % adFiles.length;
        }

        adInterval = true; 
        playAd();
        document.getElementById('statusMsg').innerText = "ADS MODE ON";
    }
    
    function stopAds() {
        adInterval = false;
        if(tvWindow && !tvWindow.closed) {
             tvWindow.document.getElementById('adLayer').style.display = 'none';
             tvWindow.document.getElementById('adVid').pause();
        }
        if(document.getElementById('statusMsg').innerText === "ADS MODE ON") document.getElementById('statusMsg').innerText = "ADS STOPPED";
    }

    document.getElementById('videoPlaylist').onchange = e => {
        playlist = Array.from(e.target.files);
        currentVidIdx = 0;
        alert(playlist.length + " General Videos Queued.");
    };
    
    function loadTop5Videos(input) {
        top5VideoPlaylist = Array.from(input.files);
        currentVidIdx = 0;
        alert(top5VideoPlaylist.length + " Top 5 Videos Queued.");
    }

    // --- NEXT VIDEO FUNCTION (SMART SEARCH + AUTO TV UPDATE) ---
    function playNextVideo() {
        if(!tvWindow || tvWindow.closed) return;

        // 1. Select correct list
        let targetStudentList = activeListMode === 'top5' ? top5Students : students;
        let targetVideoFiles = activeListMode === 'top5' ? top5VideoPlaylist : playlist;

        // 2. Safety Checks
        if(targetStudentList.length === 0) { alert("Student List is empty!"); return; }
        if(targetVideoFiles.length === 0) { alert("No Videos Loaded!"); return; }
        
        // Reset index if needed
        if(currentVidIdx >= targetStudentList.length) currentVidIdx = 0;

        // 3. Get Student Data
        let studentData = targetStudentList[currentVidIdx];
        if(!studentData) return;

        // Prepare Search Terms (Dhivehi & English)
        let nameDhivehi = studentData.nD ? studentData.nD.trim() : "";
        let nameEnglish = studentData.nE ? studentData.nE.trim().toLowerCase() : "";
        
        // Clean names
        nameDhivehi = nameDhivehi.replace(/\s+/g, ' ');
        nameEnglish = nameEnglish.replace(/\s+/g, ' ');

        console.log("Searching Next: " + nameDhivehi + " OR " + nameEnglish);

        // 4. FIND VIDEO
        let foundVideo = targetVideoFiles.find(file => {
            let fileName = decodeURIComponent(file.name);
            let fileNameLower = fileName.toLowerCase().replace(/\s+/g, ' ');
            
            let matchDhivehi = (nameDhivehi.length > 0) && fileName.includes(nameDhivehi);
            let matchEnglish = (nameEnglish.length > 0) && fileNameLower.includes(nameEnglish);
            
            return matchDhivehi || matchEnglish;
        });

        if(foundVideo) {
            // Play Video
            playLocalVideoFile(foundVideo);
            
            // Highlight Student & Load Data
            let listElement = document.getElementById('stuList');
            if(listElement.options.length > currentVidIdx) {
                listElement.selectedIndex = currentVidIdx;
                loadStudent(); 

                // --- FORCE UPDATE TEXT ON TV ---
                if(tvWindow && !tvWindow.closed) {
                    let doc = tvWindow.document;
                    doc.getElementById('tnD').textContent = studentData.nD || "";
                    doc.getElementById('tnE').textContent = studentData.nE || "";
                    doc.getElementById('tfD').textContent = studentData.fD || "";
                    doc.getElementById('tfE').textContent = studentData.fE || "";
                    doc.getElementById('tcD').textContent = studentData.cD || "";
                    doc.getElementById('tcE').textContent = studentData.cE || "";
                    
                    if(studentData.rank) {
                        doc.getElementById('rankNum').innerText = studentData.rank;
                        doc.getElementById('trophyWrap').style.display = 'flex';
                    } else {
                        doc.getElementById('trophyWrap').style.display = 'none';
                    }
                }
                // -------------------------------
            }

            document.getElementById('statusMsg').innerText = "PLAYING: " + studentData.nD;
            
            // Move index forward for the next click
            currentVidIdx++; 
        } else {
            alert("‚ö†Ô∏è ﬁàﬁ©ﬁëﬁ®ﬁáﬁØﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁäﬁ¨ﬁÇﬁ™ﬁÇﬁ™!\n\nﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™: " + studentData.nD);
        }
    }

    function toggleOverlayMode(enabled) {
         if(!tvWindow || tvWindow.closed) return;
         if(enabled) {
            tvWindow.document.body.classList.add('overlay-mode');
            if(lastActiveState === 'card') tvWindow.document.getElementById('card').classList.add('active'); 
         } else {
            tvWindow.document.body.classList.remove('overlay-mode');
         }
    }

    function playLocalVideoFile(file) {
        if(document.getElementById('top5ModeCheck').checked) {
            updateTV(); 
            tvWindow.document.body.classList.add('top5-mode');
             tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
        } else {
             tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
            if(document.getElementById('vidOverlayCheck').checked) {
                tvWindow.document.body.classList.add('overlay-mode');
                tvWindow.document.getElementById('card').classList.add('active'); 
            } else {
                tvWindow.document.body.classList.remove('overlay-mode');
                tvWindow.document.getElementById('card').classList.remove('active');
            }
        }

        const url = URL.createObjectURL(file);
        const vl = tvWindow.document.getElementById('videoLayer');
        vl.innerHTML = `<video id="mainVid" src="${url}" autoplay controls style="width:100%;height:100%; object-fit:contain;"></video>`;
        vl.style.display = 'flex';
        setTimeout(() => { const v = tvWindow.document.getElementById('mainVid'); if(v) v.play().catch(e => {}); }, 100);
        document.getElementById('statusMsg').innerText = "PLAYING VIDEO";
    }
    
    function stopVideo() {
        if(!tvWindow || tvWindow.closed) return;
        const vl = tvWindow.document.getElementById('videoLayer');
        vl.innerHTML = ''; vl.style.display = 'none';
        tvWindow.document.body.classList.remove('overlay-mode');
        if(!document.getElementById('top5ModeCheck').checked) tvWindow.document.body.classList.remove('top5-mode');
        
        if(lastActiveState === 'title') {
            showJalsaScreen();
        } else if (lastActiveState === 'card') {
            tvWindow.document.getElementById('card').classList.add('active');
            if(designState.keepTitle) {
                tvWindow.document.getElementById('jalsaContent').classList.remove('hidden');
            } else {
                 tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
            }
        }
    }
    
    // --- SMART LINK CONVERTER (UPDATED FOR GAMMA) ---
    function getSmartLink(url, type) {
        // YouTube
        if(url.includes('youtube.com') || url.includes('youtu.be')) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            if (match && match[2]) {
                return `https://www.youtube-nocookie.com/embed/${match[2]}?autoplay=1&controls=1&rel=0`;
            }
        }
        
        // Canva
        if(type === 'canva' || (type === 'auto' && url.includes('canva.com'))) {
             let cleanUrl = url.split('?')[0];
             if(cleanUrl.endsWith('/')) cleanUrl = cleanUrl.slice(0, -1);
             if(cleanUrl.includes('/view')) {
                 if(!cleanUrl.includes('?embed')) return cleanUrl + '?embed';
             } else if(cleanUrl.includes('/edit')) {
                 return cleanUrl.replace('/edit', '/view?embed');
             } else {
                 return cleanUrl + '/view?embed';
             }
        }

        // Gamma (Fix: Gamma links work directly, but sometimes need cleaning)
        if(type === 'gamma' || (type === 'auto' && url.includes('gamma.app'))) {
             return url; 
        }

        return url;
    }

    function showPresentation() {
        if(!tvWindow || tvWindow.closed) return;
        let url = document.getElementById('presLink').value;
        const type = document.getElementById('presType').value;
        if(!url) return;
        
        if(url.includes("<iframe")) {
            const match = url.match(/src="([^"]+)"/);
            if(match && match[1]) url = match[1];
        }

        const finalUrl = getSmartLink(url, type);

        const vl = tvWindow.document.getElementById('videoLayer');
        vl.innerHTML = `<iframe src="${finalUrl}" allow="fullscreen; autoplay; encrypted-media; clipboard-write" style="width:100%; height:100%; border:none;"></iframe>`;
        vl.style.display = 'flex';
        tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
        tvWindow.document.getElementById('card').classList.remove('active');
    }
    
    function loadPDF(input) {
        if(input.files && input.files[0]) {
            pdfUrl = URL.createObjectURL(input.files[0]);
            alert("PDF Loaded. Click 'Show PDF' to display.");
        }
    }
    
    function showPDFScreen() {
        if(!tvWindow || tvWindow.closed) return;
        if(!pdfUrl) { alert("No PDF Loaded!"); return; }
        
        const vl = tvWindow.document.getElementById('videoLayer');
        vl.innerHTML = `<iframe src="${pdfUrl}" style="width:100%; height:100%; border:none;"></iframe>`;
        vl.style.display = 'flex';
        tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
        tvWindow.document.getElementById('card').classList.remove('active');
    }
    
    function playYoutube() {
        if(!tvWindow || tvWindow.closed) return;
        tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
        tvWindow.document.getElementById('card').classList.remove('active');

        let url = document.getElementById('ytLink').value;
        if(!url) return;
        
        const embedUrl = getSmartLink(url, 'auto');
        
        if(!embedUrl) { alert("Invalid YT Link"); return; }
        const vl = tvWindow.document.getElementById('videoLayer');
        vl.innerHTML = `<iframe id="ytFrame" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="width:100%;height:100%;"></iframe>`;
        vl.style.display = 'flex';
    }
    
    function openYTPopup() {
        const url = document.getElementById('ytLink').value;
        if(url) window.open(url, '_blank', 'width=1280,height=720');
    }

    // --- FILE HANDLERS ---
    document.getElementById('jalsaCsvFile').onchange = e => {
        const file = e.target.files[0]; if(!file) return;
        const r = new FileReader();
        r.onload = evt => {
            const lines = evt.target.result.split('\n');
            if(lines.length > 0) {
                const cols = lines[0].split(',');
                if(cols[0]) document.getElementById('jLine1').value = cols[0].trim();
                for(let i=1; i<8; i++) {
                    if(cols[i]) document.getElementById('jLine'+(i+1)).value = cols[i].trim();
                }
                updateJalsaText(); alert("Titles Loaded!");
            }
        }; r.readAsText(file);
    };

    document.getElementById('fontFile').onchange = e => {
        const file = e.target.files[0]; if(!file) return;
        const r = new FileReader();
        r.onload = evt => {
            currentFontData = evt.target.result;
            const newFont = new FontFace('Faruuma', `url(${currentFontData})`);
            newFont.load().then(f => {
                document.fonts.add(f);
                document.querySelectorAll('.font-dv, input, h2').forEach(el => el.style.fontFamily = "'Faruuma', serif");
                alert("Font Loaded! Re-open TV.");
            });
        }; r.readAsDataURL(file);
    };

    document.getElementById('jalsaBgFile').onchange = e => {
        const file = e.target.files[0]; if(!file) return;
        const r = new FileReader();
        r.onload = evt => {
            currentJalsaBgData = evt.target.result;
            currentJalsaBgType = file.type.startsWith('video') ? 'video' : 'image';
            updateJalsaBackground(); alert("Background Set");
        }; r.readAsDataURL(file);
    };

    document.getElementById('customBorderFile').onchange = e => {
        const r = new FileReader();
        r.onload = evt => {
            customBorderData = evt.target.result;
            if(designState.cBorder === 'custom') liveUpdate('cBorder', 'custom');
            alert("Custom Frame Loaded!");
        }; r.readAsDataURL(e.target.files[0]);
    };
    
    function loadCustomCardBg(input) {
        const r = new FileReader();
        r.onload = evt => {
            customCardBgData = evt.target.result;
            liveUpdate('cBorder', 'custom_bg');
            document.getElementById('cBorderSel').value = 'custom_bg';
            alert("Custom Card Background Loaded!");
        }; r.readAsDataURL(input.files[0]);
    }

    // UPDATED CSV PARSER FOR RANK
    function parseCSV(text) {
        let lines = text.split('\n');
        let data = [];
        lines.forEach(l => {
            let c = l.split(',');
            if(c.length>1) {
                data.push({
                    nD: c[0]?.trim(), nE: c[1]?.trim(), cD: c[2]?.trim(), cE: c[3]?.trim(), 
                    fD: c[4]?.trim(), fE: c[5]?.trim(), cm: c[6]?.trim(), ph: c[7]?.trim(),
                    rank: c[8]?.trim() // New Column for Rank
                });
            }
        });
        return data;
    }

    document.getElementById('csvFile').onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            let txt = ev.target.result; if(txt.charCodeAt(0)===0xFEFF) txt=txt.substr(1);
            students = parseCSV(txt);
            if(activeListMode === 'general') filterList(); 
            alert("General List Loaded: " + students.length);
        }; r.readAsText(e.target.files[0]);
    };

    document.getElementById('photoFolder').onchange = e => {
        photoFiles = {};
        for(let f of e.target.files) {
            let name = f.name.toLowerCase();
            photoFiles[name] = f; 
            let nameNoExt = name.split('.').slice(0, -1).join('.');
            if(nameNoExt) photoFiles[nameNoExt] = f; 
        }
        alert("General Photos: " + e.target.files.length);
    };

    function loadTop5Csv(input) {
        const r = new FileReader();
        r.onload = ev => {
            let txt = ev.target.result; if(txt.charCodeAt(0)===0xFEFF) txt=txt.substr(1);
            top5Students = parseCSV(txt);
            if(activeListMode === 'top5') filterList();
            alert("Top 5 List Loaded: " + top5Students.length);
        }; r.readAsText(input.files[0]);
    }

    function loadTop5Photos(input) {
        top5PhotoFiles = {};
        for(let f of input.files) {
            let name = f.name.toLowerCase();
            top5PhotoFiles[name] = f; 
            let nameNoExt = name.split('.').slice(0, -1).join('.');
            if(nameNoExt) top5PhotoFiles[nameNoExt] = f; 
        }
        alert("Top 5 Photos: " + input.files.length);
    }

    function switchListMode(mode) {
        activeListMode = mode;
        document.getElementById('btnGenList').className = mode === 'general' ? 'list-switch-btn active' : 'list-switch-btn';
        document.getElementById('btnTop5List').className = mode === 'top5' ? 'list-switch-btn active' : 'list-switch-btn';
        
        if(mode === 'top5') {
            document.getElementById('top5ModeCheck').checked = true;
        } else {
             document.getElementById('top5ModeCheck').checked = false;
        }
        
        filterList();
        currentVidIdx = 0;
    }

    function processPhoto(file, cb) {
        const reader = new FileReader();
        reader.onload = e => { cb(e.target.result); };
        reader.readAsDataURL(file);
    }
    
    function manualPhoto(input) {
        if(input.files && input.files[0]) {
             processPhoto(input.files[0], d => {
                currentPhotoData = d;
                document.getElementById('previewImg').src = d;
                document.getElementById('pStat').innerText = "Manual";
                document.getElementById('pStat').style.color = "blue";
             });
        }
    }

    function filterList() {
        let t = document.getElementById('search').value.toLowerCase();
        let l = document.getElementById('stuList'); l.innerHTML = '';
        
        let targetArray = activeListMode === 'top5' ? top5Students : students;
        
        targetArray.forEach((s,i) => {
            if((s.nD+s.nE).toLowerCase().includes(t)) {
                let prefix = activeListMode === 'top5' ? "üèÜ " : (i+1)+". ";
                let o = document.createElement('option'); o.value=i; o.text=prefix+s.nD; l.add(o);
            }
        });
    }

   function loadStudent() {
    let idx = document.getElementById('stuList').value;
    
    // Check which list and photo set to use
    let targetArray = activeListMode === 'top5' ? top5Students : students;
    
    // ================== ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ ﬁéﬁ¨ﬁÇﬁ∞ﬁÇﬁ¶ﬁÇﬁ∞ﬁàﬁ© ﬁÑﬁ¶ﬁáﬁ® ==================
    let targetPhotos;
    if (activeListMode === 'top5') {
        // Top 5 ﬁäﬁØﬁçﬁ∞ﬁëﬁß ﬁÄﬁ™ﬁêﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ General folder ﬁáﬁ®ﬁÇﬁ∞ ﬁäﬁÆﬁìﬁØ ﬁÇﬁ¶ﬁéﬁßﬁÇﬁ¨
        targetPhotos = (Object.keys(top5PhotoFiles).length > 0) ? top5PhotoFiles : photoFiles;
    } else {
        targetPhotos = photoFiles;
    }
    // =========================================================
    
    if(!targetArray[idx]) return;

    let s = targetArray[idx];
    // Populate text fields
    document.getElementById('nD').value = s.nD || ""; 
    document.getElementById('nE').value = s.nE || "";
    document.getElementById('fD').value = s.fD || ""; 
    document.getElementById('fE').value = s.fE || "";
    document.getElementById('cD').value = s.cD || ""; 
    document.getElementById('cE').value = s.cE || "";
    document.getElementById('cm').value = s.cm || "";
    document.getElementById('rankInput').value = s.rank || "";
        
        // --- IMPROVED PHOTO FINDER ---
        let pNameRaw = s.ph ? s.ph.trim() : ""; // Name from CSV
        let pName = pNameRaw.toLowerCase(); // Lowercase version
        let pNameNoExt = pName.split('.').slice(0, -1).join('.'); // Remove .jpg if present

        let prev = document.getElementById('previewImg');
        let stat = document.getElementById('pStat');
        
        // Try matching in 3 ways: Exact, Lowercase, or No Extension
        let foundFile = targetPhotos[pNameRaw] || targetPhotos[pName] || targetPhotos[pNameNoExt];
        
        if(foundFile) {
            stat.innerText = "Loading...";
            processPhoto(foundFile, d => {
                currentPhotoData = d; 
                prev.src = d; 
                stat.innerText = "‚úÖ Found"; 
                stat.style.color="green";
                
                // --- FIX: REMOVED AUTO TV UPDATE CODE FROM HERE ---
                // The lines that forced the photo to TV immediately have been removed.
                // Now photo only goes to TV when you click 'Live'.
            });
        } else {
            currentPhotoData = null; 
            prev.src = "https://via.placeholder.com/150"; 
            
            // Show error in the preview box
            if(pNameRaw === "") {
                stat.innerText = "No Photo Name"; 
                stat.style.color="grey";
            } else {
                stat.innerText = "‚ùå Missing: " + pNameRaw; 
                stat.style.color="red";
            }
        }
    }
    function move(d) {
        let l = document.getElementById('stuList');
        if(l.options.length) {
            let newIdx = Math.min(Math.max(l.selectedIndex+d, 0), l.options.length-1);
            l.selectedIndex = newIdx;
            loadStudent();
        }
    }
    // --- PREVIOUS VIDEO FUNCTION (BACK BUTTON) ---
    function playPrevVideo() {
        if(!tvWindow || tvWindow.closed) return;

        // 1. Select correct list
        let targetStudentList = activeListMode === 'top5' ? top5Students : students;
        let targetVideoFiles = activeListMode === 'top5' ? top5VideoPlaylist : playlist;

        // 2. Safety Checks
        if(currentVidIdx <= 0) { alert("ﬁâﬁ®ﬁáﬁ© ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁàﬁ©ﬁëﬁ®ﬁáﬁØ! ﬁäﬁ¶ﬁÄﬁ¶ﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁÇﬁ™ﬁãﬁ¨ﬁàﬁ≠ﬁÇﬁ¨."); return; }
        
        // 3. Move Index Backwards
        currentVidIdx--; 

        // 4. Get Student Data for the PREVIOUS student
        let studentData = targetStudentList[currentVidIdx];
        if(!studentData) return;

        // Prepare Search Terms
        let nameDhivehi = studentData.nD ? studentData.nD.trim() : "";
        let nameEnglish = studentData.nE ? studentData.nE.trim().toLowerCase() : "";
        
        // Clean names
        nameDhivehi = nameDhivehi.replace(/\s+/g, ' ');
        nameEnglish = nameEnglish.replace(/\s+/g, ' ');

        console.log("Going Back: Searching for " + nameDhivehi);

        // 5. FIND VIDEO
        let foundVideo = targetVideoFiles.find(file => {
            let fileName = decodeURIComponent(file.name);
            let fileNameLower = fileName.toLowerCase().replace(/\s+/g, ' ');
            
            let matchDhivehi = (nameDhivehi.length > 0) && fileName.includes(nameDhivehi);
            let matchEnglish = (nameEnglish.length > 0) && fileNameLower.includes(nameEnglish);
            
            return matchDhivehi || matchEnglish;
        });

        if(foundVideo) {
            // Play Previous Video
            playLocalVideoFile(foundVideo);
            
            // Highlight Student in List
            let listElement = document.getElementById('stuList');
            if(listElement.options.length > currentVidIdx) {
                listElement.selectedIndex = currentVidIdx;
                loadStudent(); 
            }
            document.getElementById('statusMsg').innerText = "BACK TO: " + studentData.nD;
        } else {
            alert("‚ö†Ô∏è ﬁàﬁ©ﬁëﬁ®ﬁáﬁØﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁäﬁ¨ﬁÇﬁ™ﬁÇﬁ™ (Back to): " + studentData.nD);
        }
    }

    // --- NEW FUNCTIONS (ZOOM & SCREEN CONTROL) ---

    // 1. ﬁìﬁ©ﬁàﬁ© ﬁàﬁ®ﬁÇﬁ∞ﬁëﬁØ ﬁíﬁ´ﬁâﬁ∞ ﬁÜﬁ™ﬁÉﬁß ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞
    function setTVZoom(val) {
        if(tvWindow && !tvWindow.closed) {
            tvWindow.document.body.style.zoom = val;
        }
    }

    // 2. ﬁáﬁ¶ﬁÉﬁ®ﬁâﬁ¶ﬁåﬁ© ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁäﬁÆﬁìﬁØ ﬁçﬁß ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞
    function loadScreenBG(side, input) {
        if(!tvWindow || tvWindow.closed) return;
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const zoneId = (side === 'left') ? 'zoneLeft' : 'zoneRight';
                const zoneDiv = tvWindow.document.getElementById(zoneId);
                if(zoneDiv) {
                    zoneDiv.style.backgroundImage = `url(${e.target.result})`;
                    zoneDiv.style.backgroundSize = "cover";
                    document.getElementById('statusMsg').innerText = side.toUpperCase() + " SCREEN UPDATED";
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 3. ﬁåﬁ®ﬁÇﬁ∞ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁâﬁØﬁëﬁ™ ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁß ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞
   // ... (ﬁâﬁ¶ﬁåﬁ©ﬁéﬁ¶ﬁáﬁ®ÿå ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® toggleTripleMode ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁßﬁÇﬁ¨) ...

    function toggleTripleMode() {
        if(!tvWindow || tvWindow.closed) return;
        tvWindow.document.body.classList.toggle('triple-active');
    }

    function adjustZone(side, prop, val) {
        if(!tvWindow || tvWindow.closed) return;
        
        const zoneId = (side === 'left') ? 'zoneLeft' : 'zoneRight';
        const el = tvWindow.document.getElementById(zoneId);
        
        if(el) {
            if(prop === 'width') {
                // ﬁäﬁ™ﬁÖﬁßﬁâﬁ®ﬁÇﬁ∞ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (%)
                el.style.width = val + "%"; 
            } else {
                // ﬁãﬁ¨ﬁäﬁ¶ﬁÉﬁßﬁåﬁ¶ﬁÅﬁ∞ ﬁñﬁ¨ﬁáﬁ∞ﬁêﬁ™ﬁÇﬁ∞ (Pixels)
                el.style[side] = val + "px"; 
            }
        }
    }

</script>
</body>
</html>
