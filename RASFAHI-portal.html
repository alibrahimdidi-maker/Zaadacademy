<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <title>Rasfahi portal (V33.0 - Platinum Edition - Navigation & Flex)</title>
    <style>
    /* 1. Google Font (Official & Clean) */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700&family=Noto+Sans+Thaana:wght@400;700&display=swap');

    /* 2. Faruuma Font */
    @font-face {
        font-family: 'Faruuma';
        src: local('Faruuma'), local('Faruumaa'), url('Fonts/faruuma.ttf') format('truetype');
    }

    /* --- THEME: THE PRESIDENTIAL ESTATE (Official Green & Gold) --- */
    :root {
        --bg-grad: radial-gradient(circle at center, #004d40 0%, #00251a 100%);
        --panel-bg: rgba(0, 30, 25, 0.95); 
        --panel-border: 1px solid #c5a059; /* Muted Gold */
        
        --text-main: #ffffff;
        --text-label: #a7ffeb; /* Light Green for Labels */
        --text-heading: #c5a059; /* Gold for Headings */
        
        --input-bg: #001812;
        --input-border: 1px solid #4db6ac;
        
        --accent-gold: #c5a059;
        --shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    body {
        margin: 0; padding: 0;
        background: var(--bg-grad);
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
        overflow: hidden; height: 100vh; width: 100vw;
        -webkit-user-select: none; user-select: none;
        text-align: left; /* Global Left Alignment for English */
    }

    /* LAYOUT FIXED */
    .main-layout { 
        display: flex; gap: 20px; 
        height: 100vh; width: 100vw; 
        padding: 20px;
        box-sizing: border-box; 
    }
    
    .sidebar {
        flex: 0 0 380px;
        background: var(--panel-bg);
        border: var(--panel-border);
        border-radius: 6px; 
        padding: 20px;
        display: flex; flex-direction: column; 
        height: calc(100vh - 40px); 
        overflow-y: auto;
        box-shadow: var(--shadow);
        box-sizing: border-box;
    }

    .editor {
        flex: 1;
        background: var(--panel-bg);
        border: var(--panel-border);
        border-radius: 6px;
        padding: 30px;
        display: flex; flex-direction: column; 
        height: calc(100vh - 40px); 
        overflow-y: auto;
        box-shadow: var(--shadow);
        position: relative;
        box-sizing: border-box;
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #00251a; margin-top: 5px; margin-bottom: 5px; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #c5a059; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #e6c575; }

    /* TYPOGRAPHY */
    h1, h2, h3, h4 { 
        margin: 5px 0; 
        font-family: 'Playfair Display', serif; 
        color: var(--text-heading); 
        text-transform: uppercase; 
        letter-spacing: 1px;
        text-align: left; /* Default headings to Left */
    }
    
    label { 
        display: block; font-size: 13px; 
        color: var(--text-label); 
        margin-bottom: 5px; margin-top: 15px; 
        font-weight: 600; text-transform: uppercase;
        letter-spacing: 0.5px;
        text-align: left;
    }
    
    .d-label { 
        font-size: 16px; font-weight: bold; color: var(--accent-gold); 
        border-bottom: 1px solid var(--accent-gold); 
        padding-bottom: 5px; margin-top: 30px; display: block;
        font-family: 'Playfair Display', serif;
        text-align: left;
    }

    /* INPUTS */
    input[type="text"], textarea, select, input[type="number"] { 
        width: 100%; padding: 12px; 
        border: var(--input-border); border-radius: 4px; 
        background: var(--input-bg);
        color: #ffffff; 
        font-size: 15px; font-weight: 500;
        box-sizing: border-box; transition: 0.2s;
        font-family: 'Inter', sans-serif;
        text-align: left; /* English inputs left aligned */
    }
    input:focus, textarea:focus, select:focus { 
        border-color: var(--accent-gold); 
        background: #000; 
        outline: none; 
        box-shadow: 0 0 8px rgba(197, 160, 89, 0.3);
    }
    
    /* Specific Inputs */
    #jLine1 { 
        font-size: 22px !important; font-weight: bold !important; text-align: center !important; 
        color: #c5a059 !important; background: #000 !important; 
        border: 1px solid #c5a059 !important; font-family: 'Playfair Display', serif !important;
    }
    .sub-title-input { text-align: center !important; background: #00332a !important; color: #fff !important; border: 1px solid #004d40 !important; }

    /* DHIVEHI INPUTS OVERRIDE (Right to Left) */
    .font-dv {
        font-family: 'Faruuma', 'Noto Sans Thaana', sans-serif !important;
        direction: rtl !important;
        text-align: right !important;
    }

    /* BUTTONS */
    button { 
        cursor: pointer; font-weight: 600; border-radius: 4px; 
        border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s;
        text-transform: uppercase; letter-spacing: 1px; font-size: 13px;
        background: linear-gradient(to bottom, #2e7d32, #1b5e20); 
        color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    button:hover { 
        filter: brightness(1.2); border-color: var(--accent-gold); 
        transform: translateY(-1px);
    }

    /* Button Colors */
    .launch-btn { background: linear-gradient(to bottom, #b71c1c, #7f0000) !important; border-color: #ef5350; font-size: 15px; padding: 14px; margin-bottom: 12px; }
    
    .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
    .btn-live { background: linear-gradient(to bottom, #f9a825, #f57f17) !important; color: #000 !important; flex: 2; padding: 12px; font-weight: 800; }
    .btn-nav { background: #37474f !important; width: 60px; font-size: 20px; }
    .btn-vid { background: #263238 !important; padding: 10px; width: 100%; margin-top: 5px; border: 1px solid #546e7a; }
    
    .conf-btn { background: #0277bd !important; flex: 1; padding: 8px; font-size: 11px; }
    .config-btn-row { display: flex; gap: 5px; margin-bottom: 15px; }

    #lockBtn { background: #ffd700 !important; color: #000 !important; font-weight: 900; padding: 12px; width: 100%; margin-bottom: 15px; border: 2px solid #fff !important; }
    #lockBtn.active { background: #b71c1c !important; color: white !important; }

    /* TABS */
    .lang-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .lang-btn { flex: 1; background: rgba(255,255,255,0.05) !important; padding: 10px; text-align: center; color: #80cbc4; text-decoration: none; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); }
    .lang-btn.active { background: #004d40 !important; color: #c5a059 !important; border: 1px solid #c5a059 !important; }
    
    .list-switch-btn { background: #263238 !important; color: #b0bec5; padding: 10px; flex: 1; border: 1px solid #37474f; }
    .list-switch-btn.active { background: var(--accent-gold) !important; color: #000 !important; font-weight:bold; }

    /* HELPERS & BANNERS */
    .royal-banner { 
        background: linear-gradient(to right, #00100a, #00332a, #00100a);
        border: 1px solid var(--accent-gold); border-bottom: 4px solid var(--accent-gold); 
        text-align: center; padding: 20px; margin-bottom: 20px; border-radius: 4px; 
    }
    .banner-main { color: #80cbc4; font-size: 11px; letter-spacing: 3px; text-transform: uppercase; display: block; }
    .banner-sub { color: var(--accent-gold); font-size: 24px; font-family: 'Playfair Display', serif; display: block; margin-top: 5px; font-weight: 700; }

    .group-box { border: 1px solid #004d40; border-radius: 6px; padding: 30px 20px 20px 20px; margin-bottom: 25px; background: rgba(0,0,0,0.2); position: relative; }
    .group-title { position: absolute; top: -10px; left: 20px; background: #c5a059; color: #000; padding: 4px 15px; font-size: 12px; font-weight: bold; border-radius: 2px; text-transform: uppercase; }

    .video-panel { background: rgba(0, 77, 64, 0.3); padding: 15px; border-radius: 6px; border: 1px solid #00695c; margin-bottom: 20px; }
    
    /* Student List */
    #stuList { background: #001812; color: #fff; border: 1px solid #4db6ac; min-height: 250px; border-radius: 4px; text-align: left; }
    #stuList option { padding: 10px; border-bottom: 1px solid #00332a; }
    
    /* Preview */
    .preview-container { background: rgba(0,0,0,0.3); border: 1px solid #004d40; padding: 15px; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 15px; }
    #previewImg { width: 110px; height: 110px; border-radius: 4px; object-fit: cover; border: 2px solid var(--accent-gold); background: #000; }

    /* Full Screen Button */
    #cpFsBtn { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: #00251a; color: var(--accent-gold); border-radius: 50%; z-index: 1000; font-size: 24px; border: 2px solid var(--accent-gold); display:flex; align-items:center; justify-content:center; }

    /* Security Overlay & Welcome Note */
    #securityOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #00100a; z-index: 99999; display: flex; align-items: center; justify-content: center; }
    
    .sec-box { 
        background: #00251a; 
        padding: 50px; 
        border: 2px solid var(--accent-gold); 
        text-align: center !important; /* FORCED CENTER */
        width: 500px; 
    }
    
    /* Force children of sec-box to be centered regardless of global settings */
    .sec-box h1, .sec-box h2, .sec-box p, .sec-box div {
        text-align: center !important;
    }

    .admin-pic { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--accent-gold); margin-bottom: 20px; background: #000; }
    
    .sec-input { background: #fff; color: #000; border: none; padding: 15px; font-size: 22px; width: 100%; margin-top: 20px; text-align: center; border-radius: 4px; font-family: monospace; }
    .sec-btn { background: var(--accent-gold); color: #00251a; width: 100%; margin-top: 25px; padding: 15px; font-size: 18px; border: none; font-weight: bold; }

    .dev-credits { text-align:center; font-size:12px; color:#4db6ac; margin-top: 20px; border-top: 1px solid #004d40; padding-top: 10px; padding-bottom: 15px; }
    .dev-name { color: #fff; font-weight:bold; }
    
    .locked-zone { opacity: 0.5; pointer-events: none; filter: grayscale(0.8); }
    </style>
    
</head>
<body oncontextmenu="return false;">

    <button id="cpFsBtn" onclick="toggleControlFS()" title="Full Screen">‚õ∂</button>

    <div id="securityOverlay">
    <div class="sec-box" style="width: 500px; max-width: 90vw; padding: 40px 30px; box-sizing: border-box; max-height: 98vh; overflow-y: auto;">
        
        <img src="Photos/ali.png" class="admin-pic" alt="Ali Ibrahim Didi">
        
        <h1 style="color:#FFD700; font-size:20px; margin:0 0 5px 0; font-family:'Times New Roman', serif; text-transform:uppercase; letter-spacing:1px;">
            Warm Welcome to
        </h1>
        <h2 style="color:#fff; font-size:26px; margin:0 0 20px 0; text-shadow:0 2px 5px #000; line-height: 1.2;">
            Rasfahi Event and Graduation Software
        </h2>

        <p style="color:#bbdefb; font-size:13px; margin-bottom:15px;">
            Paste subscription code using <b>Ctrl + V</b>.<br>
            <span style="color:#ffcc80;">‚ö†Ô∏è No spaces allowed! Invalid if spaced.</span>
        </p>

        <input type="password" id="licenseKey" class="sec-input" placeholder="Paste Key Here..." style="font-size:16px; padding: 10px; margin-top:0;">
        <button class="sec-btn" onclick="verifyLicense()" style="margin-top: 15px; padding: 10px; font-size:16px;">AUTHENTICATE</button>
        <p id="secMsg" style="color:#ff5252; font-size:14px; margin-top:10px; font-weight:bold; min-height:20px;"></p>

        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.15); margin: 20px 0;">

        <div style="text-align:center; font-size:11px; color:#b0bec5; line-height:1.4;">
            <p style="margin-bottom:8px;">
                Intellectual property of <strong>Ali Ibrahim Didi</strong>.<br>
                Registered under Maldives Copyright Law.<br>
                <span style="color:#fff;">Reg: MED.03.IP.CR.26.EW5889</span>
            </p>

            <div style="color:#ff1744; font-weight:bold; background:rgba(40,0,0,0.3); padding:8px; border:1px solid #ff1744; border-radius:4px; margin-bottom:10px;">
                ‚õî Unauthorized use will result in legal action.
            </div>

            <p style="color:#64b5f6; margin:0;">
                Support: <b>7791550</b> / <b>9901550</b>
            </p>
        </div>
    </div>
</div>
</body>
<div style="margin-top:10px;">
                        
    <div class="main-layout" id="mainApp">
        <div class="sidebar">
            <div class="lang-tabs">
                <a href="RASFAHI-portal-1.html" class="lang-btn active">ST.1</a>
                <a href="RASFAHI-portal-2.html" class="lang-btn">ST.2</a>
                <a href="RASFAHI-portal-3.html" class="lang-btn">ST.3</a>
            </div>

            <div class="royal-banner">
                <span class="banner-main">RASFAHI-EVENT AND GRADUATION CEREMONY SOFTWARE</span>
                <span class="banner-sub">Rasfahi Portal</span>
            </div>

            <div id="licenseStatus" style="font-size:13px; color:#0d47a1; text-align:center; margin-bottom:10px; font-weight:bold;"></div>

            <button class="launch-btn" onclick="openTV()">üñ•Ô∏è Turn on the TV screen</button>
            <div id="connStatus" style="font-size:14px; color:red; text-align:center; background:#ffebee; padding:4px; border-radius:4px; margin-bottom:10px; border:1px solid #ffcdd2;">Not Connected</div>

            <div id="configPanel" class="config-btn-row">
                <button class="conf-btn" onclick="downloadConfig()">‚¨á Save Configuration Settings</button>
                <button class="conf-btn" onclick="document.getElementById('confInput').click()">‚¨Ü Load Configuration Settings</button>
                <input type="file" id="confInput" accept=".json" style="display:none" onchange="loadConfig(this)">
            </div>

            <div id="sidebarFiles">
                <label style="margin-top:15px; color:#00281c;">üîç Search Students:</label>
            <div style="display:flex; gap:0; margin-bottom:5px;">
                <button class="list-switch-btn active" id="btnGenList" onclick="switchListMode('general')">üë• General List</button>
                <button class="list-switch-btn" id="btnTop5List" onclick="switchListMode('top5')">üèÜ Top 5 List</button>
            </div>
            <input type="text" id="search" placeholder="Type Name..." onkeyup="filterList()">
            
            <select id="stuList" size="10" style="flex-grow:1; border:1px solid #ccc; min-height: 200px;" onchange="loadStudent()"></select>
            
                <label style="color:#0d47a1; border-bottom:1px solid #e3f2fd; padding-bottom:5px; margin-bottom:8px; font-size:16px; font-weight:bold;">üìÇ System Files</label>
                <div style="margin-bottom: 15px; text-align: center;">
        <a href="https://drive.google.com/drive/folders/1qcCTdxUv9gssjBjQ2LFKNDjxb2sWK1Xl?usp=drive_link" target="_blank" style="text-decoration:none;">
            <button style="width:100%; background: #e8f0fe; color: #1967d2; border: 1px solid #1967d2; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.3s;">
                üìÇ Download Sample Files (G-Drive)
            </button>
        </a>
        <small style="color: #666; font-size: 11px;">(Excel, Photos, Fonts & CSV Samples)</small>
    </div>
                <label>1. Students List (CSV):</label><input type="file" id="csvFile" accept=".csv">
                <label>2. Students Photo Folder:</label><input type="file" id="photoFolder" webkitdirectory directory multiple>
                <label style="color:#2e7d32;">3. Main Logos (Max 5):</label><input type="file" id="mainLogosInput" accept="image/*" multiple onchange="loadMainLogos(this)">
                <label>4. Custom Font (TTF):</label><input type="file" id="fontFile" accept=".ttf, .otf">
                <label>5. Event Title (CSV):</label><input type="file" id="jalsaCsvFile" accept=".csv">
                <label style="color:#d84315;">6. Custom Frame:</label><input type="file" id="customBorderFile" accept="image/*">
                
                <hr>
                <label style="color:#2e7d32;">7. Partner Logos:</label>
                <input type="file" id="partnerLogos" accept="image/*" multiple onchange="loadPartnerLogos(this)">
                
                <label style="color:#c62828;">8. Advertisement / Banner (Photo/Video):</label>
                <input type="file" id="adFolder" accept="image/*, video/*" multiple onchange="loadAds(this)">
                
                <label style="color:#6a1b9a;">9. Custom Card Background:</label>
                <input type="file" id="customCardBgFile" accept="image/*" onchange="loadCustomCardBg(this)">
                
                <label style="color:#d32f2f;">10. PDF Presentation:</label>
                <input type="file" id="pdfFile" accept="application/pdf" onchange="loadPDF(this)">
                
                <hr style="border: 2px dashed #ffb300;">
                <label style="color:#ff6f00; font-weight:900;">11. TOP 5 LIST (CSV):</label>
                <input type="file" id="top5CsvFile" accept=".csv" onchange="loadTop5Csv(this)">
                
                <label style="color:#ff6f00; font-weight:900;">12. TOP 5 VIDEOS:</label>
                <input type="file" id="top5VideoFiles" accept="video/*" multiple onchange="loadTop5Videos(this)">
                
                <hr style="border: 2px dashed #ffb300;">
                <label style="color:#ffd700; font-weight:900;">13. ROYAL STAR ICON (PNG):</label>
                <input type="file" id="royalStarFile" accept="image/*" onchange="loadRoyalStar(this)">
                
                <label style="color:#ffd700; font-weight:900;">14. TROPHY ICON (PNG):</label>
                <input type="file" id="trophyFile" accept="image/*" onchange="loadTrophy(this)">
            </div>

            
            <div class="dev-credits">
                <span style="display:block; margin-bottom:3px;">Program Designed & Developed by:</span>
                <span class="dev-name">Ali Ibrahim Didi (+9607791550)</span>
                <span class="company-name">ZAAD RESEARCH AND PUBLISHING CONSULTANCY FIRM</span>
            </div>
        </div>

        <div class="editor" id="editorPanel">
            <button id="lockBtn" onclick="toggleLock()">üîì Unlocked (Editable Mode)</button>
            <div id="infoPanel" style="background:#fff; padding:20px; border-radius:10px; border:2px solid #90caf9; margin:15px 0; box-shadow:0 3px 10px rgba(0,0,0,0.05);">
                <label style="color:#d32f2f;">üöÄ SCENE SWITCHER (Change before time runs out):</label>
                <div id="listPanel" style="display:flex; gap:0; margin-bottom:5px;">
                    <button class="btn-live" style="background:#455a64; border-color:#37474f;" onclick="showJalsaScreen()">üè† TITLE SCREEN</button>
                    <button class="btn-live" style="background:#0d47a1; border-color:#002171;" onclick="forceStudentCard()">üéì STUDENT</button>
                    <button class="btn-live" style="background:#ff6f00; border-color:#c43e00;" onclick="forceTop5()">üèÜ TOP 5</button>
                </div>
            </div>
<div style="background:#ede7f6; padding:10px; border-radius:8px; border:1px solid #b39ddb; margin-bottom:15px;">
   
    <div style="border-top: 1px dashed #9575cd; padding-top: 5px; margin-top: 5px;">
        
            <div class="controls" style="display: flex; justify-content: center; gap: 10px;">
                <button class="action btn-nav" onclick="move(-1)">‚óÄ</button>
                <button class="action btn-live" onclick="updateTV()">üì∫ Display Student Name</button>
                <button class="action btn-nav" onclick="move(1)">‚ñ∂</button>
                <button class="action btn-nav" style="background:#c62828; font-size:16px;" onclick="clearTV()">X</button>
                <button class="action btn-nav" style="background:#f9a825; font-size:16px;" onclick="toggleAdsMode()" title="Advertisement Mode">üì¢</button>
            </div>

           <div class="video-panel">
    <div style="font-weight:bold; color:#0277bd; margin-bottom:5px;">üéûÔ∏è Video Player & Presentation</div>
    
    <div style="display:flex; gap:8px;">
        <label style="width:70%; font-size:12px; color:#555;">General Video Playlist:</label>
        <input type="file" id="videoPlaylist" accept="video/*" multiple style="width:70%">
        <button class="btn-vid" style="background:#e65100; width:15%; margin-right:2px;" onclick="playPrevVideo()">‚óÄ Back</button>
        <button class="btn-vid" style="background:#ef6c00; width:15%;" onclick="playNextVideo()">Next ‚ñ∂</button>
    </div>

    <div style="margin-top:5px;">
        <button class="btn-vid" style="background:#00695c; width:100%; font-weight:bold;" onclick="playGeneralSequence()">‚ñ∂ Play General Playlist (Sequential)</button>
    </div>
                
                <div style="display:flex; gap:10px; margin-top:5px; flex-wrap:wrap; background:#fff; padding:5px; border-radius:5px;">
    
    <label style="font-size:12px; display:inline-flex; align-items:center;">
        <input type="checkbox" id="vidOverlayCheck" onchange="toggleOverlayMode(this.checked)"> Video Overlay Card (Overlay)
    </label>

    <label style="font-size:12px; display:inline-flex; align-items:center; color:#c62828;">
        <input type="checkbox" id="top5ModeCheck"> <b>Top 5 Banner Mode (Royal)</b>
    </label>

    <label style="font-size:12px; display:inline-flex; align-items:center; color:#e65100;">
        <input type="checkbox" id="hideTrophyCheck" onchange="toggleTrophyVisibility(this.checked)"> <b>üö´ Hide Trophy</b>
    </label>

    <button class="btn-vid" style="background:#37474f; width:auto;" onclick="stopVideo()">‚èπ Stop</button>
</div>

                <hr style="border:1px dashed #ccc;">
                
                <div style="font-weight:bold; font-size:14px; margin-bottom:5px;">WEB & PRESENTATION:</div>
                <div style="display:flex; gap:8px; margin-top:5px;">
                    <input type="text" id="presLink" placeholder="Canva/Gamma Link (Auto-Fix)..." style="width:60%; text-align:left;" class="font-en">
                      <select id="presType" style="width:20%; font-size:12px;">
                          <option value="auto">Auto-Detect</option>
                          <option value="gamma">Gamma.app</option>
                          <option value="canva">Canva</option>
                          <option value="google">Google Slides</option>
                      </select>
                    <button class="btn-vid" style="background:#6a1b9a; width:20%;" onclick="showPresentation()">Open</button>
                </div>
                <div style="margin-top:5px;">
                      <button class="btn-vid" style="background:#d32f2f;" onclick="showPDFScreen()">üìÑ Show PDF</button>
                </div>
                
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <input type="text" id="ytLink" placeholder="YouTube Link (Any Format)..." style="width:50%; text-align:left;" class="font-en">
                    <button class="btn-vid" style="background:#c62828; width:30%;" onclick="playYoutube()">‚ñ∂ YouTube</button>
                    <button class="btn-vid" style="background:#0277bd; width:20%;" onclick="openYTPopup()">‚ö†Ô∏è Pop-up</button>
                </div>
                
                <div style="margin-top:10px;">
                    <button class="btn-vid" style="background:#2e7d32; width:100%; font-weight:bold;" onclick="forceShowTitles()">üîÑ Force Refresh Titles</button>
                </div>
            </div>
    <div id="statusMsg" style="font-weight:bold; color:#00695c; text-align:center; font-size:18px; margin:5px 0;">System Ready</div>
<div style="background:#ede7f6; padding:10px; border-radius:8px; border:1px solid #b39ddb; margin-bottom:15px; margin-top:10px;">
    <label style="color:#512da8; font-size:14px; margin-bottom:5px; font-weight:bold; display:block;">üñ•Ô∏è 3-Screen Controls & Calibration:</label>

    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <div style="flex:1;">
            <span style="font-size:10px; font-weight:bold;">Left Image:</span>
            <input type="file" accept="image/*" onchange="loadScreenBG('left', this)" style="font-size:11px;">
        </div>
        <div style="flex:1;">
            <span style="font-size:10px; font-weight:bold;">Right Image:</span>
            <input type="file" accept="image/*" onchange="loadScreenBG('right', this)" style="font-size:11px;">
        </div>
    </div>

    <button class="btn-vid" style="background:#673ab7; font-weight:bold; margin-bottom:10px;" onclick="toggleTripleMode()">
        Toggle 3-Screen Mode (On/Off)
    </button>

    <div style="border-top: 1px dashed #9575cd; padding-top: 10px;">
        <label style="font-size:11px; color:#512da8; font-weight:bold;">üî≠ Monitor Zoom (View Only):</label>
        <input type="range" min="0.2" max="1" step="0.05" value="1" oninput="setTVZoom(this.value)" style="height:10px; width:100%;">
    </div>

    <div style="background:#fff; padding:5px; border-radius:5px; margin-top:5px; border:1px solid #d1c4e9;">
        <label style="font-size:11px; font-weight:bold; color:#311b92;">üõ†Ô∏è Screen Calibration (Position):</label>
        
        <div style="display:flex; gap:5px; align-items:center; margin-top:3px;">
            <span style="font-size:10px; width:30px;">Left:</span>
            <input type="range" min="10" max="30" step="0.1" value="16.6" title="Width" oninput="adjustZone('left', 'width', this.value)">
            <input type="range" min="-100" max="100" step="1" value="0" title="Move X" oninput="adjustZone('left', 'left', this.value)">
        </div>

        <div style="display:flex; gap:5px; align-items:center; margin-top:3px;">
            <span style="font-size:10px; width:30px;">Right:</span>
            <input type="range" min="10" max="30" step="0.1" value="16.6" title="Width" oninput="adjustZone('right', 'width', this.value)">
            <input type="range" min="-100" max="100" step="1" value="0" title="Move X" oninput="adjustZone('right', 'right', this.value)">
        </div>
    </div>
</div>
            
            <div style="background:#fff; padding:20px; border-radius:10px; border:2px solid #90caf9; margin:15px 0; box-shadow:0 3px 10px rgba(0,0,0,0.05);">
                <h3 style="margin-top:0; font-size:22px; color:#0d47a1; border-bottom:1px solid #e3f2fd; padding-bottom:5px;">üéì Student Information</h3>
                
                <div style="margin-bottom: 10px;">
                    <label style="font-size:14px; color:#555;">Name (Dhivehi):</label>
                    <input id="nD" class="font-dv" placeholder="Name (Dhivehi)" style="width:100%;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="font-size:14px; color:#555; text-align:right; display:block;">Name (English):</label>
                    <input id="nE" class="eng" placeholder="Name (English)" style="width:100%; text-align:left;">
                </div>
                
                <div class="row" style="display:flex; gap:10px; width:100%;">
                    <div class="col" style="flex:1;">
                        <input id="fD" class="font-dv" placeholder="Detail 1 (Dhivehi)" style="width:100%; text-align:right;">
                    </div>
                    <div class="col" style="flex:1;">
                        <input id="fE" class="eng" placeholder="Detail 1 (English)" style="width:100%; direction:ltr; text-align:left;">
                    </div>
                </div>

                <div class="row" style="display:flex; gap:10px; width:100%; margin-top:5px;">
                    <div class="col" style="flex:1;">
                        <input id="cD" class="font-dv" placeholder="Detail 2 (Dhivehi)" style="width:100%; text-align:right;">
                    </div>
                    <div class="col" style="flex:1;">
                        <input id="cE" class="eng" placeholder="Detail 2 (English)" style="width:100%; direction:ltr; text-align:left;">
                    </div>
                </div>
                
                <div class="row" style="margin-top:5px;">
                    <label style="font-size:14px; color:#d84315;">üèÜ Rank/Position (Optional):</label>
                    <input id="rankInput" placeholder="1, 2, 3..." style="width:100%;">
                </div>
                
                <textarea id="cm" rows="2" class="font-dv" placeholder="Additional Information..."></textarea>

                <div class="preview-container">
                    <div><img id="logoPreview" alt="Logo" style="height:50px; opacity:0.5;"></div>
                    <div style="text-align:center;">
                        <span id="pStat" style="font-size:14px; font-weight:bold; color:#777;">No Photo</span><br>
                        <img id="previewImg" src="https://via.placeholder.com/150">
                        <br><button style="font-size:12px; padding:3px 8px; margin-top:5px; background:#607d8b; color:#fff; border:none; border-radius:4px;" onclick="document.getElementById('singlePhoto').click()">Change</button>
                        <input type="file" id="singlePhoto" accept="image/*" style="display:none" onchange="manualPhoto(this)">
                    </div>
                </div>
            </div>

            <div style="text-align:center; font-size:15px; color:#777; margin:20px 0; font-weight:bold; letter-spacing:1px; background:#eceff1; padding:5px; border-radius:20px;">‚¨á Settings and Design Control ‚¨á</div>

            <div id="designPanel"> 
                <div class="group-box" style="border-color:#ffca28; background:#fffde7;">
                    <span class="group-title" style="background:#ff6f00;">üèÜ Top 5 Mode & Video</span>
                    <div class="design-col">
                        <p style="font-size:12px; color:#555; margin-bottom:10px;">Select Layout to move Card (Left/Right/Bottom). Use Video Sliders to move video box anywhere!</p>
                        
                        <div style="margin-bottom:15px;">
                             <span style="font-weight:bold; font-size:14px;">1. Banner Layout Position:</span>
                             <select id="t5LayoutSel" onchange="liveUpdate('t5Layout', this.value)" style="width:100%; font-weight:bold; color:#d84315;">
                                 <option value="bottom">Bottom Banner (Default)</option>
                                 <option value="left">Left Sidebar (Left)</option>
                                 <option value="right">Right Sidebar (Right)</option>
                             </select>
                        </div>
                        
                        <div style="background:#fff; padding:10px; border-radius:5px; border:1px solid #ffcc80; margin-bottom:15px;">
                             <span style="font-weight:bold; font-size:14px; display:block; margin-bottom:5px;">2. Video Box Control (Move Anywhere):</span>
                             <div style="display:flex; gap:5px;">
                                 <span style="font-size:12px;">X:</span><input type="range" min="0" max="100" value="10" oninput="liveUpdate('tvX', this.value)">
                                 <span style="font-size:12px;">Y:</span><input type="range" min="0" max="100" value="5" oninput="liveUpdate('tvY', this.value)">
                             </div>
                             <div style="display:flex; gap:5px; margin-top:5px;">
                                 <span style="font-size:12px;">Width:</span><input type="range" min="10" max="100" value="80" oninput="liveUpdate('tvW', this.value)">
                                 <span style="font-size:12px;">Height:</span><input type="range" min="10" max="100" value="65" oninput="liveUpdate('tvH', this.value)">
                             </div>
                        </div>

                        <span style="font-weight:bold; font-size:14px;">3. Card Sizing:</span>
                        <div style="display:flex; gap:10px; align-items:center; margin-bottom:5px;">
                            <span style="font-size:14px; width:100px;">Banner Width:</span>
                            <input type="range" min="20" max="100" value="95" oninput="liveUpdate('t5CardW', this.value)">
                        </div>
                        <div style="display:flex; gap:10px; align-items:center; margin-bottom:5px;">
                            <span style="font-size:14px; width:100px;">Banner Height:</span>
                            <input type="range" min="10" max="100" value="22" oninput="liveUpdate('t5CardH', this.value)">
                        </div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <span style="font-size:14px; width:100px;">Photo Size:</span>
                            <input type="range" min="80" max="300" value="160" oninput="liveUpdate('t5PhotoSize', this.value)">
                        </div>
                        
                        <hr style="border:1px dashed #ffd54f; margin:10px 0;">
                        <span style="display:block; font-weight:bold; margin-bottom:5px; color:#ff6f00;">4. Top 5 Text Settings (Flexible):</span>
                        
                        <div style="display:flex; gap:5px; margin-bottom:5px; align-items:center;">
                            <span style="font-size:12px; width:80px; font-weight:bold; color:blue;">‚Üï Text Y-Pos:</span>
                            <input type="range" min="-300" max="300" value="0" oninput="liveUpdate('t5TextY', this.value)">
                        </div>

                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <span style="font-size:12px; width:80px;">Name (DV):</span>
                            <input type="range" min="0.5" max="5" step="0.1" value="3.0" oninput="liveUpdate('t5NameSize', this.value)">
                            <input type="color" value="#ffffff" oninput="liveUpdate('tnDColor', this.value)">
                        </div>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <span style="font-size:12px; width:80px;">Name (EN):</span>
                            <input type="range" min="0.5" max="5" step="0.1" value="2.0" oninput="liveUpdate('t5EngSize', this.value)">
                            <input type="color" value="#ffffff" oninput="liveUpdate('tnEColor', this.value)">
                        </div>
                        <div style="display:flex; gap:5px;">
                            <span style="font-size:12px; width:80px;">Details:</span>
                            <input type="range" min="0.5" max="3" step="0.1" value="1.5" oninput="liveUpdate('t5DetSize', this.value)">
                            <input type="color" value="#fff9c4" oninput="liveUpdate('tfDColor', this.value)">
                        </div>
                    </div>
                </div>
                
                <div class="group-box" style="border-color:#d4af37; background:#fff8e1;">
                    <span class="group-title" style="background:#ff8f00;">üèÖ Badges & Animation Control</span>
                    <div class="design-col">
                        <p style="font-size:12px; color:#555; margin-bottom:10px;">Move badges anywhere and select animations.</p>
                        
                        <div style="margin-bottom:10px; border-bottom:1px dashed #ccc; padding-bottom:10px;">
                           <span style="font-weight:bold; color:#ff6f00;">1. Star Badge:</span>

<div style="display:flex; gap:5px; margin-top:5px;">
    <span style="font-size:12px;">X:</span>
    <input type="range" min="-950" max="950" value="-20" oninput="liveUpdate('badgeX', this.value)">
    <span style="font-size:12px;">Y:</span>
    <input type="range" min="-950" max="950" value="-20" oninput="liveUpdate('badgeY', this.value)">
</div>

<div style="display:flex; gap:5px; margin-top:5px; align-items:center;">
    <span style="font-size:12px; width:40px;">Size:</span>
    <input type="range" min="50" max="600" value="200" oninput="liveUpdate('starSize', this.value)">
</div>

<div style="display:flex; gap:5px; margin-top:5px; align-items: center;">
    <span style="font-size:12px;">Anim:</span>
    <select onchange="liveUpdate('badgeAnim', this.value)" style="width:100%; font-size:12px;">
        <option value="none">None</option>
        <option value="spin">Spin (Rotate)</option>
        <option value="pulse">Pulse (Scale)</option>
        <option value="float">Float (Up/Down)</option>
    </select>
</div>
                                <span style="font-size:12px;">Anim:</span>
                                <select onchange="liveUpdate('badgeAnim', this.value)" style="width:100%; font-size:12px;">
                                    <option value="none">None</option>
                                    <option value="spin">Spin (Rotate)</option>
                                    <option value="pulse">Pulse (Scale)</option>
                                    <option value="float">Float (Up/Down)</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <span style="font-weight:bold; color:#ff6f00;">2. Trophy Badge:</span>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <span style="font-size:12px;">X:</span><input type="range" min="-950" max="950" value="-10" oninput="liveUpdate('trophyX', this.value)">
                                <span style="font-size:12px;">Y:</span><input type="range" min="-950" max="950" value="-10" oninput="liveUpdate('trophyY', this.value)">
                            </div>
                            <div style="display:flex; gap:5px; margin-top:5px; align-items: center;">
                                <span style="font-size:12px;">Anim:</span>
                                <select onchange="liveUpdate('trophyAnim', this.value)" style="width:100%; font-size:12px;">
                                    <option value="none">None</option>
                                    <option value="shine">Shine (Glow)</option>
                                    <option value="pulse">Pulse (Scale)</option>
                                    <option value="zoom">Zoom In</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="group-box">
                    <span class="group-title">üåç Theme and Background</span>
                    <div class="design-col">
                        <span class="d-label">1. Wallpaper Background:</span>
                        <div style="display:flex; gap:10px;">
                            <select id="bgPresetSel" onchange="liveUpdate('bgPreset', this.value)" style="width:70%;">
    
    <optgroup label="üëë Royal Green (Royal Green)">
        <script> for(let i=1; i<=20; i++) document.write(`<option value="bg${i}">Royal Green ${i}</option>`); </script>
    </optgroup>

    <optgroup label="üëë Royal Blue (Royal Blue)">
        <script> for(let i=21; i<=40; i++) document.write(`<option value="bg${i}">Royal Blue ${i}</option>`); </script>
    </optgroup>

    <optgroup label="üëë Royal Red (Royal Red)">
        <script> for(let i=41; i<=60; i++) document.write(`<option value="bg${i}">Royal Red ${i}</option>`); </script>
    </optgroup>

    <optgroup label="‚ö´ Luxury Black (Luxury Black)">
        <script> for(let i=61; i<=80; i++) document.write(`<option value="bg${i}">Luxury Dark ${i}</option>`); </script>
    </optgroup>

    <optgroup label="üåê Others (Modern/Mixed)">
        <script> for(let i=81; i<=200; i++) document.write(`<option value="bg${i}">Theme ${i}</option>`); </script>
    </optgroup>

</select>
                            <input type="file" id="jalsaBgFile" accept="video/*, image/*" style="width:30%" title="Upload Custom BG">
                        </div>
                        <div style="margin-top:8px;">
                            <select id="bgLoopSel" onchange="liveUpdate('bgLoop', this.value)" style="background:#fff;">
                                <option value="on">Video Loop: Yes</option>
                                <option value="off">Video Loop: No</option>
                            </select>
                        </div>
                        
                        <span class="d-label">2. Student Card Design (Normal Mode):</span>
<div style="display:flex; gap:10px;">

   <select id="cBorderSel" onchange="liveUpdate('cBorder', this.value)" style="width:75%;">
    <option value="custom_bg">üñºÔ∏è Custom Background (Image)</option>
    <option value="custom">üñºÔ∏è Custom Frame (Frame)</option>
    
    <optgroup label="üëë 1. The Golden State (Gold & Black)">
        <script> for(let i=1; i<=20; i++) document.write(`<option value="b${i}">Style ${i} - Presidential Gold</option>`); </script>
    </optgroup>

    <optgroup label="üå¥ 2. Royal Maldivian (Green & Gold)">
        <script> for(let i=21; i<=40; i++) document.write(`<option value="b${i}">Style ${i} - Royal Green</option>`); </script>
    </optgroup>

    <optgroup label="‚öì 3. The Diplomat (Blue & Silver)">
        <script> for(let i=41; i<=60; i++) document.write(`<option value="b${i}">Style ${i} - Royal Blue</option>`); </script>
    </optgroup>

    <optgroup label="üéñÔ∏è 4. The Red Carpet (Maroon & Red)">
        <script> for(let i=61; i<=80; i++) document.write(`<option value="b${i}">Style ${i} - Royal Red</option>`); </script>
    </optgroup>

    <optgroup label="üíé 5. Ultra Modern (Glass & VVIP)">
        <script> for(let i=81; i<=100; i++) document.write(`<option value="b${i}">Style ${i} - VVIP Modern</option>`); </script>
    </optgroup>

    <option value="b0">üö´ No Border (Transparent)</option>
</select>

    <input type="color" id="bdColorPick" value="#d4af37" oninput="liveUpdate('bdColor', this.value)" title="Theme Color">
</div>
                        <span class="d-label">3. Card Position:</span>
                        <div style="display:flex; gap:10px; align-items:center; background:#fff; padding:10px; border-radius:8px; border:1px solid #ccc;">
                            <span style="font-size:14px; font-weight:bold;">Right/Left:</span>
                            <input type="range" id="cardXRange" min="-600" max="600" value="0" oninput="liveUpdate('cardX', this.value)">
                            <span style="font-size:14px; font-weight:bold;">Top/Bottom:</span>
                            <input type="range" id="cardYRange" min="-450" max="450" value="0" oninput="liveUpdate('cardY', this.value)">
                        </div>

                        <span class="d-label">4. Card Size:</span>
                        <div style="display:flex; gap:15px; align-items:center;">
                            <span style="font-size:14px; font-weight:bold;">Width:</span>
                            <input type="range" id="cardWRange" min="50" max="100" value="90" oninput="liveUpdate('cardW', this.value)">
                            <span style="font-size:14px; font-weight:bold;">Height:</span>
                            <input type="range" id="cardHRange" min="50" max="100" value="80" oninput="liveUpdate('cardH', this.value)">
                        </div>
                        <div style="display:flex; gap:10px; margin-top:8px;">
                            <select id="layoutDirSel" onchange="liveUpdate('layoutDir', this.value)" style="width:50%;">
                                <option value="rtl">Photo on Right (RTL)</option>
                                <option value="ltr">Photo on Left (LTR)</option>
                            </select>
                            <select id="textAlignSel" onchange="liveUpdate('textAlign', this.value)" style="width:50%;">
                                <option value="right">Text: Right / Align Right</option>
                                <option value="center">Text: Center / Align Center</option>
                                <option value="left">Text: Left / Align Left</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="group-box">
                    <span class="group-title">üì∏ Photo Studio</span>
                    
                    <span class="d-label">1.Frame Style:</span>
                    <select id="photoPresetSel" onchange="applyPhotoPreset(this.value)" style="width:100%; font-weight:bold; font-size:15px; padding:10px;">
                        <option value="0">--- Select Frame Style ---</option>
                        <optgroup label="No Border or Shadow">
                            <option value="1">1. Normal (No Border)</option>
                            <option value="2">2. Soft Shadow</option>
                            <option value="3">3. Hard Shadow</option>
                            <option value="4">4. Glow</option>
                        </optgroup>
                        <optgroup label="Basic Borders">
                            <option value="5">5. Thin Black Line</option>
                            <option value="6">6. Thick Blue Frame</option>
                            <option value="7">7. Dotted Line</option>
                            <option value="8">8. Dashed Line</option>
                            <option value="9">9. Double Line</option>
                            <option value="10">10. Rounded Corners</option>
                            <option value="11">11. Circle</option>
                        </optgroup>
                        <optgroup label="Creative">
                            <option value="12">12. Inset 3D</option>
                            <option value="13">13. Outset 3D</option>
                            <option value="14">14. Polaroid Style</option>
                            <option value="15">15. Golden Groove</option>
                            <option value="16">16. Card Style</option>
                        </optgroup>
                    </select>

                    <span class="d-label">2. Frame Adjustment:</span>
                    <div style="display:flex; gap:10px; align-items:center; background:#fff; padding:10px; border-radius:8px; border:1px solid #b2dfdb;">
                        <span style="font-size:14px;">ﬁÜﬁ™ﬁçﬁ¶:</span><input type="color" id="pfColorPick" value="#000000" oninput="liveUpdate('pfColor', this.value)">
                        <span style="font-size:14px;">ﬁäﬁ™ﬁÖﬁßﬁâﬁ®ﬁÇﬁ∞:</span><input type="range" id="pfWidthRange" min="0" max="30" value="0" oninput="liveUpdate('pfWidth', this.value)">
                        <span style="font-size:14px;">ﬁàﬁ¶ﬁÅﬁ∞:</span><input type="range" id="pfRadiusRange" min="0" max="50" value="0" oninput="liveUpdate('pfRadius', this.value)">
                    </div>
                    
                    <span class="d-label">3. Photo Position & Zoom:</span>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:14px; width:50px;">Zoom:</span>
                        <input type="range" id="pSizeRange" min="150" max="800" value="260" oninput="liveUpdate('pSize', this.value)">
                        <select id="pVisSel" onchange="liveUpdate('pVis', this.value)" style="width:100px;"><option value="show">show</option><option value="hide">hide</option></select>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:8px; align-items:center;">
                        <span style="font-size:14px; width:50px;">ﬁâﬁ´ﬁàﬁ∞:</span>
                        <input type="range" id="pXRange" min="-600" max="600" value="0" title="X" oninput="liveUpdate('pX', this.value)">
                        <input type="range" id="pYRange" min="-400" max="400" value="0" title="Y" oninput="liveUpdate('pY', this.value)">
                    </div>
                    <div style="margin-top:10px;">
                        <select id="pFitSel" onchange="liveUpdate('pFit', this.value)">
                            <option value="cover">Fit: Fill Box (Cover)</option>
                            <option value="contain">Fit: Full Photo (Contain)</option>
                        </select>
                    </div>
                </div>

                <div class="group-box">
                    <span class="group-title">üî§ Text Alignment & Styling (Normal Mode)</span>
                    
                    <span class="d-label">1. Student Name (Size/Color):</span>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                        <span style="font-size:14px; width:60px;">Dhivehi:</span>
                        <input type="range" min="2" max="10" step="0.1" value="6.5" oninput="liveUpdate('tnDSize', this.value)">
                        <input type="color" value="#ffffff" oninput="liveUpdate('tnDColor', this.value)">
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                        <span style="font-size:14px; width:60px;">English:</span>
                        <input type="range" min="1" max="8" step="0.1" value="4.5" oninput="liveUpdate('tnESize', this.value)">
                        <input type="color" value="#ffffff" oninput="liveUpdate('tnEColor', this.value)">
                    </div>
                    <div style="margin-top:5px;">
                        <select onchange="liveUpdate('nLine', this.value)" style="background:#fff;">
                            <option value="off">Underline Name: No</option>
                            <option value="on">Underline Name: Yes</option>
                        </select>
                    </div>
                    
                    <hr style="border:1px dashed #aaa; margin:12px 0;">

                    <span class="d-label">2. Detail Lines:</span>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                        <span style="font-size:14px; width:60px;">Line1:</span>
                        <input type="range" min="1" max="6" step="0.1" value="2.5" oninput="liveUpdate('tfDSize', this.value)">
                        <input type="color" value="#fff9c4" oninput="liveUpdate('tfDColor', this.value)">
                    </div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:14px; width:60px;">Line 2:</span>
                        <input type="range" min="1" max="6" step="0.1" value="3.0" oninput="liveUpdate('tcDSize', this.value)">
                        <input type="color" value="#fff9c4" oninput="liveUpdate('tcDColor', this.value)">
                    </div>
                </div>

                <div class="group-box">
                    <span class="group-title">üëë Event Titles</span>
                    
                    <span class="d-label">1. Main Title:</span>
                    <input type="text" id="jLine1" placeholder="Main Title..." class="font-dv" oninput="updateJalsaText()">
                    
                    <div style="margin-top:5px;">
                        <select onchange="liveUpdate('tLine', this.value)" style="width:100%; background:#fff;">
                            <option value="on">Underline Main Title: YES</option>
                            <option value="off">Underline Main Title: NO</option>
                        </select>
                    </div>

                    <div style="display:flex; align-items:center; gap:15px; margin-top:8px; background:#fff; padding:10px; border-radius:8px; border:1px solid #bbdefb;">
                        <div style="flex:1;">
                            <span style="font-size:13px; color:#555; display:block;">Top/Bottom (Y):</span>
                            <input type="range" id="mtYRange" min="-600" max="600" value="210" oninput="liveUpdate('mtY', this.value)">
                            <span style="font-size:13px; color:#555; display:block;">Right/Left (X):</span>
                            <input type="range" id="mtXRange" min="-800" max="800" value="0" oninput="liveUpdate('mtX', this.value)">
                        </div>
                    </div>

                    <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
                        <span style="font-size:14px;">Size:</span>
                        <input type="range" id="mtSizeRange" min="2" max="10" step="0.1" value="5.6" oninput="liveUpdate('mtSize', this.value)">
                        <input type="color" id="mtColorPick" value="#d4af37" oninput="liveUpdate('mtColor', this.value)">
                        <select id="mtAlignSel" onchange="liveUpdate('mtAlign', this.value)" style="width:100px;"><option value="center">Center</option><option value="right">Right</option><option value="left">Left</option></select>
                    </div>
                    <div style="margin-top:5px;">
                        <label style="font-size:13px;"><input type="checkbox" id="keepTitleCheck" onchange="liveUpdate('keepTitle', this.checked)"> Keep Title with Student Card</label>
                    </div>

                    <hr style="border:1px dashed #999; margin:15px 0;">

                    <span class="d-label">2. Subtitles (7 Lines):</span>
                    
                    <div style="background:#e8eaf6; padding:10px; border-radius:8px; border:1px solid #c5cae9; margin-bottom:10px;">
                        <label style="font-size:12px;">Edit Style for Line:</label>
                        <select id="stStyleSelector" style="font-size:12px; padding:5px; margin-bottom:5px;">
                            <option value="1">Line 1</option>
                            <option value="2">Line 2</option>
                            <option value="3">Line 3</option>
                            <option value="4">Line 4</option>
                            <option value="5">Line 5</option>
                            <option value="6">Line 6</option>
                            <option value="7">Line 7</option>
                        </select>
                        <div style="display:flex; gap:5px;">
                            <input type="range" oninput="setSubtitleStyle('size', this.value)" min="1" max="6" step="0.1" value="2.6" title="Size">
                            <input type="color" oninput="setSubtitleStyle('color', this.value)" value="#ffffff" title="Color">
                        </div>
                    </div>

                    <input type="text" id="jLine2" placeholder="Subtitle 1" class="sub-title-input">
                    <input type="text" id="jLine3" placeholder="Subtitle 2" class="sub-title-input">
                    <input type="text" id="jLine4" placeholder="Subtitle 3" class="sub-title-input">
                    <input type="text" id="jLine5" placeholder="Subtitle 4" class="sub-title-input">
                    <input type="text" id="jLine6" placeholder="Subtitle 5" class="sub-title-input">
                    <input type="text" id="jLine7" placeholder="Subtitle 6" class="sub-title-input">
                    <input type="text" id="jLine8" placeholder="Subtitle 7" class="sub-title-input">
                    
                    <div style="display:flex; gap:10px; margin-top:8px; align-items:center;">
                        <span style="font-size:14px;">Align:</span>
                        <select id="stAlignSel" onchange="liveUpdate('stAlign', this.value)" style="width:100%; background:#fff;">
                            <option value="center">Center</option>
                            <option value="right">Right</option>
                            <option value="left">Left</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:8px; align-items:center;">
                          <span style="font-size:14px;">Y-Pos:</span>
                          <input type="range" id="stYRange" min="0" max="400" value="0" title="Space" oninput="liveUpdate('stY', this.value)">
                    </div>
                      <div style="display:flex; gap:10px; margin-top:8px; align-items:center;">
                          <span style="font-size:14px;">Gap:</span>
                          <input type="range" id="stGapRange" min="0" max="100" value="5" title="Gap" oninput="liveUpdate('stGap', this.value)">
                    </div>
                    <div style="margin-top:5px;">
                        <select onchange="liveUpdate('stLine', this.value)" style="background:#fff;">
                            <option value="off">Subtitle Underline: No</option>
                            <option value="on">Subtitle Underline: Yes</option>
                        </select>
                    </div>
                    
                    <button class="btn-vid" style="background:#2e7d32; width:100%; margin-top:15px; font-weight:bold; font-size:18px; padding:12px;" onclick="updateJalsaText()">Update Titles</button>
                </div>

                <div class="group-box">
                    <span class="group-title">üñºÔ∏è 5 Main Logo Manager</span>
                    <div style="background:#fff; padding:10px; border-radius:5px; margin-bottom:10px;">
                        <label style="font-size:12px;">Select Logo to Move:</label>
                        <select id="activeLogoIdx" onchange="refreshLogoInputs()" style="width:100%;">
                            <option value="0">Logo 1</option>
                            <option value="1">Logo 2</option>
                            <option value="2">Logo 3</option>
                            <option value="3">Logo 4</option>
                            <option value="4">Logo 5</option>
                        </select>
                    </div>
                    
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:12px;">Size:</span>
                        <input type="range" id="mlSize" min="20" max="500" value="100" oninput="updateLogoStyle('size', this.value)">
                    </div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:12px;">X-Pos:</span>
                        <input type="range" id="mlX" min="-950" max="950" value="0" oninput="updateLogoStyle('x', this.value)">
                    </div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-size:12px;">Y-Pos:</span>
                        <input type="range" id="mlY" min="-500" max="500" value="0" oninput="updateLogoStyle('y', this.value)">
                    </div>
                    
                      <div style="margin-top:8px;">
                        <label style="font-size:12px; display:inline-flex; align-items:center;">
                            <input type="checkbox" id="logoAutoHideCheck" checked onchange="liveUpdate('logoAutoHide', this.checked)"> Hide Main Logos when Student Card appears
                        </label>
                        <button class="btn-vid" style="background:#37474f; margin-top:5px;" onclick="toggleMainLogos()">üëÅÔ∏è Toggle Main Logos</button>
                    </div>
                    
                    <hr>
                    <span class="d-label" style="font-size:14px;">Partner Logos Settings:</span>
                      <div style="margin-bottom:8px;">
                          <label style="font-size:12px; display:inline-flex; align-items:center;">
                              <input type="checkbox" id="plAutoHideCheck" checked onchange="liveUpdate('plAutoHide', this.checked)"> Hide Partner Logos when Student Card appears
                          </label>
                      </div>
                      <div style="margin-bottom:8px;">
                          <button class="btn-vid" style="background:#455a64;" onclick="togglePartnerLogos()">üëÅÔ∏è Toggle Partner Logos</button>
                      </div>
                    <div style="display:flex; gap:5px;">
                          <span>Gap:</span><input type="range" oninput="liveUpdate('plGap', this.value)" min="0" max="100" value="20">
                          <span>Size:</span><input type="range" oninput="liveUpdate('plSize', this.value)" min="50" max="300" value="100">
                    </div>
                      <div style="display:flex; gap:5px; margin-top:5px;">
                          <span>Y-Pos:</span><input type="range" oninput="liveUpdate('plY', this.value)" min="-600" max="600" value="0">
                      </div>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                          <span>X-Pos:</span><input type="range" oninput="liveUpdate('plX', this.value)" min="-800" max="800" value="0">
                    </div>
                </div>

            </div>
        </div>
    </div>

<script>
    document.addEventListener('contextmenu', event => event.preventDefault());
    
    // --- FULL SCREEN ---
    function toggleControlFS() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                alert(`Error: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    // --- IMPROVED SECURITY FUNCTION ---
function verifyLicense() {
    var inputKey = document.getElementById('licenseKey').value.trim();
    var msgArea = document.getElementById('secMsg');
    var overlay = document.getElementById('securityOverlay');

    // ﬁÄﬁ™ﬁêﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁáﬁÆﬁåﬁ∞ﬁåﬁØ ﬁÑﬁ¨ﬁçﬁ™ﬁÇﬁ∞
    if (!inputKey) {
        msgArea.innerText = "‚ö†Ô∏è Please enter the license key!";
        return;
    }

    try {
        // 1. Decode Key
        var decodedString = atob(inputKey); 
        
        // 2. Strict Validation Check
        if (decodedString.indexOf("ROYAL_EXP_") !== 0) {
            throw new Error("Invalid Format");
        }

        var parts = decodedString.split('_');
        if (parts.length < 5) throw new Error("Incomplete Key");

        var expDateString = parts[2]; 
        var custName = parts[4];      
        var expDate = new Date(expDateString);
        var today = new Date();
        today.setHours(0,0,0,0); 

        // 3. Check Expiry
        if (today > expDate) {
            msgArea.innerText = "‚ùå The license has expired!";
            msgArea.style.color = "red";
            return;
        }

        // 4. Success - Remove Overlay completely from DOM
        // (ﬁâﬁ®ﬁáﬁ© ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁÄﬁ™ﬁÉﬁ® ﬁÜﬁØﬁëﬁ¶ﬁÅﬁ∞ﬁàﬁ™ﬁÉﬁ¨ ﬁÉﬁ¶ﬁáﬁ∞ﬁÜﬁßﬁåﬁ¨ﬁÉﬁ® ﬁéﬁÆﬁåﬁ¨ﬁÜﬁ¨ﬁàﬁ¨. ﬁçﬁÆﬁÜﬁ∞ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁáﬁ¨ﬁáﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁçﬁßﬁÇﬁ¨ﬁáﬁ¨ﬁàﬁ¨.)
        overlay.style.opacity = '0';
        setTimeout(function(){
            overlay.remove(); 
        }, 500);

        document.getElementById('mainApp').style.display = 'flex';
        document.getElementById('licenseStatus').innerText = "‚úÖ PLATINUM ACTIVE | " + custName;

    } catch (e) {
        msgArea.innerText = "‚ùå The key is incorrect!";
        msgArea.style.color = "red";
        document.getElementById('licenseKey').value = ""; // Clear input for security
    }
}
    // Allow "Enter" key to submit
    document.getElementById('licenseKey').addEventListener("keyup", e => { if (e.key === "Enter") verifyLicense(); });
  
    let tvWindow = null;
    let students = [];
    let photoFiles = {};
    
    // Top 5 Separation Arrays
    let top5Students = [];
    let top5PhotoFiles = {};
    let activeListMode = 'general'; 
    let top5VideoPlaylist = []; 
    
    let partnerLogosData = [];
    let mainLogosData = [];
    let adFiles = [];
    let adInterval = null;
    let adIndex = 0;
    let currentPhotoData = null;
    let currentFontData = null;
    let currentJalsaBgData = null;
    let currentJalsaBgType = 'none';
    let customBorderData = null;
    let customCardBgData = null;
    let royalStarData = null;
    let trophyData = null;
    
    let isLocked = false;
    let lastActiveState = 'title'; 
    let playlist = [];
    let currentVidIdx = 0;
    let pdfUrl = null;

    // Subtitle Styles Logic
    let stStyles = {};
    for(let i=1; i<=8; i++) stStyles[i] = { size: 2.6, color: '#ffffff' };

    function setSubtitleStyle(prop, val) {
        let line = document.getElementById('stStyleSelector').value;
        if(prop === 'size') stStyles[line].size = val;
        if(prop === 'color') stStyles[line].color = val;
        updateJalsaText();
    }

    // --- STATE MANAGER ---
   // --- STATE MANAGER (UPDATED FOR ROYAL GREEN DEFAULT) ---
    let designState = {
        // 1. Title Colors (Gold Default)
        mtY: 210, mtX: 0, mtSize: 5.6, 
        mtColor: '#FFD700', // ﬁùﬁßﬁÄﬁ© ﬁÉﬁ¶ﬁÇﬁ∞ﬁÜﬁ™ﬁçﬁ¶ (Royal Gold)
        mtAlign: 'center', tLine: 'on', keepTitle: false,
        
        stY: 0, stX: 0, stGap: 5, stLine: 'off', stAlign: 'center',
        
        logos: [
            {x:0, y:-300, s:150}, {x:-400, y:-300, s:100}, {x:400, y:-300, s:100}, {x:0, y:300, s:100}, {x:0, y:0, s:100}
        ],
        logoVisible: true, logoAutoHide: true,
        plGap: 20, plSize: 100, plAutoHide: true, plVisible: true, plY: 20, plX: 0,
        pSize: 260, pX: 0, pY: 0, pVis: 'show', pFit: 'cover',
        pfWidth: 0, pfColor: '#000000', pfStyle: 'solid', pfRadius: 0, pfShadow: 'none',
        
        // 2. Card & Background Defaults
        cBorder: 'b1',      // Style 1 (Royal Green Border)
        bdColor: '#FFD700', // Theme Color (Gold)
        bgPreset: 'bg1',    // Background 1 (Royal Green Wallpaper)
        
        layoutDir: 'rtl', textAlign: 'right', bgLoop: 'on',
        
        // 3. Student Name Colors (Gold & White)
        tnDSize: 6.5, 
        tnDColor: '#FFD700', // ﬁÇﬁ¶ﬁÇﬁ∞ (ﬁãﬁ®ﬁàﬁ¨ﬁÄﬁ®) - ﬁÉﬁ¶ﬁÇﬁ∞ﬁÜﬁ™ﬁçﬁ¶
        tnESize: 4.5, 
        tnEColor: '#ffffff', // Name (English) - White
        nLine: 'off',
        
        tfDSize: 2.5, tfDColor: '#fff9c4', tcDSize: 3.0, tcDColor: '#fff9c4',
        cardW: 90, cardH: 80, cardX: 0, cardY: 0,
        
        // TOP 5 SPECIFIC VARIABLES
        t5CardW: 95, t5CardH: 22, t5Bottom: 2, t5PhotoSize: 160,
        t5NameSize: 3.0, t5EngSize: 2.0, t5DetSize: 1.5,
        t5TextY: 0, 
        t5Layout: 'bottom', 
        tvX: 10, tvY: 5, tvW: 80, tvH: 65, 
        
        // BADGES & ANIMATIONS
        badgeX: -20, badgeY: -20, badgeAnim: 'none',
        trophyX: -10, trophyY: -10, trophyAnim: 'none'
    };

    // --- MAIN LOGO MANAGER (MEMORY SAFE VERSION) ---
function loadMainLogos(input) {
    // 1. ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁçﬁØﬁëﬁ™ﬁÜﬁÆﬁÅﬁ∞ﬁäﬁ¶ﬁáﬁ® ﬁÄﬁ™ﬁÉﬁ® ﬁçﬁØﬁéﬁØﬁåﬁ¶ﬁÜﬁ™ﬁéﬁ¨ ﬁâﬁ¨ﬁâﬁÆﬁÉﬁ© ﬁêﬁßﬁäﬁ™ﬁÜﬁÆﬁÅﬁ∞ﬁçﬁ™ﬁÇﬁ∞ (ﬁâﬁ™ﬁÄﬁ®ﬁÇﬁ∞ﬁâﬁ™ ﬁÑﬁ¶ﬁáﬁ®)
    if (typeof mainLogosData !== 'undefined' && mainLogosData.length > 0) {
        mainLogosData.forEach(url => URL.revokeObjectURL(url));
    }

    // 2. ﬁáﬁß ﬁçﬁØﬁéﬁØﬁåﬁ¶ﬁáﬁ∞ ﬁçﬁØﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
    mainLogosData = [];
    for(let f of input.files) {
        let url = URL.createObjectURL(f);
        mainLogosData.push(url);
    }

    renderMainLogos();
    alert(mainLogosData.length + " Main Logos Loaded (Memory Optimized).");
}

    function renderMainLogos() {
        if(!tvWindow || tvWindow.closed) return;
        const container = tvWindow.document.getElementById('mainLogosContainer');
        container.innerHTML = '';
        mainLogosData.forEach((src, idx) => {
            if(idx >= 5) return;
            const img = tvWindow.document.createElement('img');
            img.src = src;
            img.id = 'ml-'+idx;
            img.className = 'main-logo-img';
            const st = designState.logos[idx];
            img.style.width = st.s + 'px';
            img.style.transform = `translate(${st.x}px, ${st.y}px)`;
            container.appendChild(img);
        });
    }

    function refreshLogoInputs() {
        const idx = document.getElementById('activeLogoIdx').value;
        const st = designState.logos[idx];
        document.getElementById('mlSize').value = st.s;
        document.getElementById('mlX').value = st.x;
        document.getElementById('mlY').value = st.y;
    }

    function updateLogoStyle(prop, val) {
        const idx = document.getElementById('activeLogoIdx').value;
        designState.logos[idx][prop.replace('size', 's')] = parseInt(val); 
        
        if(!tvWindow || tvWindow.closed) return;
        const img = tvWindow.document.getElementById('ml-'+idx);
        if(img) {
            const st = designState.logos[idx];
            img.style.width = st.s + 'px';
            img.style.transform = `translate(${st.x}px, ${st.y}px)`;
        }
    }

    function toggleMainLogos() {
        designState.logoVisible = !designState.logoVisible;
        if(!tvWindow || tvWindow.closed) return;
        tvWindow.document.getElementById('mainLogosContainer').style.opacity = designState.logoVisible ? '1' : '0';
    }

    // --- LOCK FUNCTION (FINAL FIXED VERSION) ---
    function toggleLock() {
        isLocked = !isLocked;
        const btn = document.getElementById('lockBtn');
        
        // ﬁïﬁ≠ﬁñﬁ™ﬁéﬁ¶ﬁáﬁ®ﬁàﬁß ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁßﬁáﬁ®ÿå ﬁáﬁ®ﬁÇﬁ∞ﬁïﬁ™ﬁìﬁ∞ﬁåﬁ¶ﬁáﬁ∞ ﬁÄﬁÆﬁàﬁßﬁçﬁ™ﬁÇﬁ∞
        const allElements = document.querySelectorAll('input, select, textarea, button');

        // ﬁàﬁ®ﬁùﬁ™ﬁáﬁ¶ﬁçﬁ∞ﬁÜﬁÆﬁÅﬁ∞ ﬁçﬁÆﬁÜﬁ∞ ﬁÜﬁ™ﬁÉﬁß ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞ (ﬁÜﬁ™ﬁçﬁ¶ ﬁäﬁ¶ﬁÇﬁëﬁ™ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞)
        const sidebarFiles = document.getElementById('sidebarFiles');
        const designPanel = document.getElementById('designPanel');

        if (isLocked) {
            // --- LOCK MODE ON ---
            btn.innerHTML = "üîí SYSTEM LOCKED (LIVE MODE)";
            btn.classList.add('active');

            // ﬁêﬁ¶ﬁáﬁ®ﬁëﬁ∞ﬁÑﬁß ﬁáﬁ¶ﬁãﬁ® ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞ ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞ﬁéﬁ¨ ﬁÜﬁ™ﬁçﬁ¶ ﬁäﬁ¶ﬁÇﬁëﬁ™ﬁÜﬁÆﬁÅﬁ∞ﬁçﬁ™ﬁÇﬁ∞
            if(sidebarFiles) sidebarFiles.classList.add('locked-zone');
            if(designPanel) designPanel.classList.add('locked-zone');

            // ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁáﬁ¨ﬁáﬁ∞ﬁóﬁ¨ﬁáﬁ∞ ﬁóﬁ¨ﬁÜﬁ∞ﬁÜﬁÆﬁÅﬁ∞ÿå ﬁçﬁÆﬁÜﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁÇﬁ∞ﬁàﬁ© ﬁáﬁ¨ﬁáﬁ∞ﬁóﬁ¨ﬁÄﬁ® ﬁçﬁÆﬁÜﬁ∞ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
            allElements.forEach(el => {
                // 1. ﬁâﬁ®ﬁåﬁ¶ﬁÇﬁ™ﬁéﬁ¶ﬁáﬁ® ﬁâﬁ® ﬁçﬁ®ﬁîﬁ¶ﬁÇﬁ© ﬁçﬁÆﬁÜﬁ∞ ﬁÇﬁ™ﬁÜﬁÆﬁÅﬁ∞ ﬁãﬁ´ﬁÜﬁÆﬁÅﬁ∞ﬁçﬁ¶ﬁÇﬁ∞ﬁàﬁ© ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞ (EXCEPTIONS)
                if (
                    el.id === 'lockBtn' ||                   // ﬁçﬁÆﬁÜﬁ∞ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞
                    el.id === 'cpFsBtn' ||                   // ﬁäﬁ™ﬁçﬁ∞ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞
                    el.closest('#listPanel') ||              // ﬁâﬁ¨ﬁáﬁ®ﬁÇﬁ∞ ﬁìﬁ¶ﬁáﬁ®ﬁìﬁ∞ﬁçﬁ∞ / ﬁìﬁÆﬁïﬁ∞ 5 / ﬁêﬁ∞ﬁìﬁ´ﬁëﬁ¨ﬁÇﬁ∞ﬁìﬁ∞ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞
                    el.closest('.video-panel') ||            // ﬁàﬁ©ﬁëﬁ®ﬁáﬁØ ﬁáﬁ¶ﬁãﬁ® ﬁïﬁ∞ﬁÉﬁ¨ﬁíﬁ¨ﬁÇﬁ∞ﬁìﬁ≠ﬁùﬁ¶ﬁÇﬁ∞ ﬁÑﬁ¶ﬁáﬁ®
                    el.closest('.controls') ||               // ﬁçﬁ¶ﬁáﬁ®ﬁàﬁ∞/ﬁÇﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ﬁìﬁ∞/ﬁÑﬁ¨ﬁÜﬁ∞ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞
                    el.closest('.lang-tabs') ||              // ﬁÑﬁ¶ﬁÄﬁ™ﬁéﬁ¨ ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞ﬁåﬁ¶ﬁáﬁ∞
                    el.classList.contains('sec-input') ||    // ﬁêﬁ¨ﬁÜﬁ®ﬁáﬁ™ﬁÉﬁ®ﬁìﬁ© ﬁïﬁ®ﬁÇﬁ∞ ﬁñﬁ¶ﬁÄﬁßﬁÑﬁ¶ﬁáﬁ®
                    el.classList.contains('sec-btn')         // ﬁêﬁ¨ﬁÜﬁ®ﬁáﬁ™ﬁÉﬁ®ﬁìﬁ© ﬁÑﬁ¶ﬁìﬁ¶ﬁÇﬁ∞
                ) {
                    // ﬁâﬁ® ﬁÑﬁ¶ﬁáﬁ®ﬁåﬁ¶ﬁáﬁ∞ ﬁÄﬁ™ﬁÇﬁ∞ﬁÇﬁßﬁÇﬁ© ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁ®ﬁäﬁ¶ﬁáﬁ® (Do Nothing)
                    el.disabled = false; 
                } else {
                    // 2. ﬁãﬁ¨ﬁÇﬁ∞ ﬁÄﬁ™ﬁÉﬁ® ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁáﬁ¨ﬁáﬁ∞ﬁóﬁ¨ﬁáﬁ∞ ﬁçﬁÆﬁÜﬁ∞ ﬁàﬁßﬁÇﬁ¨ (ﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™ﬁÇﬁ∞ﬁéﬁ¨ ﬁÑﬁ¶ﬁîﬁßﬁáﬁ® ﬁëﬁ®ﬁíﬁ¶ﬁáﬁ®ﬁÇﬁ∞ ﬁÑﬁ¶ﬁáﬁ® ﬁÄﬁ®ﬁâﬁ¨ﬁÇﬁ≠ﬁéﬁÆﬁåﬁ¶ﬁÅﬁ∞)
                    el.disabled = true;
                }
            });
            
        } else {
            // --- UNLOCK MODE ---
            btn.innerHTML = "üîì ﬁÄﬁ™ﬁÖﬁ™ﬁàﬁ®ﬁäﬁ¶ﬁáﬁ® (ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ¨ﬁàﬁ≠ ﬁâﬁØﬁëﬁ™)";
            btn.classList.remove('active');

            // ﬁÜﬁ™ﬁçﬁ¶ ﬁáﬁ¶ﬁÇﬁÑﬁ™ﬁÉﬁß ﬁéﬁ¨ﬁÇﬁ¶ﬁáﬁ™ﬁÇﬁ∞
            if(sidebarFiles) sidebarFiles.classList.remove('locked-zone');
            if(designPanel) designPanel.classList.remove('locked-zone');

            // ﬁÄﬁ™ﬁÉﬁ®ﬁÄﬁß ﬁáﬁ¨ﬁáﬁ∞ﬁóﬁ¨ﬁáﬁ∞ ﬁáﬁ¨ﬁÇﬁ≠ﬁÑﬁ¶ﬁçﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞
            allElements.forEach(el => el.disabled = false);
        }
    }
    // --- UPDATED SAVE FUNCTION (COMBINED & FIXED) ---
function downloadConfig() {
    // 1. Save Subtitle Specific Styles
    designState.savedStStyles = stStyles;

    // 2. Save Written Titles (Saves what you typed in the boxes)
    designState.savedTitles = {
        t1: document.getElementById('jLine1').value,
        t2: document.getElementById('jLine2').value,
        t3: document.getElementById('jLine3').value,
        t4: document.getElementById('jLine4').value,
        t5: document.getElementById('jLine5').value,
        t6: document.getElementById('jLine6').value,
        t7: document.getElementById('jLine7').value,
        t8: document.getElementById('jLine8').value
    };

    // 3. Create and Download the File
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(designState));
    const a = document.createElement('a');
    a.href = dataStr;
    a.download = "royal_config_v33_full.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
}

    function loadConfig(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const loaded = JSON.parse(e.target.result);
                Object.assign(designState, loaded);
                
                // --- RESTORE SUBTITLE STYLES ---
                if(loaded.savedStStyles) {
                    stStyles = loaded.savedStStyles;
                }

                // --- RESTORE WRITTEN TITLES ---
                if(loaded.savedTitles) {
                    document.getElementById('jLine1').value = loaded.savedTitles.t1 || "";
                    document.getElementById('jLine2').value = loaded.savedTitles.t2 || "";
                    document.getElementById('jLine3').value = loaded.savedTitles.t3 || "";
                    document.getElementById('jLine4').value = loaded.savedTitles.t4 || "";
                    document.getElementById('jLine5').value = loaded.savedTitles.t5 || "";
                    document.getElementById('jLine6').value = loaded.savedTitles.t6 || "";
                    document.getElementById('jLine7').value = loaded.savedTitles.t7 || "";
                    document.getElementById('jLine8').value = loaded.savedTitles.t8 || "";
                }

                if(tvWindow && !tvWindow.closed) { 
                    for (const key in designState) { liveUpdate(key, designState[key]); }
                    renderMainLogos(); 
                    
                    // Force update titles visually on TV
                    updateJalsaText();
                }
                
                // Update checkbox states based on loaded settings
                if(designState.plAutoHide !== undefined) document.getElementById('plAutoHideCheck').checked = designState.plAutoHide;
                if(designState.logoAutoHide !== undefined) document.getElementById('logoAutoHideCheck').checked = designState.logoAutoHide;
                if(designState.keepTitle !== undefined) document.getElementById('keepTitleCheck').checked = designState.keepTitle;
                if(designState.t5Layout !== undefined) document.getElementById('t5LayoutSel').value = designState.t5Layout;
                
                refreshLogoInputs();
                alert("Settings & Titles Loaded Successfully!");

            } catch(err) { 
                console.error(err);
                alert("Invalid Config File"); 
            }
        };
        reader.readAsText(file);
    }
    function setVal(id, val) { const el = document.getElementById(id); if(el) el.value = val; }

    function applyPhotoPreset(val) {
        let w = 0, c = '#000000', s = 'solid', r = 0, sh = 'none';
        switch(val) {
            case "1": break;
            case "2": sh = '0 4px 8px rgba(0,0,0,0.3)'; break;
            case "3": sh = '5px 5px 0px rgba(0,0,0,1)'; break;
            case "4": sh = '0 0 15px rgba(0, 150, 255, 0.6)'; break;
            case "5": w=1; break;
            case "6": w=6; c='#0056b3'; break;
            case "7": w=4; c='#d9534f'; s='dotted'; break;
            case "8": w=4; c='#5cb85c'; s='dashed'; break;
            case "9": w=6; c='#f0ad4e'; s='double'; break;
            case "10": w=3; c='#333333'; r=10; break;
            case "11": w=3; c='#5bc0de'; r=50; break;
            case "12": w=10; c='#999999'; s='inset'; break;
            case "13": w=10; c='#999999'; s='outset'; break;
            case "14": w=15; c='#ffffff'; sh='0 2px 5px rgba(0,0,0,0.3)'; break;
            case "15": w=8; c='#FFD700'; s='groove'; break;
            case "16": w=5; c='#ffffff'; r=5; sh='0 4px 6px rgba(0,0,0,0.1)'; break;
        }
        setVal('pfWidthRange', w); setVal('pfColorPick', c); setVal('pfRadiusRange', r);
        liveUpdate('pfWidth', w); liveUpdate('pfColor', c); liveUpdate('pfStyle', s); 
        liveUpdate('pfRadius', r); liveUpdate('pfShadow', sh);
    }

   function liveUpdate(key, value) {
        if(isLocked) return; 
        designState[key] = value;
        if(!tvWindow || tvWindow.closed) return;
        const doc = tvWindow.document;
        const root = doc.documentElement;

        // --- ﬁâﬁ®ﬁáﬁ© ﬁáﬁ¶ﬁçﬁ¶ﬁÅﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® ﬁÑﬁ¶ﬁáﬁ® (STAR SIZE) ---
        if(key === 'starSize') {
             root.style.setProperty('--star-s', value + 'px');
        }
        // -------------------------------------------
// ﬁìﬁÆﬁïﬁ∞ 5 ﬁìﬁ¨ﬁÜﬁ∞ﬁêﬁ∞ﬁìﬁ∞ ﬁáﬁ¨ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ﬁâﬁ¶ﬁÇﬁ∞ﬁìﬁ∞
        if(key === 't5Align') {
             root.style.setProperty('--t5-align', value);
             
             if(value === 'left') root.style.setProperty('--t5-flex-align', 'flex-start');
             else if(value === 'right') root.style.setProperty('--t5-flex-align', 'flex-end');
             else root.style.setProperty('--t5-flex-align', 'center');
        }
        // BADGE & TROPHY UPDATES
        if(key === 'badgeX') root.style.setProperty('--star-x', value + 'px');
        if(key === 'badgeY') root.style.setProperty('--star-y', value + 'px');
        // BADGE & TROPHY UPDATES
        if(key === 'badgeX') root.style.setProperty('--star-x', value + 'px');
        if(key === 'badgeY') root.style.setProperty('--star-y', value + 'px');
        if(key === 'trophyX') root.style.setProperty('--troph-x', value + 'px');
        if(key === 'trophyY') root.style.setProperty('--troph-y', value + 'px');
        
        if(key === 'badgeAnim') {
            const el = doc.getElementById('royalStar');
            el.className = 'royal-star-badge'; // reset
            if(value !== 'none') el.classList.add('royal-anim-' + value);
        }
        if(key === 'trophyAnim') {
            const el = doc.getElementById('trophyWrap');
            el.className = 'trophy-badge'; // reset
            if(value !== 'none') el.classList.add('royal-anim-' + value);
        }

        // TOP 5 VARIABLES & VIDEO POS
        if(key === 't5CardW') root.style.setProperty('--t5-w', value + (designState.t5Layout==='bottom'?'%':'vw'));
        if(key === 't5CardH') root.style.setProperty('--t5-h', value + (designState.t5Layout==='bottom'?'%':'vh'));
        if(key === 't5Bottom') root.style.setProperty('--t5-b', value + '%');
        if(key === 't5PhotoSize') root.style.setProperty('--t5-p', value + 'px');
        if(key === 't5TextY') root.style.setProperty('--t5-text-y', value + 'px');
        
        if(key === 'tvX') root.style.setProperty('--tv-x', value + '%');
        if(key === 'tvY') root.style.setProperty('--tv-y', value + '%');
        if(key === 'tvW') root.style.setProperty('--tv-w', value + '%');
        if(key === 'tvH') root.style.setProperty('--tv-h', value + '%');
        
        if(key === 't5Layout') {
            const card = doc.getElementById('card');
            card.classList.remove('t5-bottom', 't5-left', 't5-right');
            card.classList.add('t5-' + value);
            liveUpdate('t5CardW', designState.t5CardW);
            liveUpdate('t5CardH', designState.t5CardH);
        }
        
        if(key === 't5NameSize') root.style.setProperty('--t5-n-s', value + 'em');
        if(key === 't5EngSize') root.style.setProperty('--t5-e-s', value + 'em');
        if(key === 't5DetSize') root.style.setProperty('--t5-d-s', value + 'em');

        if(key === 'pfWidth' || key === 'pfColor' || key === 'pfStyle' || key === 'pfRadius' || key === 'pfShadow') {
            const img = doc.getElementById('stuImg');
            if(img) {
                if(key === 'pfShadow') img.style.boxShadow = value;
                else {
                    img.style.borderWidth = designState.pfWidth + 'px';
                    img.style.borderColor = designState.pfColor;
                    img.style.borderStyle = designState.pfStyle;
                    img.style.borderRadius = designState.pfRadius + '%';
                }
            }
        }

        if(key === 'cardW') { const c = doc.getElementById('card'); if(c) { c.style.width = value + 'vw'; if(value>90) c.style.maxWidth='none'; else c.style.maxWidth='1500px'; } }
        if(key === 'cardH') { const c = doc.getElementById('card'); if(c) c.style.height = value + 'vh'; }
        if(key === 'cardX' || key === 'cardY') { 
            const c = doc.getElementById('card'); 
            if(c) c.style.transform = `translate(calc(-50% + ${designState.cardX}px), calc(-50% + ${designState.cardY}px))`; 
        }

        if(key === 'pVis') { const el = doc.querySelector('.photo-col'); if(el) el.style.visibility = (value === 'show') ? 'visible' : 'hidden'; }
        
        if(key === 'lSize') { const logoImg = doc.getElementById('logoImg'); if(logoImg) logoImg.style.height = value + 'px'; }
        if(key === 'bgLoop') { const vid = doc.getElementById('bgVid'); if(vid) vid.style.display = (value === 'on') ? 'block' : 'none'; }
        if(key === 'layoutDir') { const card = doc.getElementById('card'); if(card) card.style.flexDirection = (value === 'rtl') ? 'row-reverse' : 'row'; }
        if(key === 'textAlign') { const txt = doc.querySelector('.text-col'); if(txt) txt.style.textAlign = value; }
        if(key === 'bgPreset') { const bg = doc.getElementById('bgLayer'); if(bg) { bg.className = ''; bg.classList.add(value); } }
        if(key === 'bdColor') { doc.documentElement.style.setProperty('--theme-color', value); }
        
        if(key === 'mtY' || key === 'mtX') doc.getElementById('titleContainer').style.transform = `translate(${designState.mtX}px, ${designState.mtY}px)`;
        if(key === 'mtSize') doc.getElementById('jt1').style.fontSize = value + 'em';
        if(key === 'mtColor') { 
            const el = doc.getElementById('jt1'); el.style.color = value; 
            if(designState.tLine === 'on') el.style.borderBottomColor = value; 
        }
        if(key === 'tLine') {
            const el = doc.getElementById('jt1');
            if(value === 'on') { el.style.borderBottom = '3px solid ' + designState.mtColor; el.style.paddingBottom = '10px'; }
            else { el.style.borderBottom = 'none'; el.style.paddingBottom = '0'; }
        }
        if(key === 'mtAlign') { doc.getElementById('mainTitleWrap').style.textAlign = value; doc.getElementById('jt1').style.textAlign = value; }

        if(key === 'stY') doc.getElementById('subTitleWrap').style.marginTop = value + 'px';
        if(key === 'stGap') doc.getElementById('subTitleWrap').style.gap = value + 'px';
        if(key === 'stAlign') doc.getElementById('subTitleWrap').style.textAlign = value;
        if(key === 'stLine') { updateJalsaText(); }
        
        if(key === 'plSize') doc.querySelectorAll('.pl-img').forEach(el => el.style.height = value + 'px');
        if(key === 'plGap') doc.getElementById('plContainer').style.gap = value + 'px';
        if(key === 'plY') doc.getElementById('plContainer').style.bottom = value + 'px';
        if(key === 'plX') doc.getElementById('plContainer').style.transform = `translateX(${value}px)`;

        if(key === 'tnDColor') doc.getElementById('tnD').style.color = value;
        if(key === 'tnDSize') doc.getElementById('tnD').style.fontSize = value + 'em';
        if(key === 'tnESize') doc.getElementById('tnE').style.fontSize = value + 'em';
        if(key === 'tnEColor') doc.getElementById('tnE').style.color = value;
        
        if(key === 'nLine') {
            const h2 = doc.getElementById('tnE'); 
            if(value === 'on') { h2.style.borderBottom = '2px solid var(--theme-color)'; h2.style.display='inline-block'; }
            else { h2.style.borderBottom = 'none'; }
        }

        if(key === 'tfDSize') { doc.getElementById('tfD').style.fontSize = value + 'em'; doc.getElementById('tfE').style.fontSize = (value*0.8) + 'em'; }
        if(key === 'tfDColor') { doc.getElementById('tfD').style.color = value; doc.getElementById('tfE').style.color = value; }
        if(key === 'tcDSize') { doc.getElementById('tcD').style.fontSize = value + 'em'; doc.getElementById('tcE').style.fontSize = (value*0.8) + 'em'; }
        if(key === 'tcDColor') { doc.getElementById('tcD').style.color = value; doc.getElementById('tcE').style.color = value; }
        
        if(key === 'pSize') { const img = doc.getElementById('stuImg'); if(img) { img.style.width = value+'px'; img.style.height = value+'px'; } }
        if(key === 'pX' || key === 'pY') { const el = doc.querySelector('.photo-col'); if(el) el.style.transform = `translate(${designState.pX}px, ${designState.pY}px)`; }
        if(key === 'pFit') { const img = doc.getElementById('stuImg'); if(img) img.style.objectFit = value; }

        if(key === 'cBorder') {
            const card = doc.getElementById('card');
            if(card) {
                card.className = ''; card.classList.add(value);
                if(document.getElementById('top5ModeCheck').checked) card.classList.add('t5-'+designState.t5Layout);
                
                if(value === 'custom' && customBorderData) {
                    card.style.backgroundImage = `url(${customBorderData})`; card.style.backgroundSize = "100% 100%"; card.style.border = "none"; card.style.boxShadow = "none";
                } else if (value === 'custom_bg' && customCardBgData) {
                    card.style.backgroundImage = `url(${customCardBgData})`; card.style.backgroundSize = "100% 100%"; card.style.border = "none"; card.style.boxShadow = "none";
                } else { card.style.backgroundImage = "none"; }
                
                if(value !== 'b1' && value !== 'b0') card.classList.add('active');
            }
        }
    }

    // --- TV WINDOW ---
    function openTV() {
        tvWindow = window.open('', 'GradTV', 'width=1280,height=720,menubar=no,toolbar=no');
        if(!tvWindow) { alert("Please Allow Popups!"); return; }

        let fontCSS = `url('Fonts/faruuma.ttf') format('truetype')`;
        if (currentFontData) fontCSS = `url('${currentFontData}') format('truetype')`;

       // ============================================================
        // 200 ROYAL THEMES GENERATOR (SORTED BY COLOR)
        // ============================================================
        let cssGen = "";
        
        // Helper to create gradients
        const makeGrad = (c1, c2, type="linear") => {
            return type === "radial" 
                ? `radial-gradient(circle, ${c1}, ${c2})` 
                : `linear-gradient(to bottom right, ${c1}, ${c2})`;
        };

        const themes = [];

        // 1-20: ROYAL GREEN (ﬁùﬁßﬁÄﬁ© ﬁäﬁ¨ﬁÄﬁ®) - Top Priority
        const greens = ['#00281c', '#004d40', '#1b5e20', '#003300', '#2e7d32'];
        for(let i=0; i<20; i++) {
            let c1 = greens[i % greens.length];
            let c2 = i % 2 === 0 ? '#000000' : '#001a12';
            themes.push(makeGrad(c1, c2, i%3===0 ? 'radial' : 'linear'));
        }

        // 21-40: ROYAL BLUE (ﬁùﬁßﬁÄﬁ© ﬁÇﬁ´)
        const blues = ['#001b3d', '#0d47a1', '#002171', '#01579b', '#1a237e'];
        for(let i=0; i<20; i++) {
            let c1 = blues[i % blues.length];
            let c2 = i % 2 === 0 ? '#000000' : '#000022';
            themes.push(makeGrad(c1, c2, i%3===0 ? 'radial' : 'linear'));
        }

        // 41-60: ROYAL RED/MAROON (ﬁùﬁßﬁÄﬁ© ﬁÉﬁ¶ﬁåﬁ∞)
        const reds = ['#b71c1c', '#880e4f', '#4a0000', '#3e2723', '#800000'];
        for(let i=0; i<20; i++) {
            let c1 = reds[i % reds.length];
            let c2 = '#000000';
            themes.push(makeGrad(c1, c2));
        }

        // 61-80: BLACK & GOLD (ﬁçﬁ¶ﬁéﬁ∞ﬁíﬁ¶ﬁÉﬁ© ﬁÜﬁ¶ﬁÖﬁßﬁáﬁ® ﬁÉﬁ¶ﬁÇﬁ∞)
        for(let i=0; i<20; i++) {
            if(i%2===0) themes.push("radial-gradient(circle, #333, #000)");
            else themes.push("linear-gradient(135deg, #000 0%, #434343 100%)");
        }

        // 81-120: PURPLE & MODERN (ﬁíﬁ¶ﬁâﬁßﬁÇﬁ©)
        const purples = ['#4a148c', '#311b92', '#1a0033'];
        for(let i=0; i<40; i++) {
            let c1 = purples[i % purples.length];
            themes.push(makeGrad(c1, '#000'));
        }

        // 121-200: MIXED & ANIMATED STYLES (ﬁáﬁ¨ﬁÄﬁ¨ﬁÇﬁ®ﬁÄﬁ¨ﬁÇﬁ∞)
        const mixed = [
            "linear-gradient(to right, #0f2027, #203a43, #2c5364)",
            "conic-gradient(from 180deg at 50% 50%, #004d40 0deg, #00281c 360deg)",
            "repeating-linear-gradient(45deg, #111, #111 10px, #222 10px, #222 20px)",
            "linear-gradient(to top, #30cfd0 0%, #330867 100%)",
            "radial-gradient(circle at center, #665c00, #000)"
        ];
        for(let i=0; i<80; i++) {
            themes.push(mixed[i % mixed.length]);
        }

        // ============================================================
        // 1. BACKGROUND THEMES GENERATOR (FIXED)
        // ============================================================
        // Themes ﬁÄﬁ™ﬁêﬁ∞ﬁàﬁ®ﬁîﬁ¶ ﬁÇﬁ™ﬁãﬁ®ﬁÇﬁ™ﬁâﬁ¶ﬁÅﬁ∞ % (Modulus) ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁÜﬁÆﬁÅﬁ∞ﬁäﬁ¶ﬁáﬁ®
        for(let i=0; i<200; i++) {
            // Safety check: if themes array exists
            if(typeof themes !== 'undefined' && themes.length > 0) {
                let themeColor = themes[i % themes.length]; 
                cssGen += `.bg${i+1} { background: ${themeColor}; background-size: cover; }\n`;
            }
        }

        // 2. NO BORDER STYLE (.b0)
        cssGen += `.b0 { border: none; background: rgba(0,20,15,0.8) !important; box-shadow: none; }\n`;

        // ============================================================
        // 3. 100 ULTRA-LUXURY ROYAL STYLES (PRESIDENTIAL EDITION)
        // ============================================================
        const baseStyles = [
            // --- CATEGORY 1: THE GOLDEN STATE (Presidential Gold & Black) ---
            "border: 4px solid #FFD700; background: linear-gradient(135deg, #000 0%, #1a1a1a 100%); box-shadow: 0 0 25px rgba(255, 215, 0, 0.4); border-radius: 12px;", // 1
            "border-left: 8px solid #C5A059; background: #0a0a0a; border-right: 1px solid #C5A059; box-shadow: 0 10px 30px rgba(0,0,0,0.8);", // 2
            "border: double 6px #B8860B; background: radial-gradient(circle at center, #1c1c1c, #000); border-radius: 8px;", // 3
            "border: 2px solid #FFD700; outline: 1px solid #FFD700; outline-offset: 6px; background: #050505; margin:10px;", // 4
            "border-top: 4px solid #FFD700; border-bottom: 4px solid #FFD700; background: linear-gradient(to right, #000, #111, #000);", // 5
            "box-shadow: 0 0 0 4px #000, 0 0 0 7px #C5A059; background: #111; border-radius: 4px;", // 6
            "border: 1px solid #FFD700; background: #000; box-shadow: inset 0 0 50px rgba(197, 160, 89, 0.2);", // 7
            "border-left: 15px solid #FFD700; border-radius: 0 20px 20px 0; background: linear-gradient(90deg, #000, #1a1a1a);", // 8
            "border: 3px solid #D4AF37; border-radius: 30px 0 30px 0; background: #080808; box-shadow: 5px 5px 0 #D4AF37;", // 9
            "border: 5px groove #B8860B; background: #0f0f0f; border-radius: 2px;", // 10
            "background: linear-gradient(#000, #000) padding-box, linear-gradient(45deg, #FFD700, #B8860B) border-box; border: 3px solid transparent; border-radius: 15px;", // 11
            "border-bottom: 5px solid #FFD700; background: linear-gradient(to top, rgba(197, 160, 89, 0.1), #000); border-radius: 0 0 10px 10px;", // 12
            "border: 1px solid #333; box-shadow: 0 0 15px #FFD700; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px);", // 13
            "border-left: 2px solid #FFD700; border-right: 2px solid #FFD700; background: #000;", // 14
            "border: 4px inset #C5A059; background: #1a1a1a; box-shadow: 0 5px 15px #000;", // 15
            "border: 2px solid #FFD700; transform: skew(-5deg); background: #0d0d0d; margin-left:10px;", // 16
            "border-top: 10px solid #B8860B; background: #050505; border-radius: 10px 10px 0 0;", // 17
            "border: 1px solid #FFD700; outline: 4px solid #000; outline-offset: -8px; background: #111;", // 18
            "box-shadow: 0 0 30px rgba(255, 215, 0, 0.2); border: 1px solid #444; background: #000; border-radius: 25px;", // 19
            "border: none; background: #000; border-left: 5px solid #FFD700; border-top: 1px solid #FFD700;", // 20

            // --- CATEGORY 2: THE ROYAL MALDIVIAN (Deep Green & Gold) ---
            "border: 4px solid #FFD700; background: linear-gradient(135deg, #00281c 0%, #004d40 100%); border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);", // 21
            "border-left: 12px solid #C5A059; background: #003322; border-radius: 5px;", // 22
            "border: 2px solid #fff; outline: 3px solid #004d40; outline-offset: 3px; background: #00281c;", // 23
            "border: 6px double #FFD700; background: #001a12; border-radius: 10px;", // 24
            "background: radial-gradient(circle, #004d40, #001a12); border: 2px solid #00695c; box-shadow: 0 0 20px #000;", // 25
            "border-top: 3px solid #FFD700; border-bottom: 3px solid #FFD700; background: linear-gradient(90deg, #00281c, #004d40, #00281c);", // 26
            "border: 1px solid #C5A059; box-shadow: inset 0 0 40px rgba(0,0,0,0.8); background: #00281c;", // 27
            "border-left: 20px solid #004d40; border-right: 5px solid #FFD700; background: #001a12;", // 28
            "border: 3px dashed #FFD700; background: rgba(0, 40, 28, 0.9); border-radius: 15px;", // 29
            "border: 8px solid #003322; border-image: linear-gradient(to bottom, #FFD700, #003322) 1; background: #001a12;", // 30
            "border-radius: 50px; border: 4px solid #FFD700; background: #00281c;", // 31
            "border-right: 15px solid #C5A059; background: linear-gradient(to left, #00281c, #000);", // 32
            "border: 1px solid #fff; box-shadow: 0 0 15px #004d40; background: #001a12;", // 33
            "border: 5px outset #004d40; background: #00281c;", // 34
            "border-left: 2px solid #FFD700; border-top: 2px solid #FFD700; border-radius: 20px 0 0 0; background: #003322;", // 35
            "box-shadow: 0 10px 0 #00281c; border: 1px solid #FFD700; background: #001a12;", // 36
            "border: 3px solid #C5A059; outline: 1px dashed #fff; outline-offset: -10px; background: #00281c;", // 37
            "background: linear-gradient(#001a12, #001a12) padding-box, linear-gradient(135deg, #FFD700, #004d40) border-box; border: 4px solid transparent;", // 38
            "border-bottom: 8px solid #FFD700; border-radius: 0 0 20px 20px; background: #00281c;", // 39
            "border: none; box-shadow: 0 0 50px rgba(0, 77, 64, 0.5); background: #001a12;", // 40

            // --- CATEGORY 3: THE DIPLOMAT (Royal Blue & Silver/Platinum) ---
            "border: 4px solid #C0C0C0; background: linear-gradient(135deg, #001b3d 0%, #0d47a1 100%); border-radius: 12px;", // 41
            "border-left: 10px solid #fff; background: #001b3d; box-shadow: 5px 5px 15px rgba(0,0,0,0.5);", // 42
            "border: 6px double #C0C0C0; background: radial-gradient(circle, #0d47a1, #000022);", // 43
            "border: 2px solid #fff; outline: 2px solid #0d47a1; outline-offset: 4px; background: #001b3d;", // 44
            "border-top: 6px solid #C0C0C0; border-bottom: 6px solid #C0C0C0; background: linear-gradient(90deg, #000022, #001b3d, #000022);", // 45
            "box-shadow: 0 0 0 3px #001b3d, 0 0 0 6px #C0C0C0; border-radius: 8px; background: #000;", // 46
            "border: 1px solid #fff; background: #001b3d; box-shadow: inset 0 0 30px rgba(255,255,255,0.1);", // 47
            "border-left: 20px solid #0d47a1; border-right: 2px solid #C0C0C0; background: linear-gradient(to right, #000, #001b3d);", // 48
            "border: 3px solid #C0C0C0; border-radius: 0 40px 0 40px; background: #001b3d;", // 49
            "border: 10px inset #002171; background: #000022;", // 50
            "background: linear-gradient(#001b3d, #001b3d) padding-box, linear-gradient(45deg, #fff, #0d47a1) border-box; border: 3px solid transparent;", // 51
            "border-bottom: 6px solid #fff; background: linear-gradient(to top, #001b3d, #000);", // 52
            "border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 0 20px #0d47a1; background: rgba(13, 71, 161, 0.4); backdrop-filter: blur(15px);", // 53
            "border-left: 2px solid #fff; border-right: 2px solid #fff; background: #001b3d;", // 54
            "border: 4px ridge #4fc3f7; background: #000022; border-radius: 5px;", // 55
            "border: 2px solid #C0C0C0; transform: perspective(600px) rotateX(5deg); background: #001b3d; margin-bottom:10px;", // 56
            "border-top: 10px solid #0d47a1; background: #000022; border-radius: 15px 15px 0 0;", // 57
            "border: 1px solid #fff; outline: 1px solid #fff; outline-offset: 5px; background: #001b3d;", // 58
            "box-shadow: 0 0 30px rgba(13, 71, 161, 0.4); border: 1px solid #0d47a1; background: #000; border-radius: 30px;", // 59
            "border: none; background: #001b3d; border-left: 10px solid #fff; border-radius: 0 20px 20px 0;", // 60

            // --- CATEGORY 4: THE RED CARPET (Maroon, Red & Gold) ---
            "border: 4px solid #FFD700; background: linear-gradient(to bottom, #4a0000, #880e4f); box-shadow: 0 0 20px #880e4f;", // 61
            "border-left: 10px solid #800000; border-right: 10px solid #800000; background: #220000;", // 62
            "border: 6px double #FFD700; background: radial-gradient(circle, #880e4f, #330000); border-radius: 10px;", // 63
            "border: 2px solid #b71c1c; outline: 2px solid #FFD700; outline-offset: 4px; background: #2b0000;", // 64
            "border-top: 5px solid #FFD700; border-bottom: 5px solid #880e4f; background: linear-gradient(90deg, #220000, #4a0000, #220000);", // 65
            "box-shadow: 0 0 0 5px #4a0000, 0 0 0 8px #FFD700; background: #110000;", // 66
            "border: 3px solid #FFD700; border-radius: 40px; background: #4a0000; box-shadow: inset 0 0 20px #000;", // 67
            "border: 1px solid #FFD700; box-shadow: 0 0 25px #b71c1c; background: #220000;", // 68
            "border-left: 20px solid #880e4f; border-right: 2px solid #FFD700; background: #1a0000;", // 69
            "border: 8px ridge #b71c1c; background: #330000; border-radius: 5px;", // 70
            "background: linear-gradient(#220000, #220000) padding-box, linear-gradient(135deg, #FFD700, #b71c1c) border-box; border: 4px solid transparent;", // 71
            "border-bottom: 10px solid #FFD700; background: #4a0000;", // 72
            "border: 1px solid rgba(255,255,255,0.3); background: rgba(136, 14, 79, 0.7); backdrop-filter: blur(10px); box-shadow: 0 0 15px #000;", // 73
            "border-left: 2px solid #FFD700; border-right: 2px solid #FFD700; background: #330000;", // 74
            "border: 5px inset #b71c1c; background: #1a0000;", // 75
            "border: 2px solid #FFD700; transform: skewX(-10deg); background: #4a0000; margin-left:10px;", // 76
            "border-top: 10px solid #b71c1c; background: #000; border-radius: 20px 20px 0 0;", // 77
            "border: 1px solid #FFD700; outline: 4px solid #220000; outline-offset: -8px; background: #110000;", // 78
            "box-shadow: 0 0 40px #880e4f; border: none; background: #1a0000; border-radius: 10px;", // 79
            "border: none; background: linear-gradient(to right, transparent, #4a0000, transparent); border-top: 2px solid #FFD700; border-bottom: 2px solid #FFD700;", // 80

            // --- CATEGORY 5: ULTRA MODERN VVIP (Glass, Borderless, Minimalist) ---
            "border: none; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); border: 1px solid rgba(255, 255, 255, 0.18);", // 81 (Glass)
            "border: none; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0)); backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.18); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);", // 82 (Frost)
            "border-left: 5px solid #FFD700; background: rgba(0,0,0,0.8); box-shadow: 10px 10px 30px rgba(0,0,0,0.5);", // 83
            "border: none; background: #000; box-shadow: 0 20px 50px rgba(0,0,0,0.7); border-radius: 30px;", // 84
            "border: 1px solid #333; background: #111; box-shadow: 0 0 50px rgba(255,255,255,0.05);", // 85
            "border: none; background: linear-gradient(to right, rgba(0,0,0,0.9), rgba(0,0,0,0.6)); border-right: 5px solid #FFD700;", // 86
            "border: none; background: radial-gradient(circle at top right, #222, #000); border-radius: 0 0 0 50px; box-shadow: 5px 5px 15px #000;", // 87
            "border: 2px dashed #555; background: rgba(0,0,0,0.8); border-radius: 15px;", // 88
            "border-top: 1px solid #FFD700; border-bottom: 1px solid #FFD700; background: rgba(0,0,0,0.9);", // 89
            "border: 1px solid rgba(255,215,0,0.3); background: rgba(0,0,0,0.8); box-shadow: 0 0 30px rgba(255,215,0,0.1);", // 90
            "border: none; background: #050505; border-radius: 10px; border-left: 10px solid #FFD700;", // 91
            "border: none; background: #050505; border-radius: 10px; border-right: 10px solid #FFD700;", // 92
            "border: none; background: #000; box-shadow: 0 -10px 20px rgba(255,255,255,0.1);", // 93
            "border: 10px solid #111; background: #000; outline: 1px solid #333;", // 94
            "border: none; background: linear-gradient(45deg, #111 25%, transparent 25%, transparent 75%, #111 75%, #111), linear-gradient(45deg, #111 25%, transparent 25%, transparent 75%, #111 75%, #111); background-color: #000; background-size: 20px 20px; box-shadow: 0 0 10px #000;", // 95
            "border: 1px solid #FFD700; background: transparent; box-shadow: inset 0 0 100px #000;", // 96
            "border: none; background: rgba(20,20,20,0.9); border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);", // 97
            "border-left: 20px solid #333; background: #000; border-radius: 0 20px 20px 0;", // 98
            "border: 2px solid #222; background: #000; box-shadow: 5px 5px 0 #222;", // 99
            "border: double 10px transparent; border-radius: 10px; background-image: linear-gradient(#000, #000), linear-gradient(to right, #FFD700, #004d40); background-origin: border-box; background-clip: content-box, border-box;" // 100
        ];

       // 4. STYLE LOOP (ULTIMATE FIX FOR TOP 5)
        for(let i=0; i<200; i++) {
            let style = baseStyles[i % baseStyles.length]; 
            
            // 1. ﬁâﬁ¶ﬁáﬁ®ﬁéﬁ¶ﬁÇﬁëﬁ™ ﬁÜﬁßﬁëﬁ™ﬁéﬁ¨ ﬁêﬁ∞ﬁìﬁ¶ﬁáﬁ®ﬁçﬁ∞ (Main Card)
            cssGen += `.b${i+1} { ${style} }\n`;

            // 2. ﬁìﬁÆﬁïﬁ∞ 5 ﬁéﬁ¨ ﬁÜﬁ™ﬁãﬁ® ﬁÜﬁßﬁëﬁ™ﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ (Force Style on List Items)
            // ﬁâﬁ®ﬁáﬁ®ﬁÇﬁ∞ ﬁêﬁ©ﬁãﬁß ﬁçﬁ®ﬁêﬁ∞ﬁìﬁ™ﬁéﬁ¨ ﬁåﬁ¨ﬁÉﬁ≠ﬁéﬁ¶ﬁáﬁ® ﬁÄﬁ™ﬁÇﬁ∞ﬁÇﬁ¶ DIV ﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁêﬁ∞ﬁìﬁ¶ﬁáﬁ®ﬁçﬁ∞ ﬁÇﬁ¶ﬁéﬁßﬁÇﬁ¨
            cssGen += `.b${i+1} #top5List > div, .b${i+1} .t5-item { 
                ${style} 
                /* Resetting layout properties to fit inside list */
                position: relative !important; 
                top: auto !important; 
                left: auto !important; 
                transform: none !important; 
                width: 96% !important; 
                height: auto !important;
                margin: 8px auto !important;
                min-height: 65px !important;
                display: flex !important;
                align-items: center !important;
                padding: 0 15px !important;
                box-sizing: border-box !important;
                font-size: 1.2rem !important; 
                z-index: 100 !important;
            }\n`;
        }
        const html = `
        <!DOCTYPE html>
        <html lang="dv" dir="rtl">
        <head>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thaana:wght@400;700&display=swap');
                @font-face { font-family: 'Faruuma'; src: ${fontCSS}; }
                :root { 
                    --theme-color: ${designState.bdColor}; --royal-accent: #c5a059; 
                    /* TOP 5 VARIABLES */
                    --t5-w: ${designState.t5CardW}${designState.t5Layout==='bottom'?'%':'vw'}; 
                    --t5-h: ${designState.t5CardH}${designState.t5Layout==='bottom'?'%':'vh'}; 
                    --t5-b: ${designState.t5Bottom}%; --t5-p: ${designState.t5PhotoSize}px;
                    --t5-n-s: ${designState.t5NameSize}em; --t5-e-s: ${designState.t5EngSize}em; --t5-d-s: ${designState.t5DetSize}em;
                    /* TEXT POSITION FIX */
                    --t5-text-y: ${designState.t5TextY}px;
                    /* VIDEO BOX VARIABLES */
                    --tv-x: ${designState.tvX}%; --tv-y: ${designState.tvY}%;
                    --tv-w: ${designState.tvW}%; --tv-h: ${designState.tvH}%;
                    /* BADGE VARIABLES */
                    --star-x: ${designState.badgeX}px; --star-y: ${designState.badgeY}px;
                    --troph-x: ${designState.trophyX}px; --troph-y: ${designState.trophyY}px;
                }
                /* Custom Font Rules - Dynamic Loading */
                @font-face { font-family: 'Faruuma'; src: ${fontCSS}; }

                /* Apply Font to ALL elements including inputs and classes */
                body, h1, h2, h3, div, span, p, input, .jalsa-text, .font-dv, .font-en { 
                    font-family: 'Faruuma', 'MV Boli', 'Noto Sans Thaana', serif !important; 
                }
                body { margin:0; overflow:hidden; background:#000; user-select:none; }
                #fsBtn { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:9999; padding:20px; font-size:20px; cursor:pointer; background:var(--theme-color); border:2px solid #fff; }
                
                #bgLayer { position:fixed; top:0; left:0; width:100%; height:100%; z-index:0; transition: background 0.5s ease; }
                ${cssGen}

                #jalsaContent { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10; transition: opacity 0.8s ease; opacity:1; }
                #jalsaContent.hidden { opacity: 0; pointer-events:none; visibility: hidden; }
                
                #titleContainer { width: 90%; max-width: 1600px; text-align: center; } 
                #mainTitleWrap { width: 100%; text-align: ${designState.mtAlign}; } 
                #subTitleWrap { width: 100%; text-align: ${designState.stAlign}; display:flex; flex-direction:column; gap:${designState.stGap}px; } 

                .jalsa-text { direction: rtl; display:block; width:100%; }
                .main-title { font-size: ${designState.mtSize}em; color: ${designState.mtColor}; text-shadow: 2px 2px 10px black; margin-bottom: 20px; border-bottom: 3px solid ${designState.mtColor}; padding-bottom:10px; }
                .sub-title { font-size: ${designState.stSize}em; color: ${designState.stColor}; text-shadow: 1px 1px 5px black; margin: 0; line-height:1.2; }
                .sub-title:empty { display:none; }

                #mainLogosContainer { 
                    position:absolute; top:50%; left:50%; width:0; height:0; z-index:20; 
                    transition: opacity 0.5s ease;
                }
                .main-logo-img { position:absolute; transform:translate(-50%, -50%); object-fit:contain; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5)); transition: all 0.3s ease; }
                
                #plContainer { 
                    position:absolute; bottom:${designState.plY}px; width:100%; 
                    display:flex; justify-content:center; gap:${designState.plGap}px; z-index:25; padding:0 20px; flex-wrap:wrap; 
                    transition: opacity 0.1s linear; 
                    transform: translateX(${designState.plX}px);
                }
                .pl-img { height:${designState.plSize}px; object-fit:contain; filter:drop-shadow(0 2px 5px #000); transition:all 0.3s; }

                #card { 
                    position:absolute; top:54%; left:50%; transform:translate(-50%,-50%); 
                    width:${designState.cardW}vw; 
                    height:${designState.cardH}vh; 
                    max-width: ${designState.cardW > 90 ? 'none' : '1500px'};
                    display:flex; flex-direction:${designState.layoutDir === 'rtl' ? 'row-reverse' : 'row'}; 
                    align-items:center; 
                    /* Background removed to allow styles to show */
                    padding:3vh; box-sizing:border-box; 
                    opacity:0; transition:all 0.5s ease; z-index:5001; 
                }
                #card.active { opacity:1; }

                .b0 { border: none; background: transparent !important; box-shadow: none; }
                .custom { border: none !important; box-shadow: none !important; }

                .font-dv { font-family: 'Faruuma', 'MV Boli', 'Noto Sans Thaana', serif; }
                .font-en { font-family: 'Times New Roman', serif; direction:ltr; }
                h1 { font-size: 5em; margin:0; color:#fff; line-height:1.1; }
                h2 { font-size: 3em; margin:10px 0; color:var(--theme-color); text-transform:uppercase; border-bottom:2px solid var(--theme-color); display:inline-block; width:100%; text-align:inherit; }
                .fac-dv { font-size: 2em; color:#fff9c4; margin-top:10px; }
                .fac-en { font-size: 1.6em; color:#fff9c4; font-weight:bold; margin-bottom:5px; text-align:inherit; }
                .crs-dv { font-size: 2.5em; color:#fff9c4; font-weight:bold; }
                .crs-en { font-size: 2em; color:#fff9c4; font-style:italic; margin-bottom:20px; text-align:inherit; }
                .comm { background:rgba(212,175,55,0.15); border:2px solid var(--theme-color); padding:20px; font-size:2.2em; color:white; border-radius:10px; text-align:center; width:100%; box-sizing:border-box; transition: all 0.3s ease; }
                .comm-tiny { padding: 0 !important; height: 3px !important; min-height: 0 !important; overflow: hidden; border:none !important; background: var(--theme-color); opacity: 0.6; margin-top:20px; }

                .photo-col { position:relative; flex:0 0 auto; min-width: 200px; display:flex; justify-content:center; align-items:center; transform:translate(${designState.pX}px, ${designState.pY}px); transition: transform 0.2s ease; height: 100%; }
                .shrink-photo img { width: 8px !important; height: 8px !important; min-width: 0 !important; min-height: 0 !important; border-radius: 50% !important; border: none !important; box-shadow: 0 0 5px var(--theme-color) !important; background: var(--theme-color); padding: 0 !important; }
                
                #stuImg { 
                    width:${designState.pSize}px; 
                    height:${designState.pSize}px; 
                    object-fit:${designState.pFit}; 
                    background:#000; 
                    transition: all 0.3s ease;
                    border-width: ${designState.pfWidth}px;
                    border-style: ${designState.pfStyle};
                    border-color: ${designState.pfColor};
                    border-radius: ${designState.pfRadius}%;
                    box-shadow: ${designState.pfShadow};
                }

                /* ANIMATIONS */
                @keyframes royalSpin { 100% { transform: translate(var(--star-x), var(--star-y)) rotate(360deg); } }
                @keyframes royalPulse { 0% { transform: translate(var(--star-x), var(--star-y)) scale(1); } 50% { transform: translate(var(--star-x), var(--star-y)) scale(1.1); } 100% { transform: translate(var(--star-x), var(--star-y)) scale(1); } }
                @keyframes royalFloat { 0%, 100% { transform: translate(var(--star-x), var(--star-y)); } 50% { transform: translate(var(--star-x), calc(var(--star-y) - 10px)); } }
                
                @keyframes trophyPulse { 0% { transform: translate(var(--troph-x), var(--troph-y)) scale(1); } 50% { transform: translate(var(--troph-x), var(--troph-y)) scale(1.05); } 100% { transform: translate(var(--troph-x), var(--troph-y)) scale(1); } }
                @keyframes trophyShine { 0% { filter: brightness(1); transform: translate(var(--troph-x), var(--troph-y)); } 50% { filter: brightness(1.3); transform: translate(var(--troph-x), var(--troph-y)); } 100% { filter: brightness(1); transform: translate(var(--troph-x), var(--troph-y)); } }
                @keyframes trophyZoom { 0% { transform: translate(var(--troph-x), var(--troph-y)) scale(0); opacity:0; } 80% { transform: translate(var(--troph-x), var(--troph-y)) scale(1.1); opacity:1; } 100% { transform: translate(var(--troph-x), var(--troph-y)) scale(1); opacity:1; } }

                /* BADGES */
                .royal-star-badge {
                    position: absolute; top: 0; left: 0; width: 80px; z-index: 10;
                    display: none; 
                    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
                    transform: translate(var(--star-x), var(--star-y)); 
                }
                .royal-anim-spin { animation: royalSpin 5s linear infinite; }
                .royal-anim-pulse { animation: royalPulse 2s ease-in-out infinite; }
                .royal-anim-float { animation: royalFloat 3s ease-in-out infinite; }

                .trophy-badge {
                    position: absolute; bottom: 0; right: 0; z-index: 10;
                    display: none; 
                    align-items: center; background: linear-gradient(45deg, #FFD700, #ffb300);
                    border: 3px solid #fff; border-radius: 50px; padding: 5px 15px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
                    transform: translate(var(--troph-x), var(--troph-y)); 
                }
                .royal-anim-shine { animation: trophyShine 2s infinite; }
                .royal-anim-pulse { animation: trophyPulse 2s infinite; }
                .royal-anim-zoom { animation: trophyZoom 0.8s ease-out forwards; }

                .trophy-badge img { height: 40px; margin-right: 5px; }
                .rank-num { font-size: 30px; font-weight: 900; color: #3e2723; font-family: 'Times New Roman', serif; }

                .text-col { flex:1; text-align:${designState.textAlign}; padding:0 30px; color:white; display:flex; flex-direction:column; justify-content:center; }
                
                /* VIDEO & ADS LAYERS */
                #videoLayer { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:5500; display:none; justify-content:center; align-items:center; transition: all 0.5s ease; }
                #videoLayer video, #videoLayer iframe { width:100%; height:100%; border:none; }
                
                #adLayer { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:6000; display:none; justify-content:center; align-items:center; }
                #adImg, #adVid { width:100%; height:100%; object-fit:contain; position:absolute; top:0; left:0; }

                /* OVERLAY MODE FOR VIDEO */
                .overlay-mode #card { 
                    width:auto !important; height:auto !important; 
                    bottom:30px !important; top:auto !important; transform:translate(-50%, 0) !important;
                    background:rgba(0,0,0,0.8) !important; border-radius:15px; padding:15px 30px !important; 
                    border:1px solid #fff !important; 
                }
                .overlay-mode .photo-col { min-width:0 !important; margin-left:20px; }
                .overlay-mode #stuImg { width:120px !important; height:120px !important; }
                .overlay-mode h1 { font-size:2.5em !important; }
                .overlay-mode h2 { font-size:1.8em !important; }
                .overlay-mode .fac-dv, .overlay-mode .crs-dv, .overlay-mode .comm { display:none; }

                /* --- TOP 5 BANNER MODE (Royal Edition) --- */
                .top5-mode #titleContainer { display: none !important; }
                
                .top5-mode #videoLayer {
                    top: var(--tv-y); 
                    left: var(--tv-x);
                    width: var(--tv-w);
                    height: var(--tv-h); 
                    border: 4px solid var(--royal-accent);
                    box-shadow: 0 0 50px rgba(197, 160, 89, 0.6);
                    background: #000;
                    border-radius: 15px;
                    z-index: 5500;
                    position: absolute; 
                    overflow: hidden; 
                }

                .top5-mode #card {
                    max-width: none !important;
                    background: rgba(0,20,15,0.95);
                    border: none; 
                    box-shadow: 0 0 30px rgba(0,0,0,0.5);
                    z-index: 6000 !important;
                    transition: all 0.5s ease;
                }

                /* T5 BOTTOM LAYOUT */
                /* --- T5 FINAL FIX: Layout & Photo Force --- */
/* --- T5 STAR MODE & ALIGNMENT FIX --- */
/* --- T5 FINAL SUPER FIX: STAR VISIBILITY --- */
.top5-mode #card.t5-bottom {
    width: 95vw !important;
    height: 22vh !important;
    bottom: 40px !important;
    top: auto !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    
    /* Layout */
    flex-direction: row !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 0 !important;

    /* Design */
    background: linear-gradient(90deg, rgba(0,10,5,0.95) 0%, rgba(0,30,50,0.95) 100%);
    border: 3px solid var(--royal-accent);
    border-radius: 15px;
    box-shadow: 0 10px 50px rgba(0,0,0,0.9);
    padding: 0 40px !important;
    z-index: 6000 !important;
    overflow: visible !important; /* Allow Star to go outside */
}

/* 1. HIDE PHOTO, BUT KEEP CONTAINER ALIVE FOR STAR */
.top5-mode .photo-col {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    width: 0 !important;       /* No Width */
    height: 0 !important;      /* No Height */
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    overflow: visible !important; /* CRITICAL: Let Star show outside */
    transform: none !important;
    position: absolute !important; /* Take out of flow */
    top: 50% !important;
    left: 50% !important;
}

/* 2. COMPLETELY HIDE STUDENT IMAGE */
.top5-mode #stuImg { display: none !important; }

/* 3. FORCE SHOW STAR (ON TOP OF EVERYTHING) */
/* 3. FORCE SHOW STAR (UPDATED SIZE FIX) */
/* 3. FORCE SHOW STAR (ANIMATION FIXED) */
.top5-mode #royalStar {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: absolute !important;
    top: 0 !important; 
    left: 0 !important;
    
    /* Default Size */
    width: var(--star-s, 200px) !important;
    height: auto !important;
    min-width: 50px !important;
    
    /* Position */
    transform: translate(var(--star-x), var(--star-y)) !important;
    
    z-index: 9999 !important;
    
    /* ﬁÇﬁØﬁìﬁ∞: ﬁâﬁ®ﬁåﬁ¶ﬁÇﬁ™ﬁÇﬁ∞ ﬁáﬁ¨ﬁÇﬁ®ﬁâﬁ≠ﬁùﬁ¶ﬁÇﬁ∞ ﬁçﬁ¶ﬁáﬁ®ﬁÇﬁ∞ ﬁàﬁ¶ﬁÇﬁ© ﬁÇﬁ¶ﬁéﬁßﬁäﬁ¶ﬁáﬁ®. 
       ﬁâﬁ®ﬁÄﬁßﬁÉﬁ™ ﬁÜﬁÆﬁÇﬁ∞ﬁìﬁ∞ﬁÉﬁØﬁçﬁ∞ ﬁïﬁ¨ﬁÇﬁ¶ﬁçﬁ∞ﬁéﬁ¨ ﬁëﬁ∞ﬁÉﬁÆﬁïﬁ∞ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ ﬁâﬁ¶ﬁêﬁ¶ﬁáﬁ∞ﬁÜﬁ¶ﬁåﬁ∞ ﬁÜﬁ™ﬁÉﬁßﬁÇﬁ¨. */
}

/* 4. Text Styling & Alignment Control */
.top5-mode .text-col {
    width: 100% !important;
    text-align: var(--t5-align, center) !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: var(--t5-flex-align, center) !important;
    justify-content: center !important;
    padding: 0 !important;
    z-index: 6005 !important;
}

.top5-mode h1 { font-size: 3em !important; margin: 0 !important; line-height: 1.2 !important; }
.top5-mode h2 { font-size: 2em !important; color: #ffd54f !important; border: none !important; margin-top: 5px !important; }
.top5-mode .fac-dv, .top5-mode .crs-dv, .top5-mode .comm { display: none !important; }
                /* T5 LEFT SIDEBAR LAYOUT */
                .top5-mode #card.t5-left {
                    width: var(--t5-w) !important; height: 100vh !important;
                    top: 0 !important; left: 0 !important; bottom: auto !important;
                    transform: none !important;
                    flex-direction: column !important;
                    justify-content: center;
                    border-right: 4px solid var(--theme-color);
                }

                /* T5 RIGHT SIDEBAR LAYOUT */
                .top5-mode #card.t5-right {
                    width: var(--t5-w) !important; height: 100vh !important;
                    top: 0 !important; right: 0 !important; bottom: auto !important; left: auto !important;
                    transform: none !important;
                    flex-direction: column !important;
                    justify-content: center;
                    border-left: 4px solid var(--theme-color);
                }
                
                /* FIX: Text Y Position within Top 5 Card */
                .top5-mode .text-col {
                    text-align: center !important;
                    transform: translateY(var(--t5-text-y)) !important;
                }
                .top5-mode #card.t5-bottom .text-col { text-align: right !important; }

                .top5-mode .photo-col {
                    transform: none !important;
                    margin: 10px;
                }
                .top5-mode #stuImg {
                    width: var(--t5-p) !important; height: var(--t5-p) !important;
                    object-fit: cover !important; 
                }
                
                .top5-mode h1 { font-size: var(--t5-n-s) !important; }
                .top5-mode h2 { font-size: var(--t5-e-s) !important; margin: 5px 0 !important; }
                .top5-mode .fac-dv, .top5-mode .crs-dv { font-size: var(--t5-d-s) !important; }

                .copyright { position:absolute; bottom:10px; right:10px; font-size:10px; color:rgba(255,255,255,0.3); font-family:sans-serif; z-index:900; }
                #activateOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; font-family:sans-serif; text-align:center; cursor:pointer; }
                /* === 3-SCREEN SETUP (840px - 3360px - 840px) === */
.screen-zone {
    position: fixed; top: 0; height: 100%;
    /* 840px / 5040px = 16.666% */
    width: 16.666%; 
    background-size: cover; background-position: center;
    z-index: 6000; display: none;
    align-items: center; justify-content: center;
    background-color: #000;
}
#zoneLeft { left: 0; border-right: 2px solid rgba(255,255,255,0.2); }
#zoneRight { right: 0; border-left: 2px solid rgba(255,255,255,0.2); }

body.triple-active #zoneLeft, body.triple-active #zoneRight { display: flex; }

body.triple-active #card {
    left: 50% !important; transform: translate(-50%, -50%) !important;
    max-width: 60vw !important;
}
.zone-img { width: 100%; height: 100%; object-fit: fill; }
/* --- TOP 5 BANNER MODE (RESTORED) --- */

/* 1. Hide Main Titles in Top 5 */
.top5-mode #titleContainer { display: none !important; }

/* 2. Video Box Positioning */
.top5-mode #videoLayer {
    top: var(--tv-y); 
    left: var(--tv-x);
    width: var(--tv-w); 
    height: var(--tv-h); 
    border: 4px solid var(--royal-accent);
    box-shadow: 0 0 50px rgba(197, 160, 89, 0.6);
    background: #000;
    border-radius: 15px;
    z-index: 5500;
    position: absolute; 
    overflow: hidden; 
}

/* 3. Card Styling for Top 5 */
.top5-mode #card {
    max-width: none !important;
    background: rgba(0,20,15,0.95);
    border: none; 
    box-shadow: 0 0 30px rgba(0,0,0,0.5);
    z-index: 6000 !important;
    transition: all 0.5s ease;
}

/* 4. Layouts (Bottom/Left/Right) */
.top5-mode #card.t5-bottom {
    width: var(--t5-w) !important; height: var(--t5-h) !important;
    bottom: var(--t5-b) !important; top: auto !important;
    left: 50% !important; transform: translateX(-50%) !important;
    flex-direction: row-reverse !important;
    border-top: 4px solid var(--theme-color);
}

.top5-mode #card.t5-left {
    width: var(--t5-w) !important; height: 100vh !important;
    top: 0 !important; left: 0 !important; bottom: auto !important;
    transform: none !important;
    flex-direction: column !important;
    justify-content: center;
    border-right: 4px solid var(--theme-color);
}

.top5-mode #card.t5-right {
    width: var(--t5-w) !important; height: 100vh !important;
    top: 0 !important; right: 0 !important; bottom: auto !important; left: auto !important;
    transform: none !important;
    flex-direction: column !important;
    justify-content: center;
    border-left: 4px solid var(--theme-color);
}

/* 5. Text & Photo Fixing */
.top5-mode .text-col {
    text-align: center !important;
    transform: translateY(var(--t5-text-y)) !important;
}
.top5-mode #card.t5-bottom .text-col { text-align: right !important; }

.top5-mode .photo-col {
    transform: none !important;
    margin: 10px;
}
.top5-mode #stuImg {
    width: var(--t5-p) !important; height: var(--t5-p) !important;
    object-fit: cover !important; 
}

/* 6. Font Sizes */
.top5-mode h1 { font-size: var(--t5-n-s) !important; }
.top5-mode h2 { font-size: var(--t5-e-s) !important; margin: 5px 0 !important; }
.top5-mode .fac-dv, .top5-mode .crs-dv { font-size: var(--t5-d-s) !important; }
            </style>
            <script>function goFS(btn){document.documentElement.requestFullscreen(); btn.style.display='none';}<\/script>
        </head>
        <body>
    <div id="zoneLeft" class="screen-zone"></div>
    <div id="zoneRight" class="screen-zone"></div>

    <div id="activateOverlay" onclick="this.style.display='none'">
        <h1 style="font-size:50px;">CLICK HERE TO ACTIVATE SCREEN</h1>
        <p>This is required for Audio/Video to play automatically.</p>
    </div>

    <button id="fsBtn" onclick="goFS(this)">‚õ∂ FULL SCREEN</button>
    
    <div id="adLayer">
        <img id="adImg" style="display:none;">
        <video id="adVid" style="display:none;" muted autoplay></video>
    </div>
    
    <div id="videoLayer"></div>
    
    <div id="bgLayer" class="${designState.bgPreset}"></div>
    <div id="mainLogosContainer"></div>
    <div id="plContainer"></div>

    <div id="jalsaContent">
        <div id="titleContainer" style="margin-top:${designState.mtY}px;"> 
            <div id="mainTitleWrap"><div id="jt1" class="main-title jalsa-text"></div></div>
            <div id="subTitleWrap">
                <div id="jt2" class="sub-title jalsa-text"></div>
                <div id="jt3" class="sub-title jalsa-text"></div>
                <div id="jt4" class="sub-title jalsa-text"></div>
                <div id="jt5" class="sub-title jalsa-text"></div>
                <div id="jt6" class="sub-title jalsa-text"></div>
                <div id="jt7" class="sub-title jalsa-text"></div>
                <div id="jt8" class="sub-title jalsa-text"></div>
            </div>
        </div>
    </div>

    <div id="card" class="${designState.cBorder}">
        <div class="photo-col">
            <img id="stuImg" src="">
            <img id="royalStar" class="royal-star-badge" src="">
            <div id="trophyWrap" class="trophy-badge">
                <img id="trophyImg" src="">
                <span id="rankNum" class="rank-num"></span>
            </div>
        </div>
        <div class="text-col">
            <h1 id="tnD" class="font-dv"></h1><h2 id="tnE" class="font-en"></h2>
            <div id="tfD" class="fac-dv font-dv"></div><div id="tfE" class="fac-en font-en"></div>
            <div id="tcD" class="crs-dv font-dv"></div><div id="tcE" class="crs-en font-en"></div>
            <div id="tcm" class="comm font-dv"></div>
        </div>
    </div>
    <div class="copyright">¬© Ali Ibrahim Didi (7791550)</div>
</body>
        </html>`;

        tvWindow.document.write(html);
        tvWindow.document.close();

        renderMainLogos(); 
        updateJalsaBackground();
        updatePartnerLogos();
        
        // FIX: Force update title and layout after a short delay
        setTimeout(() => {
            updateJalsaText();
            for (const key in designState) { liveUpdate(key, designState[key]); }
        }, 500);

        document.getElementById('connStatus').innerText = "‚úÖ ONLINE";
        document.getElementById('connStatus').style.color = "#00e676";
        document.getElementById('connStatus').style.background = "rgba(0,0,0,0.8)";
    }

    // --- LOGIC ---
    function updateJalsaBackground() {
        if(!tvWindow || tvWindow.closed || !currentJalsaBgData) return;
        const bgDiv = tvWindow.document.getElementById('bgLayer');
        if(currentJalsaBgType === 'video') {
            bgDiv.innerHTML = `<video id="bgVid" src="${currentJalsaBgData}" autoplay loop muted style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; z-index:-1;"></video>`;
            setTimeout(() => { const v = tvWindow.document.getElementById('bgVid'); if(v) v.play().catch(e=>{}); }, 500);
        } else if (currentJalsaBgType === 'image') {
            bgDiv.innerHTML = `<img src="${currentJalsaBgData}" style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; z-index:-1;">`;
        }
    }

    function forceShowTitles() {
        if(!tvWindow || tvWindow.closed) return;
        updateJalsaText();
        tvWindow.document.getElementById('jalsaContent').classList.remove('hidden');
        tvWindow.document.getElementById('card').classList.remove('active');
        tvWindow.document.body.classList.remove('overlay-mode', 'top5-mode');
    }

    // --- NEW NAVIGATION FUNCTIONS ---
    function forceStudentCard() {
        switchListMode('general');
        updateTV();
    }

    function forceTop5() {
        switchListMode('top5');
        updateTV();
    }

    function updateJalsaText() {
        if(!tvWindow || tvWindow.closed) return;
        const doc = tvWindow.document;
        doc.getElementById('jt1').innerText = document.getElementById('jLine1').value;
        
        for(let i=2; i<=8; i++) {
             let txt = document.getElementById('jLine'+i).value;
             let el = doc.getElementById('jt'+i);
             el.innerText = txt;
             if(stStyles[i-1]) {
                 el.style.fontSize = stStyles[i-1].size + 'em';
                 el.style.color = stStyles[i-1].color;
             }
             if(designState.stLine === 'on') {
                 el.style.borderBottom = `2px solid ${stStyles[i-1].color}`;
                 el.style.display = 'inline-block';
             } else {
                 el.style.borderBottom = 'none';
                 el.style.display = 'block';
             }
        }
        
        if(currentFontData) {
             const style = doc.createElement('style');
             style.innerHTML = `@font-face { font-family: 'Faruuma'; src: url('${currentFontData}') format('truetype'); } .jalsa-text, .font-dv { font-family: 'Faruuma', 'Amiri', serif !important; }`;
             doc.head.appendChild(style);
        }
    }

    function showJalsaScreen() {
        if(!tvWindow || tvWindow.closed) return;
        tvWindow.document.getElementById('card').classList.remove('active');
        const jContent = tvWindow.document.getElementById('jalsaContent');
        jContent.classList.remove('hidden');
        jContent.style.opacity = '1'; 
        jContent.style.display = 'flex'; 
        
        const mainLogoContainer = tvWindow.document.getElementById('mainLogosContainer');
        if(designState.logoVisible) mainLogoContainer.style.opacity = '1';
        
        if(designState.plVisible) {
             tvWindow.document.getElementById('plContainer').style.opacity = '1';
        }
        
        document.getElementById('statusMsg').innerText = "MODE: Jalsa Titles";
        lastActiveState = 'title'; 
    }

    function updateTV() {
        if(!tvWindow || tvWindow.closed) { alert("TV Closed!"); return; }
        stopAds();
        
        if(!designState.keepTitle) {
            tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
        } else {
            tvWindow.document.getElementById('jalsaContent').classList.remove('hidden');
        }
        
        const mainLogoContainer = tvWindow.document.getElementById('mainLogosContainer');
        if(designState.logoAutoHide) mainLogoContainer.style.opacity = '0';
        
        const plContainer = tvWindow.document.getElementById('plContainer');
        if(designState.plAutoHide) plContainer.style.opacity = '0';

        const doc = tvWindow.document;
        doc.getElementById('tnD').textContent = document.getElementById('nD').value;
        doc.getElementById('tnE').textContent = document.getElementById('nE').value;
        doc.getElementById('tfD').textContent = document.getElementById('fD').value;
        doc.getElementById('tfE').textContent = document.getElementById('fE').value;
        doc.getElementById('tcD').textContent = document.getElementById('cD').value;
        doc.getElementById('tcE').textContent = document.getElementById('cE').value;
        
        const cmText = document.getElementById('cm').value;
        const commBox = doc.getElementById('tcm');
        if(!cmText || cmText.trim() === "") {
            commBox.textContent = "";
            commBox.classList.add('comm-tiny');
        } else {
            commBox.textContent = cmText;
            commBox.classList.remove('comm-tiny');
        }

        const img = doc.getElementById('stuImg');
        const pCol = doc.querySelector('.photo-col');
        
        if(currentPhotoData) { 
            img.src = currentPhotoData; 
            img.style.display='block'; 
            pCol.classList.remove('shrink-photo');
        } else { 
            img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; 
            pCol.classList.add('shrink-photo');
        }

        // Auto Toggle Top 5 Mode
        if(activeListMode === 'top5') {
            doc.body.classList.add('top5-mode');
            document.getElementById('top5ModeCheck').checked = true;
            doc.getElementById('card').classList.add('t5-' + designState.t5Layout);
            // SHOW ROYAL STAR
            if(royalStarData) {
                const rs = doc.getElementById('royalStar');
                rs.src = royalStarData;
                rs.style.display = 'block';
            }
        } else {
             if(!document.getElementById('top5ModeCheck').checked) {
                 doc.body.classList.remove('top5-mode');
                 doc.getElementById('royalStar').style.display = 'none';
             }
        }
        
        // SHOW TROPHY IF RANK EXISTS
        const rankTxt = document.getElementById('rankInput').value;
        const trophyWrap = doc.getElementById('trophyWrap');
        if(rankTxt && rankTxt.trim() !== "") {
            doc.getElementById('rankNum').innerText = rankTxt;
            if(trophyData) doc.getElementById('trophyImg').src = trophyData;
            trophyWrap.style.display = 'flex';
        } else {
            trophyWrap.style.display = 'none';
        }

        setTimeout(() => doc.getElementById('card').classList.add('active'), 100);
        stopVideo(); 
        document.getElementById('statusMsg').innerText = "LIVE: " + document.getElementById('nE').value;
        lastActiveState = 'card'; 
    }

    function clearTV() {
        if(!tvWindow || tvWindow.closed) return;
        stopAds();
        showJalsaScreen();
        stopVideo();
        document.getElementById('statusMsg').innerText = "CLEARED";
    }

    // --- NEW BADGE LOADERS ---
    function loadRoyalStar(input) {
        if(input.files && input.files[0]) {
            royalStarData = URL.createObjectURL(input.files[0]);
            alert("Royal Star Loaded!");
        }
    }
    
    function loadTrophy(input) {
        if(input.files && input.files[0]) {
            trophyData = URL.createObjectURL(input.files[0]);
            alert("Trophy Icon Loaded!");
        }
    }

    // --- VIDEO & ADS & PRESENTATION V29 ---
    
    function loadPartnerLogos(input) {
        partnerLogosData = [];
        for(let f of input.files) partnerLogosData.push(URL.createObjectURL(f));
        updatePartnerLogos();
        alert(partnerLogosData.length + " Partner Logos Loaded.");
    }
    
    function updatePartnerLogos() {
        if(!tvWindow || tvWindow.closed) return;
        const c = tvWindow.document.getElementById('plContainer');
        c.innerHTML = '';
        partnerLogosData.forEach(src => {
            let img = tvWindow.document.createElement('img');
            img.src = src; img.className = 'pl-img';
            img.style.height = designState.plSize + 'px';
            c.appendChild(img);
        });
        c.style.gap = designState.plGap + 'px';
    }
    
    function togglePartnerLogos() {
        designState.plVisible = !designState.plVisible;
        if(tvWindow && !tvWindow.closed) {
             const c = tvWindow.document.getElementById('plContainer');
             c.style.opacity = designState.plVisible ? '1' : '0';
        }
    }

    function loadAds(input) {
        adFiles = [];
        for(let f of input.files) {
             let type = f.type.startsWith('video') ? 'video' : 'image';
             adFiles.push({ file: f, type: type, url: URL.createObjectURL(f) });
        }
        alert(adFiles.length + " Ads (Photos/Videos) Loaded.");
    }
    
    function toggleAdsMode() {
        if(adInterval) stopAds(); else startAds();
    }
    
    function startAds() {
        if(!tvWindow || tvWindow.closed || adFiles.length === 0) { alert("No Ads Loaded or TV Closed!"); return; }
        const adLayer = tvWindow.document.getElementById('adLayer');
        const adImg = tvWindow.document.getElementById('adImg');
        const adVid = tvWindow.document.getElementById('adVid');
        
        adLayer.style.display = 'flex';
        adIndex = 0;
        
        function playAd() {
            if(!adInterval) return; 
            let currentAd = adFiles[adIndex];
            
            if(currentAd.type === 'image') {
                adVid.pause(); adVid.style.display = 'none';
                adImg.src = currentAd.url;
                adImg.style.display = 'block';
                setTimeout(() => { if(adInterval) { nextAdIndex(); playAd(); } }, 10000);
            } else {
                adImg.style.display = 'none';
                adVid.src = currentAd.url;
                adVid.style.display = 'block';
                adVid.currentTime = 0;
                adVid.muted = false; 
                adVid.play().catch(() => { adVid.muted=true; adVid.play(); });
                adVid.onended = () => { if(adInterval) { nextAdIndex(); playAd(); } };
            }
        }
        
        function nextAdIndex() {
            adIndex = (adIndex + 1) % adFiles.length;
        }

        adInterval = true; 
        playAd();
        document.getElementById('statusMsg').innerText = "ADS MODE ON";
    }
    
    function stopAds() {
        adInterval = false;
        if(tvWindow && !tvWindow.closed) {
             tvWindow.document.getElementById('adLayer').style.display = 'none';
             tvWindow.document.getElementById('adVid').pause();
        }
        if(document.getElementById('statusMsg').innerText === "ADS MODE ON") document.getElementById('statusMsg').innerText = "ADS STOPPED";
    }

    document.getElementById('videoPlaylist').onchange = e => {
        playlist = Array.from(e.target.files);
        currentVidIdx = 0;
        alert(playlist.length + " General Videos Queued.");
    };
    
    function loadTop5Videos(input) {
        top5VideoPlaylist = Array.from(input.files);
        currentVidIdx = 0;
        alert(top5VideoPlaylist.length + " Top 5 Videos Queued.");
    }

    // --- NEXT VIDEO FUNCTION (SMART SEARCH + AUTO TV UPDATE) ---
    function playNextVideo() {
        if(!tvWindow || tvWindow.closed) return;

        // 1. Select correct list
        let targetStudentList = activeListMode === 'top5' ? top5Students : students;
        let targetVideoFiles = activeListMode === 'top5' ? top5VideoPlaylist : playlist;

        // 2. Safety Checks
        if(targetStudentList.length === 0) { alert("Student List is empty!"); return; }
        if(targetVideoFiles.length === 0) { alert("No Videos Loaded!"); return; }
        
        // Reset index if needed
        if(currentVidIdx >= targetStudentList.length) currentVidIdx = 0;

        // 3. Get Student Data
        let studentData = targetStudentList[currentVidIdx];
        if(!studentData) return;

        // Prepare Search Terms (Dhivehi & English)
        let nameDhivehi = studentData.nD ? studentData.nD.trim() : "";
        let nameEnglish = studentData.nE ? studentData.nE.trim().toLowerCase() : "";
        
        // Clean names
        nameDhivehi = nameDhivehi.replace(/\s+/g, ' ');
        nameEnglish = nameEnglish.replace(/\s+/g, ' ');

        console.log("Searching Next: " + nameDhivehi + " OR " + nameEnglish);

        // 4. FIND VIDEO
        let foundVideo = targetVideoFiles.find(file => {
            let fileName = decodeURIComponent(file.name);
            let fileNameLower = fileName.toLowerCase().replace(/\s+/g, ' ');
            
            let matchDhivehi = (nameDhivehi.length > 0) && fileName.includes(nameDhivehi);
            let matchEnglish = (nameEnglish.length > 0) && fileNameLower.includes(nameEnglish);
            
            return matchDhivehi || matchEnglish;
        });

        if(foundVideo) {
            // Play Video
            playLocalVideoFile(foundVideo);
            
            // Highlight Student & Load Data
            let listElement = document.getElementById('stuList');
            if(listElement.options.length > currentVidIdx) {
                listElement.selectedIndex = currentVidIdx;
                loadStudent(); 

                // --- FORCE UPDATE TEXT ON TV ---
                if(tvWindow && !tvWindow.closed) {
                    let doc = tvWindow.document;
                    doc.getElementById('tnD').textContent = studentData.nD || "";
                    doc.getElementById('tnE').textContent = studentData.nE || "";
                    doc.getElementById('tfD').textContent = studentData.fD || "";
                    doc.getElementById('tfE').textContent = studentData.fE || "";
                    doc.getElementById('tcD').textContent = studentData.cD || "";
                    doc.getElementById('tcE').textContent = studentData.cE || "";
                    
                    if(studentData.rank) {
                        doc.getElementById('rankNum').innerText = studentData.rank;
                        doc.getElementById('trophyWrap').style.display = 'flex';
                    } else {
                        doc.getElementById('trophyWrap').style.display = 'none';
                    }
                }
                // -------------------------------
            }

            document.getElementById('statusMsg').innerText = "PLAYING: " + studentData.nD;
            
            // Move index forward for the next click
            currentVidIdx++; 
        } else {
            alert("‚ö†Ô∏è ﬁàﬁ©ﬁëﬁ®ﬁáﬁØﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁäﬁ¨ﬁÇﬁ™ﬁÇﬁ™!\n\nﬁãﬁ¶ﬁÉﬁ®ﬁàﬁ¶ﬁÉﬁ™: " + studentData.nD);
        }
    }

    function toggleOverlayMode(enabled) {
         if(!tvWindow || tvWindow.closed) return;
         if(enabled) {
            tvWindow.document.body.classList.add('overlay-mode');
            if(lastActiveState === 'card') tvWindow.document.getElementById('card').classList.add('active'); 
         } else {
            tvWindow.document.body.classList.remove('overlay-mode');
         }
    }

    function playLocalVideoFile(file) {
        if(document.getElementById('top5ModeCheck').checked) {
            updateTV(); 
            tvWindow.document.body.classList.add('top5-mode');
             tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
        } else {
             tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
            if(document.getElementById('vidOverlayCheck').checked) {
                tvWindow.document.body.classList.add('overlay-mode');
                tvWindow.document.getElementById('card').classList.add('active'); 
            } else {
                tvWindow.document.body.classList.remove('overlay-mode');
                tvWindow.document.getElementById('card').classList.remove('active');
            }
        }

        const url = URL.createObjectURL(file);
        const vl = tvWindow.document.getElementById('videoLayer');
        vl.innerHTML = `<video id="mainVid" src="${url}" autoplay controls style="width:100%;height:100%; object-fit:contain;"></video>`;
        vl.style.display = 'flex';
        setTimeout(() => { const v = tvWindow.document.getElementById('mainVid'); if(v) v.play().catch(e => {}); }, 100);
        document.getElementById('statusMsg').innerText = "PLAYING VIDEO";
    }
    
    function stopVideo() {
        if(!tvWindow || tvWindow.closed) return;
        const vl = tvWindow.document.getElementById('videoLayer');
        vl.innerHTML = ''; vl.style.display = 'none';
        tvWindow.document.body.classList.remove('overlay-mode');
        if(!document.getElementById('top5ModeCheck').checked) tvWindow.document.body.classList.remove('top5-mode');
        
        if(lastActiveState === 'title') {
            showJalsaScreen();
        } else if (lastActiveState === 'card') {
            tvWindow.document.getElementById('card').classList.add('active');
            if(designState.keepTitle) {
                tvWindow.document.getElementById('jalsaContent').classList.remove('hidden');
            } else {
                 tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
            }
        }
    }
    
   // --- SMART LINK CONVERTER (FIXED FOR YOUTUBE & OTHERS) ---
    function getSmartLink(url, type) {
        if (!url) return "";

        // 1. YouTube Handling (Shorts & Standard)
        if (url.includes('youtube.com') || url.includes('youtu.be')) {
            let videoId = null;

            // Handle Shorts
            if (url.includes('/shorts/')) {
                const parts = url.split('/shorts/');
                if (parts[1]) videoId = parts[1].split('?')[0]; // Remove query params
            } 
            // Handle Standard & Embed
            else {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const match = url.match(regExp);
                if (match && match[2] && match[2].length == 11) {
                    videoId = match[2];
                }
            }

            if (videoId) {
                // Use standard youtube.com/embed with autoplay
                return `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1&rel=0&modestbranding=1`;
            }
        }
        
        // 2. Canva Handling
        if (type === 'canva' || (type === 'auto' && url.includes('canva.com'))) {
             let cleanUrl = url.split('?')[0];
             if(cleanUrl.endsWith('/')) cleanUrl = cleanUrl.slice(0, -1);
             if(cleanUrl.includes('/view')) {
                 if(!cleanUrl.includes('?embed')) return cleanUrl + '?embed';
             } else if(cleanUrl.includes('/edit')) {
                 return cleanUrl.replace('/edit', '/view?embed');
             } else {
                 return cleanUrl + '/view?embed';
             }
        }

        // 3. Gamma Handling
        if (type === 'gamma' || (type === 'auto' && url.includes('gamma.app'))) {
             return url; 
        }

        return url;
    }

    function showPresentation() {
        if(!tvWindow || tvWindow.closed) return;
        let url = document.getElementById('presLink').value;
        const type = document.getElementById('presType').value;
        if(!url) return;
        
        if(url.includes("<iframe")) {
            const match = url.match(/src="([^"]+)"/);
            if(match && match[1]) url = match[1];
        }

        const finalUrl = getSmartLink(url, type);

        const vl = tvWindow.document.getElementById('videoLayer');
        vl.innerHTML = `<iframe src="${finalUrl}" allow="fullscreen; autoplay; encrypted-media; clipboard-write" style="width:100%; height:100%; border:none;"></iframe>`;
        vl.style.display = 'flex';
        tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
        tvWindow.document.getElementById('card').classList.remove('active');
    }
    
    function loadPDF(input) {
        if(input.files && input.files[0]) {
            pdfUrl = URL.createObjectURL(input.files[0]);
            alert("PDF Loaded. Click 'Show PDF' to display.");
        }
    }
    
    function showPDFScreen() {
        if(!tvWindow || tvWindow.closed) return;
        if(!pdfUrl) { alert("No PDF Loaded!"); return; }
        
        const vl = tvWindow.document.getElementById('videoLayer');
        vl.innerHTML = `<iframe src="${pdfUrl}" style="width:100%; height:100%; border:none;"></iframe>`;
        vl.style.display = 'flex';
        tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
        tvWindow.document.getElementById('card').classList.remove('active');
    }
    
    function playYoutube() {
        if(!tvWindow || tvWindow.closed) return;
        
        // Reset Views
        tvWindow.document.getElementById('jalsaContent').classList.add('hidden');
        tvWindow.document.getElementById('card').classList.remove('active');

        let url = document.getElementById('ytLink').value;
        if(!url) return;
        
        const embedUrl = getSmartLink(url, 'auto');
        
        if(!embedUrl) { alert("Invalid YT Link"); return; }
        
        const vl = tvWindow.document.getElementById('videoLayer');
        // Added 'web-share' and 'referrerpolicy' for better compatibility
        vl.innerHTML = `<iframe id="ytFrame" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen style="width:100%;height:100%;"></iframe>`;
        vl.style.display = 'flex';
        
        document.getElementById('statusMsg').innerText = "PLAYING YOUTUBE";
    }
    
    function openYTPopup() {
        const url = document.getElementById('ytLink').value;
        if(url) window.open(url, '_blank', 'width=1280,height=720');
    }
    // --- FILE HANDLERS ---
    document.getElementById('jalsaCsvFile').onchange = e => {
        const file = e.target.files[0]; if(!file) return;
        const r = new FileReader();
        r.onload = evt => {
            const lines = evt.target.result.split('\n');
            if(lines.length > 0) {
                const cols = lines[0].split(',');
                if(cols[0]) document.getElementById('jLine1').value = cols[0].trim();
                for(let i=1; i<8; i++) {
                    if(cols[i]) document.getElementById('jLine'+(i+1)).value = cols[i].trim();
                }
                updateJalsaText(); alert("Titles Loaded!");
            }
        }; r.readAsText(file);
    };

    // --- FORCE FONT LOADER (FIXED) ---
    document.getElementById('fontFile').onchange = e => {
        const file = e.target.files[0]; 
        if(!file) return;
        
        const r = new FileReader();
        r.onload = evt => {
            currentFontData = evt.target.result; // Save Data URL
            
            // 1. Editor Font Update
            const newFont = new FontFace('Faruuma', `url(${currentFontData})`);
            newFont.load().then(f => {
                document.fonts.add(f);
                document.body.style.fontFamily = "'Faruuma', serif";
            });

            // 2. TV Window Font Update (Force Inject)
            if(tvWindow && !tvWindow.closed) {
                const doc = tvWindow.document;
                
                // Remove old font style if exists
                const oldStyle = doc.getElementById('customFontStyle');
                if(oldStyle) oldStyle.remove();

                // Inject NEW Font Face
                const style = doc.createElement('style');
                style.id = 'customFontStyle';
                style.innerHTML = `
                    @font-face { 
                        font-family: 'Faruuma'; 
                        src: url('${currentFontData}') format('truetype'); 
                    }
                    /* Force Apply to EVERYTHING */
                    body, h1, h2, h3, div, span, input, textarea, .jalsa-text, .font-dv { 
                        font-family: 'Faruuma', 'MV Boli', serif !important; 
                    }
                `;
                doc.head.appendChild(style);
                
                // Force Redraw
                updateJalsaText();
            }
            
            alert("Custom Font Loaded & Applied!");
        }; 
        r.readAsDataURL(file);
    };

    document.getElementById('jalsaBgFile').onchange = e => {
        const file = e.target.files[0]; if(!file) return;
        const r = new FileReader();
        r.onload = evt => {
            currentJalsaBgData = evt.target.result;
            currentJalsaBgType = file.type.startsWith('video') ? 'video' : 'image';
            updateJalsaBackground(); alert("Background Set");
        }; r.readAsDataURL(file);
    };

    document.getElementById('customBorderFile').onchange = e => {
        const r = new FileReader();
        r.onload = evt => {
            customBorderData = evt.target.result;
            if(designState.cBorder === 'custom') liveUpdate('cBorder', 'custom');
            alert("Custom Frame Loaded!");
        }; r.readAsDataURL(e.target.files[0]);
    };
    
    function loadCustomCardBg(input) {
        const r = new FileReader();
        r.onload = evt => {
            customCardBgData = evt.target.result;
            liveUpdate('cBorder', 'custom_bg');
            document.getElementById('cBorderSel').value = 'custom_bg';
            alert("Custom Card Background Loaded!");
        }; r.readAsDataURL(input.files[0]);
    }

    // UPDATED CSV PARSER FOR RANK
    function parseCSV(text) {
        let lines = text.split('\n');
        let data = [];
        lines.forEach(l => {
            let c = l.split(',');
            if(c.length>1) {
                data.push({
                    nD: c[0]?.trim(), nE: c[1]?.trim(), cD: c[2]?.trim(), cE: c[3]?.trim(), 
                    fD: c[4]?.trim(), fE: c[5]?.trim(), cm: c[6]?.trim(), ph: c[7]?.trim(),
                    rank: c[8]?.trim() // New Column for Rank
                });
            }
        });
        return data;
    }

    document.getElementById('csvFile').onchange = e => {
        const r = new FileReader();
        r.onload = ev => {
            let txt = ev.target.result; if(txt.charCodeAt(0)===0xFEFF) txt=txt.substr(1);
            students = parseCSV(txt);
            if(activeListMode === 'general') filterList(); 
            alert("General List Loaded: " + students.length);
        }; r.readAsText(e.target.files[0]);
    };

    document.getElementById('photoFolder').onchange = e => {
        photoFiles = {};
        for(let f of e.target.files) {
            let name = f.name.toLowerCase();
            photoFiles[name] = f; 
            let nameNoExt = name.split('.').slice(0, -1).join('.');
            if(nameNoExt) photoFiles[nameNoExt] = f; 
        }
        alert("General Photos: " + e.target.files.length);
    };

    function loadTop5Csv(input) {
        const r = new FileReader();
        r.onload = ev => {
            let txt = ev.target.result; if(txt.charCodeAt(0)===0xFEFF) txt=txt.substr(1);
            top5Students = parseCSV(txt);
            if(activeListMode === 'top5') filterList();
            alert("Top 5 List Loaded: " + top5Students.length);
        }; r.readAsText(input.files[0]);
    }

    function loadTop5Photos(input) {
        top5PhotoFiles = {};
        for(let f of input.files) {
            let name = f.name.toLowerCase();
            top5PhotoFiles[name] = f; 
            let nameNoExt = name.split('.').slice(0, -1).join('.');
            if(nameNoExt) top5PhotoFiles[nameNoExt] = f; 
        }
        alert("Top 5 Photos: " + input.files.length);
    }

    function switchListMode(mode) {
        activeListMode = mode;
        document.getElementById('btnGenList').className = mode === 'general' ? 'list-switch-btn active' : 'list-switch-btn';
        document.getElementById('btnTop5List').className = mode === 'top5' ? 'list-switch-btn active' : 'list-switch-btn';
        
        if(mode === 'top5') {
            document.getElementById('top5ModeCheck').checked = true;
        } else {
             document.getElementById('top5ModeCheck').checked = false;
        }
        
        filterList();
        currentVidIdx = 0;
    }

    function processPhoto(file, cb) {
        const reader = new FileReader();
        reader.onload = e => { cb(e.target.result); };
        reader.readAsDataURL(file);
    }
    
    function manualPhoto(input) {
    if (input.files && input.files[0]) {
        // 1. ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁäﬁÆﬁìﬁØﬁáﬁ¨ﬁáﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ÿå ﬁáﬁ¨ ﬁäﬁÆﬁìﬁØ ﬁâﬁ¨ﬁâﬁÆﬁÉﬁ©ﬁÇﬁ∞ ﬁäﬁÆﬁÄﬁ¨ﬁçﬁß (Free up RAM)
        if (currentPhotoData && currentPhotoData.startsWith('blob:')) {
            URL.revokeObjectURL(currentPhotoData);
        }

        // 2. ﬁãﬁ¨ﬁÇﬁ∞ ﬁáﬁß ﬁäﬁÆﬁìﬁØ ﬁïﬁ∞ﬁÉﬁÆﬁêﬁ¨ﬁêﬁ∞ ﬁÜﬁ™ﬁÉﬁ≠
        processPhoto(input.files[0], d => {
            currentPhotoData = d;
            document.getElementById('previewImg').src = d;
            document.getElementById('pStat').innerText = "Manual";
            document.getElementById('pStat').style.color = "blue";
        });
    }
}

    function filterList() {
        let t = document.getElementById('search').value.toLowerCase();
        let l = document.getElementById('stuList'); l.innerHTML = '';
        
        let targetArray = activeListMode === 'top5' ? top5Students : students;
        
        targetArray.forEach((s,i) => {
            if((s.nD+s.nE).toLowerCase().includes(t)) {
                let prefix = activeListMode === 'top5' ? "üèÜ " : (i+1)+". ";
                let o = document.createElement('option'); o.value=i; o.text=prefix+s.nD; l.add(o);
            }
        });
    }

   function loadStudent() {
    let idx = document.getElementById('stuList').value;
    
    // Check which list and photo set to use
    let targetArray = activeListMode === 'top5' ? top5Students : students;
    
    // ================== ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ ﬁéﬁ¨ﬁÇﬁ∞ﬁÇﬁ¶ﬁÇﬁ∞ﬁàﬁ© ﬁÑﬁ¶ﬁáﬁ® ==================
    let targetPhotos;
    if (activeListMode === 'top5') {
        // Top 5 ﬁäﬁØﬁçﬁ∞ﬁëﬁß ﬁÄﬁ™ﬁêﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ General folder ﬁáﬁ®ﬁÇﬁ∞ ﬁäﬁÆﬁìﬁØ ﬁÇﬁ¶ﬁéﬁßﬁÇﬁ¨
        targetPhotos = (Object.keys(top5PhotoFiles).length > 0) ? top5PhotoFiles : photoFiles;
    } else {
        targetPhotos = photoFiles;
    }
    // =========================================================
    
    if(!targetArray[idx]) return;

    let s = targetArray[idx];
    // Populate text fields
    document.getElementById('nD').value = s.nD || ""; 
    document.getElementById('nE').value = s.nE || "";
    document.getElementById('fD').value = s.fD || ""; 
    document.getElementById('fE').value = s.fE || "";
    document.getElementById('cD').value = s.cD || ""; 
    document.getElementById('cE').value = s.cE || "";
    document.getElementById('cm').value = s.cm || "";
    document.getElementById('rankInput').value = s.rank || "";
        
        // --- IMPROVED PHOTO FINDER ---
        let pNameRaw = s.ph ? s.ph.trim() : ""; // Name from CSV
        let pName = pNameRaw.toLowerCase(); // Lowercase version
        let pNameNoExt = pName.split('.').slice(0, -1).join('.'); // Remove .jpg if present

        let prev = document.getElementById('previewImg');
        let stat = document.getElementById('pStat');
        
        // Try matching in 3 ways: Exact, Lowercase, or No Extension
        let foundFile = targetPhotos[pNameRaw] || targetPhotos[pName] || targetPhotos[pNameNoExt];
        
        if(foundFile) {
            stat.innerText = "Loading...";
            processPhoto(foundFile, d => {
                currentPhotoData = d; 
                prev.src = d; 
                stat.innerText = "‚úÖ Found"; 
                stat.style.color="green";
                
                // --- FIX: REMOVED AUTO TV UPDATE CODE FROM HERE ---
                // The lines that forced the photo to TV immediately have been removed.
                // Now photo only goes to TV when you click 'Live'.
            });
        } else {
            currentPhotoData = null; 
            prev.src = "https://via.placeholder.com/150"; 
            
            // Show error in the preview box
            if(pNameRaw === "") {
                stat.innerText = "No Photo Name"; 
                stat.style.color="grey";
            } else {
                stat.innerText = "‚ùå Missing: " + pNameRaw; 
                stat.style.color="red";
            }
        }
    }
    function move(d) {
        let l = document.getElementById('stuList');
        if(l.options.length) {
            let newIdx = Math.min(Math.max(l.selectedIndex+d, 0), l.options.length-1);
            l.selectedIndex = newIdx;
            loadStudent();
        }
    }
    // --- PREVIOUS VIDEO FUNCTION (BACK BUTTON) ---
    function playPrevVideo() {
        if(!tvWindow || tvWindow.closed) return;

        // 1. Select correct list
        let targetStudentList = activeListMode === 'top5' ? top5Students : students;
        let targetVideoFiles = activeListMode === 'top5' ? top5VideoPlaylist : playlist;

        // 2. Safety Checks
        if(currentVidIdx <= 0) { alert("ﬁâﬁ®ﬁáﬁ© ﬁäﬁ™ﬁÉﬁ¶ﬁåﬁ¶ﬁâﬁ¶ ﬁàﬁ©ﬁëﬁ®ﬁáﬁØ! ﬁäﬁ¶ﬁÄﬁ¶ﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁÇﬁ™ﬁãﬁ¨ﬁàﬁ≠ﬁÇﬁ¨."); return; }
        
        // 3. Move Index Backwards
        currentVidIdx--; 

        // 4. Get Student Data for the PREVIOUS student
        let studentData = targetStudentList[currentVidIdx];
        if(!studentData) return;

        // Prepare Search Terms
        let nameDhivehi = studentData.nD ? studentData.nD.trim() : "";
        let nameEnglish = studentData.nE ? studentData.nE.trim().toLowerCase() : "";
        
        // Clean names
        nameDhivehi = nameDhivehi.replace(/\s+/g, ' ');
        nameEnglish = nameEnglish.replace(/\s+/g, ' ');

        console.log("Going Back: Searching for " + nameDhivehi);

        // 5. FIND VIDEO
        let foundVideo = targetVideoFiles.find(file => {
            let fileName = decodeURIComponent(file.name);
            let fileNameLower = fileName.toLowerCase().replace(/\s+/g, ' ');
            
            let matchDhivehi = (nameDhivehi.length > 0) && fileName.includes(nameDhivehi);
            let matchEnglish = (nameEnglish.length > 0) && fileNameLower.includes(nameEnglish);
            
            return matchDhivehi || matchEnglish;
        });

        if(foundVideo) {
            // Play Previous Video
            playLocalVideoFile(foundVideo);
            
            // Highlight Student in List
            let listElement = document.getElementById('stuList');
            if(listElement.options.length > currentVidIdx) {
                listElement.selectedIndex = currentVidIdx;
                loadStudent(); 
            }
            document.getElementById('statusMsg').innerText = "BACK TO: " + studentData.nD;
        } else {
            alert("‚ö†Ô∏è ﬁàﬁ©ﬁëﬁ®ﬁáﬁØﬁáﬁ¨ﬁáﬁ∞ ﬁÇﬁ™ﬁäﬁ¨ﬁÇﬁ™ﬁÇﬁ™ (Back to): " + studentData.nD);
        }
    }

    // --- NEW FUNCTIONS (ZOOM & SCREEN CONTROL) ---

    // 1. ﬁìﬁ©ﬁàﬁ© ﬁàﬁ®ﬁÇﬁ∞ﬁëﬁØ ﬁíﬁ´ﬁâﬁ∞ ﬁÜﬁ™ﬁÉﬁß ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞
    function setTVZoom(val) {
        if(tvWindow && !tvWindow.closed) {
            tvWindow.document.body.style.zoom = val;
        }
    }

    // 2. ﬁáﬁ¶ﬁÉﬁ®ﬁâﬁ¶ﬁåﬁ© ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ﬁåﬁ¶ﬁÜﬁ¶ﬁÅﬁ∞ ﬁäﬁÆﬁìﬁØ ﬁçﬁß ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞
    function loadScreenBG(side, input) {
        if(!tvWindow || tvWindow.closed) return;
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const zoneId = (side === 'left') ? 'zoneLeft' : 'zoneRight';
                const zoneDiv = tvWindow.document.getElementById(zoneId);
                if(zoneDiv) {
                    zoneDiv.style.backgroundImage = `url(${e.target.result})`;
                    zoneDiv.style.backgroundSize = "cover";
                    document.getElementById('statusMsg').innerText = side.toUpperCase() + " SCREEN UPDATED";
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 3. ﬁåﬁ®ﬁÇﬁ∞ ﬁêﬁ∞ﬁÜﬁ∞ﬁÉﬁ©ﬁÇﬁ∞ ﬁâﬁØﬁëﬁ™ ﬁñﬁ¶ﬁáﬁ∞ﬁêﬁß ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞
   // ... (ﬁâﬁ¶ﬁåﬁ©ﬁéﬁ¶ﬁáﬁ®ÿå ﬁÜﬁ™ﬁÉﬁ®ﬁÇﬁ∞ ﬁáﬁ®ﬁåﬁ™ﬁÉﬁ™ﬁÜﬁ™ﬁÉﬁ® toggleTripleMode ﬁäﬁ¶ﬁÇﬁ∞ﬁÜﬁ∞ﬁùﬁ¶ﬁÇﬁ∞ ﬁáﬁ®ﬁÇﬁ∞ﬁÇﬁßﬁÇﬁ¨) ...

    function toggleTripleMode() {
        if(!tvWindow || tvWindow.closed) return;
        tvWindow.document.body.classList.toggle('triple-active');
    }

    function adjustZone(side, prop, val) {
        if(!tvWindow || tvWindow.closed) return;
        
        const zoneId = (side === 'left') ? 'zoneLeft' : 'zoneRight';
        const el = tvWindow.document.getElementById(zoneId);
        
        if(el) {
            if(prop === 'width') {
                // ﬁäﬁ™ﬁÖﬁßﬁâﬁ®ﬁÇﬁ∞ ﬁÑﬁ¶ﬁãﬁ¶ﬁçﬁ™ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ (%)
                el.style.width = val + "%"; 
            } else {
                // ﬁãﬁ¨ﬁäﬁ¶ﬁÉﬁßﬁåﬁ¶ﬁÅﬁ∞ ﬁñﬁ¨ﬁáﬁ∞ﬁêﬁ™ﬁÇﬁ∞ (Pixels)
                el.style[side] = val + "px"; 
            }
        }
    }
// --- DISABLE KEYBOARD SHORTCUTS & INSPECT ---
    document.addEventListener('keydown', function(e) {
        // 1. F12 (Developer Tools)
        if(e.key === 'F12' || e.keyCode === 123) {
            e.preventDefault();
            return false;
        }

        // 2. Ctrl + U (View Source Code)
        if(e.ctrlKey && (e.key === 'u' || e.key === 'U' || e.keyCode === 85)) {
            e.preventDefault();
            return false;
        }

        // 3. Ctrl + Shift + I (Inspect Element)
        if(e.ctrlKey && e.shiftKey && (e.key === 'i' || e.key === 'I' || e.keyCode === 73)) {
            e.preventDefault();
            return false;
        }

        // 4. Ctrl + Shift + J (Console)
        if(e.ctrlKey && e.shiftKey && (e.key === 'j' || e.key === 'J' || e.keyCode === 74)) {
            e.preventDefault();
            return false;
        }

        // 5. Ctrl + S (Save Page - ﬁâﬁ®ﬁáﬁ®ﬁÇﬁ∞ ﬁëﬁ¶ﬁáﬁ™ﬁÇﬁ∞ﬁçﬁØﬁëﬁ∞ ﬁÜﬁ™ﬁÉﬁ™ﬁÇﬁ∞ ﬁÄﬁ™ﬁáﬁ∞ﬁìﬁ™ﬁàﬁ≠ﬁÇﬁ¨)
        if(e.ctrlKey && (e.key === 's' || e.key === 'S' || e.keyCode === 83)) {
            e.preventDefault();
            // alert("Saving is disabled!"); // ﬁÑﬁ≠ﬁÇﬁ™ﬁÇﬁ∞ﬁÇﬁ¶ﬁâﬁ¶ ﬁâﬁ¨ﬁêﬁ¨ﬁñﬁ¨ﬁáﬁ∞ ﬁáﬁ¶ﬁÉﬁ™ﬁàﬁ¶ﬁÇﬁ∞ ﬁâﬁ®ﬁåﬁ¶ﬁÇﬁ∞ ﬁáﬁ¶ﬁÇﬁ∞-ﬁÜﬁÆﬁâﬁ¨ﬁÇﬁ∞ﬁìﬁ∞ ﬁÜﬁ™ﬁÉﬁ¶ﬁáﬁ∞ﬁàﬁß
            return false;
        }
    });
   // --- GENERAL VIDEO PLAYLIST PLAYER ---
    let generalPlayIndex = 0;

    function playGeneralSequence() {
        // 1. Check if TV is open
        if(!tvWindow || tvWindow.closed) { 
            alert("Please Open TV Screen First!"); 
            return; 
        }

        // 2. Check if files are loaded
        if(playlist.length === 0) { 
            alert("Please select video files in 'General Video Playlist' first!"); 
            return; 
        }

        // 3. Reset index if at end
        if(generalPlayIndex >= playlist.length) {
            generalPlayIndex = 0;
        }

        // 4. Play the video
        let file = playlist[generalPlayIndex];
        playLocalVideoFile(file);

        // 5. Update Status & Increment
        document.getElementById('statusMsg').innerText = "Playing General: " + file.name;
        generalPlayIndex++;
    }

    // --- FINAL SYSTEM CHECKS ---

    // 1. Prevent Accidental Refresh (Data Loss Protection)
    window.onbeforeunload = function(e) {
        e = e || window.event;
        // For older browsers
        if (e) { e.returnValue = 'Sure?'; }
        return 'Sure?';
    };

    // 2. Clear Console clutter to improve performance slightly
    console.log = function() {}; 

    // 3. Safety Check for TV Window
    setInterval(function(){
        if(tvWindow && tvWindow.closed) {
            document.getElementById('connStatus').innerText = "‚ùå TV CLOSED";
            document.getElementById('connStatus').style.background = "#ffebee";
            document.getElementById('connStatus').style.color = "red";
        }
    }, 2000);

</script>
</body>
</html>
